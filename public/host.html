<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - × ×™×”×•×œ ××©×—×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root { font-size: 16px; }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #FFF8EA;
      color: #2B1E4A;
      min-height: 100vh;
      font-size: 1rem;
      position: relative;
    }
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 280px;
      height: 280px;
      border-radius: 50%;
      z-index: -1;
    }
    body::before {
      top: -130px;
      left: -70px;
      background: radial-gradient(circle at center,
        rgba(248, 71, 121, 0.30),
        transparent 60%);
    }
    body::after {
      bottom: -150px;
      right: -50px;
      background: radial-gradient(circle at center,
        rgba(21, 196, 193, 0.28),
        transparent 60%);
    }

    .app {
      max-width: 1024px;
      width: 100%;
      padding: 20px 14px 40px;
      margin: 0 auto;
    }
    .card {
      background: #FFFFFF;
      border-radius: 26px;
      padding: 18px 16px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(43, 30, 74, 0.06);
      margin-bottom: 16px;
    }

    h1, h2, h3 { margin-top: 0; }

    label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.87rem;
      color: #6B618F;
    }

    input, select {
      width: 100%;
      padding: 9px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43, 30, 74, 0.22);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 0.98rem;
    }
    input::placeholder, select::placeholder { color: #B0A6CC; }
    input:focus, select:focus {
      outline: none;
      border-color: #F84779;
      box-shadow: 0 0 0 1px rgba(248, 71, 121, 0.55);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row > div { flex: 1 1 200px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #F84779, #F7C948);
      color: #2B1E4A;
      box-shadow: 0 10px 25px rgba(248, 71, 121, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(248, 71, 121, 0.5);
    }
    .btn-success {
      background: linear-gradient(135deg, #15C4C1, #2DD4BF);
      color: #083344;
      box-shadow: 0 10px 24px rgba(21, 196, 193, 0.35);
    }
    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(21, 196, 193, 0.5);
    }
    .btn-danger {
      background: linear-gradient(135deg, #EF4444, #F97373);
      color: #FFF7F7;
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(239, 68, 68, 0.5);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(107, 97, 143, 0.55);
      color: #6B618F;
    }
    .btn-ghost:hover { background: rgba(248, 249, 255, 0.9); }
    .btn-small { padding: 6px 10px; font-size: 0.8rem; }
    .btn-wide { width: 100%; justify-content: center; }
    .btn[disabled] {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(180, 169, 214, 0.7);
      font-size: 0.8rem;
      color: #58457F;
      gap: 6px;
      background: radial-gradient(circle at top left,
        rgba(248, 71, 121, 0.18),
        rgba(255, 255, 255, 0.96));
      margin-bottom: 4px;
    }
    .status-text { font-size: 0.9rem; color: #7C7598; }

    .logo-small {
      height: 54px;
      width: auto;
      border-radius: 16px;
      object-fit: contain;
      background: #FFFFFF;
      padding: 4px 8px;
      border: 1px solid rgba(180, 169, 214, 0.65);
      box-shadow: 0 0 0 3px #FFF8EA, 0 10px 26px rgba(0,0,0,0.12);
    }

    .hidden { display: none !important; }

    #roundTimer {
      margin-top: 4px;
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #F84779;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .page-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .top-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(180, 169, 214, 0.5);
      overflow: hidden;
    }
    .top-tabs button {
      border: none;
      padding: 6px 12px;
      font-size: 0.84rem;
      cursor: pointer;
      background: transparent;
      color: #6B618F;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .top-tabs button.active {
      background: linear-gradient(135deg, #F84779, #F7C948);
      color: #2B1E4A;
    }

    .player-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(248, 247, 255, 0.9);
      border: 1px solid rgba(180, 169, 214, 0.6);
      margin: 2px 4px 2px 0;
      font-size: 0.82rem;
      color: #433362;
    }
    .remove-player-btn {
      border: none;
      background: transparent;
      color: #EF4444;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
    }
    .remove-player-btn:hover { color: #b91c1c; }

    .team-row { font-size: 0.95rem; }

    @media (max-width: 640px) {
      body { font-size: 1.05rem; }
      .app { padding: 16px 10px 32px; }
      .card { padding: 18px 14px 20px; border-radius: 20px; }
      h1 { font-size: 1.6rem; }
      h3 { font-size: 1.05rem; }
      label { font-size: 0.9rem; }
      input, select { font-size: 1rem; }
      .btn { font-size: 1rem; padding: 10px 16px; }
      #roundTimer {
        font-size: 2rem;
        text-align: center;
        margin-top: 8px;
      }
      .team-row { font-size: 0.98rem; }
      .team-players { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="hostTop">
      <div class="page-header">
        <div class="page-header-main">
          <img id="host-logo" class="logo-small hidden" alt="××™×œ×× ×™×” ×œ×•×’×•" />
          <div>
            <div class="chip">××™×œ×× ×™×” Â· × ×™×”×•×œ ××©×—×§ ğŸ‘‘</div>
            <h1 style="margin:4px 0 0; font-size:1.7rem;">×× ×”×œ ×”××©×—×§</h1>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
          <div class="top-tabs">
            <button id="tabHost" class="active" type="button">ğŸ‘‘ ××¦×‘ ×× ×”×œ</button>
            <button id="tabPlayer" type="button">ğŸ® ××¦×‘ ×©×—×§×Ÿ (×× ×™)</button>
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
            <button class="btn btn-ghost btn-small" onclick="location.href='home.html'">â¬… ××¡×š ×”×‘×™×ª</button>
          </div>
        </div>
      </div>

      <p class="status-text" style="margin-top:8px;">
        ×‘×œ×©×•× ×™×ª "××¦×‘ ×× ×”×œ" ××ª×” ×©×•×œ×˜ ×‘××©×—×§. ×‘×œ×©×•× ×™×ª "××¦×‘ ×©×—×§×Ÿ (×× ×™)" ×ª×¤×ª×— ×œ×¢×¦××š ×—×œ×•×Ÿ ×©×—×§×Ÿ
        × ×¤×¨×“ â€“ ×•×ª×•×›×œ ×œ×—×–×•×¨ ×œ×›××Ÿ ×‘×›×œ ×¨×’×¢.
      </p>
    </div>

    <!-- ××¦×‘ ×× ×”×œ -->
    <div id="hostMode">
      <div class="card">
        <div class="row">
          <div>
            <label for="hostName">×©× ×”×× ×”×œ</label>
            <input id="hostName" type="text" placeholder="×œ×“×•×’××”: ××©×”" />
          </div>
          <div>
            <label for="numTeams">××¡×¤×¨ ×§×‘×•×¦×•×ª</label>
            <select id="numTeams">
              <option value="2">2 ×§×‘×•×¦×•×ª</option>
              <option value="3">3 ×§×‘×•×¦×•×ª</option>
              <option value="4">4 ×§×‘×•×¦×•×ª</option>
              <option value="5">5 ×§×‘×•×¦×•×ª</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="targetScore">×™×¢×“ × ×§×•×“×•×ª ×œ× ×™×¦×—×•×Ÿ</label>
            <input id="targetScore" type="number" min="5" max="200" value="30" />
          </div>
          <div>
            <label for="roundSeconds">××©×š ×¡×™×‘×•×‘ (×©× ×™×•×ª)</label>
            <input id="roundSeconds" type="number" min="10" max="300" value="60" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="teamNameA">×©× ×§×‘×•×¦×” A</label>
            <input id="teamNameA" type="text" placeholder="×œ××©×œ: ×”×›×—×•×œ×™×" />
          </div>
          <div>
            <label for="teamNameB">×©× ×§×‘×•×¦×” B</label>
            <input id="teamNameB" type="text" placeholder="×œ××©×œ: ×”×•×•×¨×•×“×™×" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="teamNameC">×©× ×§×‘×•×¦×” C (××•×¤×¦×™×•× ×œ×™)</label>
            <input id="teamNameC" type="text" placeholder="×§×‘×•×¦×” × ×•×¡×¤×ª" />
          </div>
          <div>
            <label for="teamNameD">×©× ×§×‘×•×¦×” D (××•×¤×¦×™×•× ×œ×™)</label>
            <input id="teamNameD" type="text" placeholder="×§×‘×•×¦×” × ×•×¡×¤×ª" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="teamNameE">×©× ×§×‘×•×¦×” E (××•×¤×¦×™×•× ×œ×™)</label>
            <input id="teamNameE" type="text" placeholder="×§×‘×•×¦×” × ×•×¡×¤×ª" />
          </div>
        </div>

        <div style="margin-top:8px; margin-bottom:6px;">
          <label>×§×˜×’×•×¨×™×•×ª ××™×œ×™×</label>
          <div class="status-text">
            ×× ×œ× ×ª×¡××Ÿ ×›×œ×•× â€“ ×”××©×—×§ ×™×©×ª××© ×‘×›×œ ×”×§×˜×’×•×¨×™×•×ª.
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; font-size:0.82rem;">
            <label style="font-weight:600;">
              <input type="checkbox" id="catSelectAll" /> ×‘×—×¨ ×”×›×œ
            </label>
            <label><input type="checkbox" class="cat-checkbox" value="general" checked /> ×›×œ×œ×™</label>
            <label><input type="checkbox" class="cat-checkbox" value="family" checked /> ××©×¤×—×”</label>
            <label><input type="checkbox" class="cat-checkbox" value="food" checked /> ××•×›×œ</label>
            <label><input type="checkbox" class="cat-checkbox" value="work" /> ×¢×‘×•×“×”</label>
            <label><input type="checkbox" class="cat-checkbox" value="hard" /> ×§×©×”</label>
            <label><input type="checkbox" class="cat-checkbox" value="sports" /> ×¡×¤×•×¨×˜</label>
            <label><input type="checkbox" class="cat-checkbox" value="technology" /> ×˜×›× ×•×œ×•×’×™×”</label>
            <label><input type="checkbox" class="cat-checkbox" value="travel" /> ×˜×™×•×œ×™×</label>
            <label><input type="checkbox" class="cat-checkbox" value="school" /> ×‘×™×ª ×¡×¤×¨</label>
            <label><input type="checkbox" class="cat-checkbox" value="entertainment" /> ×¡×¨×˜×™× ×•×¡×“×¨×•×ª</label>
            <label><input type="checkbox" class="cat-checkbox" value="music" /> ××•×–×™×§×”</label>
            <label><input type="checkbox" class="cat-checkbox" value="nature" /> ×˜×‘×¢</label>
            <label><input type="checkbox" class="cat-checkbox" value="holidays" /> ×—×’×™×</label>
            <label><input type="checkbox" class="cat-checkbox" value="animals" /> ×‘×¢×œ×™ ×—×™×™×</label>
            <label><input type="checkbox" class="cat-checkbox" value="objects" /> ×—×¤×¦×™×</label>
          </div>
        </div>

        <button id="createGameBtn" class="btn btn-primary" style="margin-top:8px;">
          ×™×¦×™×¨×ª ××©×—×§ ×—×“×©
        </button>
        <button id="endGameBtn" class="btn btn-danger" style="margin-top:8px; margin-right:6px;" disabled>
          ×¡×’×™×¨×ª ××©×—×§
        </button>

        <div id="hostStatus" class="status-text" style="margin-top:8px;"></div>
      </div>

      <div class="card" id="gameCodeRow" style="display:none;">
        <h3 style="margin:0 0 6px;">×§×•×“ ××©×—×§</h3>
        <div id="gameCodeDisplay" class="status-text" style="margin-bottom:6px;"></div>

        <div class="status-text" style="margin-bottom:4px;">
          ×©×œ×— ×”×–×× ×” ×œ×©×—×§× ×™× ×‘×•×•××˜×¡××¤ ×¢× ×§×•×“ ×”××©×—×§ ×•×§×‘×•×¦×” ××•×’×“×¨×ª ××¨××©:
        </div>

        <div class="row" style="margin-bottom:6px;">
          <div>
            <label for="inviteTeamSelect">×§×‘×•×¦×” ×œ×”×–×× ×”</label>
            <select id="inviteTeamSelect">
              <option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>
            </select>
          </div>
          <div style="flex:0 0 190px; align-self:flex-end;">
            <button id="whatsappInviteBtn" class="btn btn-primary btn-wide btn-small" type="button" disabled>
              ğŸ“² ×©×œ×™×—×ª ×”×–×× ×” ×‘×•×•××˜×¡××¤
            </button>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

        <h3 style="margin:0 0 6px;">×©×œ×™×˜×” ×‘×¡×™×‘×•×‘</h3>
        <div id="roundStatus" class="status-text" style="margin-bottom:6px;"></div>
        <div id="roundTimer">×˜×™×™××¨: --:--</div>

        <div class="status-text" style="margin-top:6px; margin-bottom:6px;">
          ×‘×—×¨ ×§×‘×•×¦×” ×œ×¡×™×‘×•×‘ ×”×‘× ×•××¡×‘×™×¨ (×× ×ª×¨×¦×”). ×× ×œ× ×ª×‘×—×¨ ××¡×‘×™×¨ â€“ ×”××©×—×§ ×™×‘×—×¨ ×©×—×§×Ÿ ×¨××©×•×Ÿ ×‘×§×‘×•×¦×”.
        </div>

        <div class="row">
          <div>
            <label for="roundTeamSelect">×§×‘×•×¦×” ×œ×¡×™×‘×•×‘</label>
            <select id="roundTeamSelect">
              <option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>
            </select>
          </div>
          <div>
            <label for="roundSecondsInline">××©×š ×¡×™×‘×•×‘ (×©× ×™×•×ª)</label>
            <input id="roundSecondsInline" type="number" min="10" max="300" value="60" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="explainerSelect">××¡×‘×™×¨ (××•×¤×¦×™×•× ×œ×™)</label>
            <select id="explainerSelect">
              <option value="">×‘×—×™×¨×” ××•×˜×•××˜×™×ª</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px; flex-wrap:wrap;">
          <button id="startRoundBtn" class="btn btn-success">×”×ª×—×œ ×¡×™×‘×•×‘</button>
          <button id="stopRoundBtn" class="btn btn-ghost" disabled>×¡×™×•× ×¡×™×‘×•×‘</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px;">× ×™×§×•×“ ×•×§×‘×•×¦×•×ª</h3>
        <div id="scoreTarget" class="status-text"></div>
        <div id="scoreboard"></div>

        <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 8px;" />

        <h3 style="margin:0 0 6px; font-size:0.95rem;">×©×—×§× ×™× ×œ×¤×™ ×§×‘×•×¦×”</h3>
        <div id="playersByTeam" class="status-text"></div>

        <div id="host-banner-slot" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- ××¦×‘ ×©×—×§×Ÿ ×¢×‘×•×¨ ×”×× ×”×œ (×—×œ×•×Ÿ ×—×“×©) -->
    <div id="playerMode" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 6px;">×× ×™ ×›×©×—×§×Ÿ</h3>
        <p class="status-text" style="margin-bottom:8px;">
          ×›××Ÿ ×ª×’×“×™×¨ ××ª ×”×©× ×•×”×§×‘×•×¦×” ×©×œ×š ×›×©×—×§×Ÿ. ×›×©×ª×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨, ×™×™×¤×ª×— ×—×œ×•×Ÿ ×—×“×© ×¢× ××¡×š ×”×©×—×§×Ÿ,
          ×•×ª×¦×˜×¨×£ ××•×˜×•××˜×™×ª ×œ××©×—×§ ×•×œ×§×‘×•×¦×” ×©×‘×—×¨×ª.
        </p>

        <div class="row">
          <div>
            <label for="hostPlayerName">×”×©× ×©×œ×™ ×‘××©×—×§</label>
            <input id="hostPlayerName" type="text" placeholder="×œ×“×•×’××”: ××©×” ×”××œ×š" />
          </div>
          <div>
            <label for="hostPlayerTeamSelect">×”×§×‘×•×¦×” ×©×œ×™</label>
            <select id="hostPlayerTeamSelect">
              <option value="">×‘×—×™×¨×ª ×§×‘×•×¦×”...</option>
            </select>
          </div>
        </div>

        <button id="openPlayerViewBtn" class="btn btn-primary" type="button" style="margin-top:6px;">
          ×¤×ª×— ××¡×š ×©×—×§×Ÿ ×‘×—×œ×•×Ÿ ×—×“×©
        </button>

        <p class="status-text" style="margin-top:8px;">
          ×‘××¡×š ×”×—×“×© ×ª×ª× ×”×’ ×›××• ×›×œ ×©×—×§×Ÿ ×¨×’×™×œ. ×›××Ÿ ×‘×“×£ ×”× ×™×”×•×œ ×ª×•×›×œ ×œ×”××©×™×š ×œ×©×œ×•×˜ ×‘××©×—×§
          ×•×œ×¢×‘×•×¨ ×—×–×¨×” ×œ×œ×©×•× ×™×ª "××¦×‘ ×× ×”×œ".
        </p>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const LS_HOST_GAME_KEY = "mil_hostGameCode";

    let currentGameCode = null;
    let lastGameState = null;

    const hostNameInput = document.getElementById("hostName");
    const numTeamsSelect = document.getElementById("numTeams");
    const targetScoreInput = document.getElementById("targetScore");
    const roundSecondsInput = document.getElementById("roundSeconds");
    const teamNameAInput = document.getElementById("teamNameA");
    const teamNameBInput = document.getElementById("teamNameB");
    const teamNameCInput = document.getElementById("teamNameC");
    const teamNameDInput = document.getElementById("teamNameD");
    const teamNameEInput = document.getElementById("teamNameE");
    const catCheckboxes = document.querySelectorAll(".cat-checkbox");
    const selectAllCatsCheckbox = document.getElementById("catSelectAll");

    const createGameBtn = document.getElementById("createGameBtn");
    const endGameBtn = document.getElementById("endGameBtn");
    const hostStatus = document.getElementById("hostStatus");

    const gameCodeRow = document.getElementById("gameCodeRow");
    const gameCodeDisplay = document.getElementById("gameCodeDisplay");
    const roundStatusEl = document.getElementById("roundStatus");
    const roundTimerEl = document.getElementById("roundTimer");

    const roundTeamSelect = document.getElementById("roundTeamSelect");
    const roundSecondsInline = document.getElementById("roundSecondsInline");
    const explainerSelect = document.getElementById("explainerSelect");
    const startRoundBtn = document.getElementById("startRoundBtn");
    const stopRoundBtn = document.getElementById("stopRoundBtn");

    const inviteTeamSelect = document.getElementById("inviteTeamSelect");
    const whatsappInviteBtn = document.getElementById("whatsappInviteBtn");

    const scoreboardEl = document.getElementById("scoreboard");
    const scoreTargetEl = document.getElementById("scoreTarget");
    const playersByTeamEl = document.getElementById("playersByTeam");
    const hostBannerSlot = document.getElementById("host-banner-slot");
    const hostLogoEl = document.getElementById("host-logo");

    const tabHost = document.getElementById("tabHost");
    const tabPlayer = document.getElementById("tabPlayer");
    const hostMode = document.getElementById("hostMode");
    const playerMode = document.getElementById("playerMode");
    const hostPlayerNameInput = document.getElementById("hostPlayerName");
    const hostPlayerTeamSelect = document.getElementById("hostPlayerTeamSelect");
    const openPlayerViewBtn = document.getElementById("openPlayerViewBtn");

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = (s % 60).toString().padStart(2, "0");
      return m + ":" + ss;
    }

    function collectCategories() {
      const selected = [];
      catCheckboxes.forEach((cb) => {
        if (cb.checked) selected.push(cb.value);
      });
      return selected;
    }

    if (selectAllCatsCheckbox) {
      selectAllCatsCheckbox.addEventListener("change", () => {
        const checked = selectAllCatsCheckbox.checked;
        catCheckboxes.forEach((cb) => { cb.checked = checked; });
      });
      catCheckboxes.forEach((cb) => {
        cb.addEventListener("change", () => {
          let allChecked = true;
          catCheckboxes.forEach((c2) => { if (!c2.checked) allChecked = false; });
          selectAllCatsCheckbox.checked = allChecked;
        });
      });
    }

    function refreshExplainerOptions() {
      if (!explainerSelect) return;
      const teamId = roundTeamSelect.value;
      explainerSelect.innerHTML = '<option value="">×‘×—×™×¨×” ××•×˜×•××˜×™×ª</option>';
      if (!teamId || !lastGameState || !lastGameState.teams) return;

      const team = lastGameState.teams[teamId];
      if (!team || !Array.isArray(team.players)) return;

      const playersMap = lastGameState.players || lastGameState.playersByClientId || {};
      team.players.forEach((clientId) => {
        const p = playersMap[clientId];
        if (!p) return;
        const opt = document.createElement("option");
        opt.value = clientId;
        opt.textContent = p.name || clientId;
        explainerSelect.appendChild(opt);
      });
    }

    function attachRemovePlayerHandlers() {
      const btns = document.querySelectorAll(".remove-player-btn[data-client-id]");
      btns.forEach((btn) => {
        btn.onclick = () => {
          const clientId = btn.getAttribute("data-client-id");
          if (!clientId || !currentGameCode) return;
          const ok = confirm("×œ×”×¡×™×¨ ××ª ×”×©×—×§×Ÿ ×”×–×” ××”××©×—×§?");
          if (!ok) return;
          socket.emit(
            "removePlayer",
            { gameCode: currentGameCode, clientId },
            (resp) => {
              if (!resp || !resp.ok) {
                alert(resp && resp.error ? resp.error : "×©×’×™××” ×‘×”×¡×¨×ª ×©×—×§×Ÿ.");
                return;
              }
              hostStatus.textContent = "×”×©×—×§×Ÿ ×”×•×¡×¨ ××”××©×—×§.";
              if (resp.game) {
                renderGameState(resp.game);
              }
            }
          );
        };
      });
    }

    function updateTimerFromGame(game) {
      if (!roundTimerEl) return;

      if (!game || !game.currentRound) {
        roundTimerEl.textContent = "×˜×™×™××¨: --:--";
        if (startRoundBtn) startRoundBtn.disabled = !currentGameCode;
        if (stopRoundBtn) stopRoundBtn.disabled = true;
        return;
      }

      const r = game.currentRound;
      const isActive = (typeof r.active === "boolean") ? r.active : !!r.isActive;
      const secondsLeft = (typeof r.secondsLeft === "number")
        ? r.secondsLeft
        : (r.roundSeconds || 0);

      if (!isActive) {
        roundTimerEl.textContent = "×˜×™×™××¨: --:--";
        if (startRoundBtn) startRoundBtn.disabled = !currentGameCode;
        if (stopRoundBtn) stopRoundBtn.disabled = true;
        return;
      }

      roundTimerEl.textContent = "×˜×™×™××¨: " + formatTime(secondsLeft);
      if (startRoundBtn) startRoundBtn.disabled = true;
      if (stopRoundBtn) stopRoundBtn.disabled = false;
    }

    function renderGameState(game) {
      lastGameState = game;

      if (!game) {
        if (gameCodeRow) gameCodeRow.style.display = "none";
        if (gameCodeDisplay) gameCodeDisplay.textContent = "";
        if (whatsappInviteBtn) whatsappInviteBtn.disabled = true;
        if (endGameBtn) endGameBtn.disabled = true;
        scoreboardEl.innerHTML = "";
        playersByTeamEl.innerHTML = "";
        scoreTargetEl.textContent = "";
        if (roundStatusEl) roundStatusEl.textContent = "";
        updateTimerFromGame(null);

        if (hostPlayerTeamSelect) {
          hostPlayerTeamSelect.innerHTML = '<option value="">×‘×—×™×¨×ª ×§×‘×•×¦×”...</option>';
        }
        return;
      }

      if (game.code) {
        currentGameCode = game.code;
      }

      if (gameCodeRow) {
        gameCodeRow.style.display = "block";
      }

      if (gameCodeDisplay && currentGameCode) {
        gameCodeDisplay.textContent = "×§×•×“ ×”××©×—×§: " + currentGameCode;
      }

      if (whatsappInviteBtn && currentGameCode) {
        whatsappInviteBtn.disabled = false;
      }

      if (endGameBtn) {
        endGameBtn.disabled = false;
      }

      if (scoreTargetEl) {
        scoreTargetEl.textContent = game.targetScore
          ? `××©×—×§ ×¢×“ ${game.targetScore} × ×§×•×“×•×ª`
          : "";
      }

      if (scoreboardEl && game.teams) {
        scoreboardEl.innerHTML = "";
        Object.entries(game.teams).forEach(([teamId, team]) => {
          const row = document.createElement("div");
          row.className = "team-row";
          row.style.display = "flex";
          row.style.justifyContent = "space-between";
          row.style.alignItems = "center";
          row.style.padding = "6px 0";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;
          const scoreSpan = document.createElement("span");
          scoreSpan.textContent = team.score || 0;

          row.appendChild(nameSpan);
          row.appendChild(scoreSpan);
          scoreboardEl.appendChild(row);
        });
      }

      if (playersByTeamEl && game.teams) {
        playersByTeamEl.innerHTML = "";
        const playersMap = game.players || game.playersByClientId || {};
        Object.entries(game.teams).forEach(([teamId, team]) => {
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "8px";

          const title = document.createElement("div");
          title.textContent = (team.name || `×§×‘×•×¦×” ${teamId}`) + ":";
          title.style.fontWeight = "600";
          title.style.marginBottom = "2px";
          wrapper.appendChild(title);

          const list = document.createElement("div");
          list.className = "team-players";

          if (Array.isArray(team.players) && team.players.length) {
            team.players.forEach((cid) => {
              const p = playersMap[cid];
              const name = (p && p.name) ? p.name : cid;
              const pill = document.createElement("span");
              pill.className = "player-pill";
              pill.innerHTML = `
                <span>${name}</span>
                <button type="button" class="remove-player-btn" data-client-id="${cid}">âœ–</button>
              `;
              list.appendChild(pill);
            });
          } else {
            list.textContent = "â€”";
          }

          wrapper.appendChild(list);
          playersByTeamEl.appendChild(wrapper);
        });

        attachRemovePlayerHandlers();
      }

      if (roundStatusEl) {
        const r = game.currentRound;
        if (r && r.teamId) {
          const t = game.teams && game.teams[r.teamId];
          const teamName = t ? (t.name || `×§×‘×•×¦×” ${r.teamId}`) : "";
          const explainerName = r.explainerName || "";
          let msg =
            `×¡×™×‘×•×‘ ×œ×§×‘×•×¦×”: ${teamName}` +
            (explainerName ? ` Â· ××¡×‘×™×¨: ${explainerName}` : "");

          if (typeof r.roundScore === "number") {
            msg += ` Â· × ×™×§×•×“ ×‘×¡×™×‘×•×‘: ${r.roundScore}`;
          }

          roundStatusEl.innerHTML = msg;
        } else {
          roundStatusEl.textContent = "××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
        }
      }

      if (roundTeamSelect) {
        const oldValue = roundTeamSelect.value;
        roundTeamSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>';
        if (game.teams) {
          Object.entries(game.teams).forEach(([teamId, team]) => {
            const opt = document.createElement("option");
            opt.value = teamId;
            opt.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;
            roundTeamSelect.appendChild(opt);
          });
        }
        let selectedTeamId = oldValue;
        if (!selectedTeamId) {
          const teamIds = Object.keys(game.teams || {});
          if (teamIds.length > 0) {
            selectedTeamId = teamIds[0];
          }
        }
        if (selectedTeamId && game.teams && game.teams[selectedTeamId]) {
          roundTeamSelect.value = selectedTeamId;
        }
      }

      if (inviteTeamSelect) {
        const oldInvite = inviteTeamSelect.value;
        inviteTeamSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>';
        if (game.teams) {
          Object.entries(game.teams).forEach(([teamId, team]) => {
            const opt = document.createElement("option");
            opt.value = teamId;
            opt.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;
            inviteTeamSelect.appendChild(opt);
          });
        }
        if (oldInvite && game.teams && game.teams[oldInvite]) {
          inviteTeamSelect.value = oldInvite;
        }
      }

      if (hostPlayerTeamSelect) {
        const oldHostTeam = hostPlayerTeamSelect.value;
        hostPlayerTeamSelect.innerHTML = '<option value="">×‘×—×™×¨×ª ×§×‘×•×¦×”...</option>';
        if (game.teams) {
          Object.entries(game.teams).forEach(([teamId, team]) => {
            const opt = document.createElement("option");
            opt.value = teamId;
            opt.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;
            hostPlayerTeamSelect.appendChild(opt);
          });
        }
        let selectedHostTeam = oldHostTeam;
        if (!selectedHostTeam) {
          const teamIds = Object.keys(game.teams || {});
          if (teamIds.length > 0) selectedHostTeam = teamIds[0];
        }
        if (selectedHostTeam && game.teams && game.teams[selectedHostTeam]) {
          hostPlayerTeamSelect.value = selectedHostTeam;
        }
      }

      updateTimerFromGame(game);
      refreshExplainerOptions();
    }

    if (roundTeamSelect) {
      roundTeamSelect.addEventListener("change", () => {
        refreshExplainerOptions();
      });
    }

    if (createGameBtn) {
      createGameBtn.addEventListener("click", () => {
        const hostName = (hostNameInput.value || "").trim();
        if (!hostName) {
          hostStatus.textContent = "× × ×œ×”×–×™×Ÿ ×©× ×× ×”×œ.";
          return;
        }

        const numTeams = parseInt(numTeamsSelect.value || "2", 10);
        const targetScore = parseInt(targetScoreInput.value || "30", 10);
        const roundSeconds = parseInt(roundSecondsInput.value || "60", 10);
        const cats = collectCategories();

        const teamNames = {
          A: (teamNameAInput.value || "").trim(),
          B: (teamNameBInput.value || "").trim(),
          C: (teamNameCInput.value || "").trim(),
          D: (teamNameDInput.value || "").trim(),
          E: (teamNameEInput.value || "").trim(),
        };

        socket.emit(
          "createGame",
          {
            hostName,
            numTeams,
            targetScore,
            roundSeconds,
            categories: cats,
            teamNames,
          },
          (response) => {
            if (!response || !response.ok) {
              hostStatus.textContent =
                response && response.error
                  ? response.error
                  : "×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×—×§.";
              return;
            }
            currentGameCode = response.gameCode;

            try { localStorage.setItem(LS_HOST_GAME_KEY, currentGameCode); } catch(e) {}

            hostStatus.textContent = `×”××©×—×§ × ×•×¦×¨! ×§×•×“ ×”××©×—×§: ${currentGameCode}`;
            if (gameCodeRow) gameCodeRow.style.display = "block";
            if (gameCodeDisplay) {
              gameCodeDisplay.textContent = "×§×•×“ ×”××©×—×§: " + currentGameCode;
            }
            if (endGameBtn) endGameBtn.disabled = false;

            if (roundSecondsInline) {
              roundSecondsInline.value = roundSeconds.toString();
            }

            if (hostPlayerNameInput && !hostPlayerNameInput.value) {
              hostPlayerNameInput.value = hostName;
            }

            if (response.game) {
              renderGameState(response.game);
            }
          }
        );
      });
    }

    if (endGameBtn) {
      endGameBtn.addEventListener("click", () => {
        if (!currentGameCode) return;
        socket.emit("endGame", { gameCode: currentGameCode }, () => {
          hostStatus.textContent = "×”××©×—×§ × ×¡×’×¨.";
          currentGameCode = null;
          try { localStorage.removeItem(LS_HOST_GAME_KEY); } catch(e) {}
          renderGameState(null);
        });
      });
    }

    if (startRoundBtn) {
      startRoundBtn.addEventListener("click", () => {
        if (!currentGameCode) return;
        const teamId = roundTeamSelect.value;
        const roundSecondsVal =
          parseInt(roundSecondsInline.value || roundSecondsInput.value || "60", 10) || 60;
        const explainerClientId =
          explainerSelect && explainerSelect.value ? explainerSelect.value : null;

        socket.emit(
          "startRound",
          {
            gameCode: currentGameCode,
            teamId,
            roundSeconds: roundSecondsVal,
            explainerClientId,
          },
          (resp) => {
            if (!resp || !resp.ok) {
              hostStatus.textContent =
                resp && resp.error ? resp.error : "×©×’×™××” ×‘×”×ª×—×œ×ª ×”×¡×™×‘×•×‘.";
              return;
            }
            hostStatus.textContent = "×”×¡×™×‘×•×‘ ×”×ª×—×™×œ. ×”×˜×™×™××¨ ×•×”××¦×‘ ×™×ª×¢×“×›× ×• ×œ×¤×™ ×”×©×¨×ª.";
          }
        );
      });
    }

    if (stopRoundBtn) {
      stopRoundBtn.addEventListener("click", () => {
        if (!currentGameCode) return;
        socket.emit("endRound", { gameCode: currentGameCode }, (resp) => {
          if (resp && !resp.ok) {
            hostStatus.textContent = resp.error || "×©×’×™××” ×‘×¡×™×•× ×”×¡×™×‘×•×‘.";
            return;
          }
          hostStatus.textContent = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.";
        });
      });
    }

    if (tabHost && tabPlayer && hostMode && playerMode) {
      tabHost.addEventListener("click", () => {
        tabHost.classList.add("active");
        tabPlayer.classList.remove("active");
        hostMode.classList.remove("hidden");
        playerMode.classList.add("hidden");
      });

      tabPlayer.addEventListener("click", () => {
        tabPlayer.classList.add("active");
        tabHost.classList.remove("active");
        hostMode.classList.add("hidden");
        playerMode.classList.remove("hidden");
      });
    }

    if (openPlayerViewBtn) {
      openPlayerViewBtn.addEventListener("click", () => {
        if (!currentGameCode) {
          alert("××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢. ×§×•×“× ×¦×•×¨ ××©×—×§.");
          return;
        }

        const name =
          (hostPlayerNameInput && hostPlayerNameInput.value.trim()) ||
          (hostNameInput && hostNameInput.value.trim());

        if (!name) {
          alert("× × ×œ×”×–×™×Ÿ ×©× ×œ×©×—×§×Ÿ.");
          return;
        }

        const teamId = hostPlayerTeamSelect ? hostPlayerTeamSelect.value : "";

        const params = new URLSearchParams();
        params.set("autoJoin", "1");
        params.set("code", currentGameCode);
        params.set("name", name);
        if (teamId) params.set("teamId", teamId);
        params.set("hostMode", "1"); // ×›×“×™ ×œ×“×¢×ª ×‘××¡×š ×”×©×—×§×Ÿ ×©×–×” ×”×× ×”×œ

        const url = "/player.html?" + params.toString();
        window.open(url, "_blank");
      });
    }

    function buildPlayerInviteLink(teamId, teamName) {
      if (!currentGameCode) return null;
      const origin = window.location.origin;
      const baseUrl = origin + "/player.html";
      const params = new URLSearchParams();
      params.set("code", currentGameCode);
      if (teamId) params.set("teamId", teamId);
      if (teamName) params.set("teamName", teamName);
      return baseUrl + "?" + params.toString();
    }

    if (whatsappInviteBtn) {
      whatsappInviteBtn.addEventListener("click", () => {
        if (!currentGameCode) {
          alert("××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢.");
          return;
        }
        const teamId = inviteTeamSelect ? inviteTeamSelect.value : "";
        if (!teamId) {
          alert("×‘×—×¨ ×§×‘×•×¦×” ×œ×”×–×× ×”.");
          return;
        }

        const team =
          lastGameState &&
          lastGameState.teams &&
          lastGameState.teams[teamId];

        const teamName = (team && team.name) ? team.name : ("×§×‘×•×¦×” " + teamId);

        const link = buildPlayerInviteLink(teamId, teamName);

        const text =
          "ğŸ”¥ ×™×© ×œ× ×• ×¢×›×©×™×• ××©×—×§ ××™×œ×× ×™×” ×—×™!\n" +
          `××ª×” ××•×–××Ÿ ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×” "${teamName}".\n` +
          `×§×•×“ ×”××©×—×§: ${currentGameCode}\n` +
          "×œ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ ×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨:\n" +
          link + "\n\n" +
          "×˜×™×¤: ×›× ×¡ ×¢× ×©× ××¦×—×™×§ ×•×ª×ª×›×•× ×Ÿ ×œ×”×¨×‘×” ×¦×—×•×§×™× ğŸ˜„";

        const waUrl = "https://wa.me/?text=" + encodeURIComponent(text);
        window.open(waUrl, "_blank");
      });
    }

    socket.on("gameState", (game) => {
      renderGameState(game);
    });

    socket.on("gameUpdated", (game) => {
      renderGameState(game);
    });

    socket.on("gameEnded", () => {
      hostStatus.textContent = "×”××©×—×§ × ×¡×’×¨.";
      currentGameCode = null;
      try { localStorage.removeItem(LS_HOST_GAME_KEY); } catch(e) {}
      renderGameState(null);
    });

    socket.on("roundTimeUp", (data) => {
      if (!data) return;
      const score = typeof data.roundScore === "number" ? data.roundScore : 0;

      let msgLine;
      if (score <= 5) {
        msgLine = "××ª× ×¦×•×•×ª ×—×œ×©, ×›×“××™ ×©×ª×ª××× ×• ×™×•×ª×¨";
      } else if (score <= 10) {
        msgLine = "××ª× ×¦×•×•×ª × ×—××“, ×‘×˜×•×— ×©××ª× ×™×›×•×œ×™× ×™×•×ª×¨";
      } else {
        msgLine = "××ª× ×¦×•×•×ª ×¢×œ, ×”×©××¨×ª× ×œ×”× ××‘×§...";
      }

      alert("â± × ×’××¨ ×”×–××Ÿ!\n\n" + msgLine + `\n\n(××¡×¤×¨ ×ª×©×•×‘×•×ª × ×›×•× ×•×ª ×‘×¡×™×‘×•×‘: ${score})`);
    });

    (function loadBrandingForHost() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          const logoCfg = data.logo;
          if (logoCfg && logoCfg.imageUrl && hostLogoEl) {
            hostLogoEl.src = logoCfg.imageUrl;
            hostLogoEl.alt = logoCfg.altText || "××™×œ×× ×™×”";
            hostLogoEl.classList.remove("hidden");
            hostLogoEl.addEventListener("error", () => {
              hostLogoEl.classList.add("hidden");
            });
          }

          if (!hostBannerSlot) return;
          const cfg = data.host;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = cfg.altText || "Banner";
          img.style.maxWidth = "100%";
          img.style.borderRadius = "18px";
          img.style.display = "block";
          img.style.marginTop = "8px";

          img.addEventListener("error", () => {
            a.style.display = "none";
          });

          a.appendChild(img);
          hostBannerSlot.appendChild(a);
        })
        .catch(() => {});
    })();

    (function restoreHostFromStorage() {
      try {
        const storedCode = localStorage.getItem(LS_HOST_GAME_KEY);
        if (!storedCode) return;

        currentGameCode = storedCode;
        socket.emit("hostReconnect", { gameCode: storedCode }, (resp) => {
          if (resp && resp.ok && resp.game) {
            hostStatus.textContent = "×©×•×—×–×¨ ×—×™×‘×•×¨ ×œ××©×—×§ " + storedCode;
            renderGameState(resp.game);
          } else {
            localStorage.removeItem(LS_HOST_GAME_KEY);
          }
        });
      } catch (e) {}
    })();

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && currentGameCode) {
        socket.emit("getGameState", { gameCode: currentGameCode }, (resp) => {
          if (resp && resp.ok && resp.game) {
            renderGameState(resp.game);
          }
        });
      }
    });
  </script>
</body>
</html>
