<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ספיד מניה</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { 
            --bg-gradient: radial-gradient(circle at top, #2B1E4A, #161026);
            --tile-bg: #fff; 
            --tile-text: #2B1E4A; 
            --accent: #FFD700; 
            --primary: #F84779;
        }
        
        * { box-sizing: border-box; font-family: "Varela Round", sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            background: var(--bg-gradient); 
            color: white; 
            height: 100dvh; /* גובה דינמי למובייל */
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* מסך כניסה */
        #loginScreen, #waitScreen {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        
        .input-group { width: 100%; max-width: 320px; margin-bottom: 10px; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1.1rem; text-align: center; background: rgba(255,255,255,0.9); }
        .btn-big { width: 100%; padding: 15px; border-radius: 50px; background: linear-gradient(135deg, var(--primary), #ff8e53); color: white; font-weight: bold; font-size: 1.2rem; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(248, 71, 121, 0.4); margin-top: 10px; }
        .btn-big:active { transform: scale(0.98); }

        /* מסך משחק ראשי */
        #gameScreen { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }

        /* סרגל עליון */
        .top-bar { 
            padding: 15px; 
            background: rgba(0,0,0,0.3); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            backdrop-filter: blur(5px);
        }
        .score-box { font-size: 1.1rem; font-weight: bold; display: flex; gap: 10px; }
        .timer-badge { background: var(--primary); padding: 5px 12px; border-radius: 15px; font-variant-numeric: tabular-nums; }

        /* אזור המילים שנמצאו */
        .words-area { 
            flex: 1; 
            background: rgba(255,255,255,0.05); 
            margin: 10px; 
            border-radius: 15px; 
            padding: 10px; 
            overflow-y: auto; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            align-content: flex-start; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .found-word { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; animation: popIn 0.3s; }

        /* אזור תחתון (לוח ומקלדת) - גובה קבוע */
        .play-area {
            background: rgba(0,0,0,0.4);
            border-radius: 25px 25px 0 0;
            padding: 15px;
            padding-bottom: 25px; /* Extra padding for bottom safe area */
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }

        /* שורת הסלוטים */
        .slots-container { 
            display: flex; 
            gap: 5px; 
            justify-content: center; 
            min-height: 55px; 
        }
        .slot { 
            width: 13vw; height: 13vw; max-width: 55px; max-height: 55px;
            border: 2px dashed rgba(255,255,255,0.3); 
            border-radius: 12px; 
            display: flex; align-items: center; justify-content: center;
        }

        /* שורת האותיות */
        .bank-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
            min-height: 60px;
        }

        /* האריח */
        .tile { 
            width: 13vw; height: 13vw; max-width: 55px; max-height: 55px;
            background: var(--tile-bg); color: var(--tile-text); 
            border-radius: 12px; 
            font-size: 1.6rem; font-weight: bold; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 0 #ccc; 
            cursor: pointer;
            transition: transform 0.1s;
        }
        .tile:active { transform: scale(0.95); }

        /* כפתורי שליטה */
        .controls { display: flex; gap: 10px; height: 60px; }
        .btn-game { 
            flex: 1; border: none; border-radius: 15px; font-size: 1.5rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-clear { background: #e74c3c; flex: 0.8; }
        .btn-submit { background: #2ecc71; flex: 2; font-weight: 800; font-size: 1.4rem; }
        .btn-game:active { transform: translateY(3px); box-shadow: none; }

        .hidden { display: none !important; }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginScreen">
        <h1 style="color:var(--accent); font-size:2.5rem; margin-bottom:5px;">ספיד מניה ⚡</h1>
        <p style="opacity:0.8; margin-bottom:30px;">הצטרפות למשחק קבוצתי</p>
        
        <div class="input-group"><input type="text" id="pCode" placeholder="קוד משחק (למשל ABCD)" style="text-transform:uppercase"></div>
        <div class="input-group"><input type="text" id="pName" placeholder="השם שלך"></div>
        <button class="btn-big" onclick="joinGame()">הצטרף למשחק</button>
        <p id="statusMsg" style="color:#ff6b6b; margin-top:10px;"></p>
    </div>

    <!-- Wait -->
    <div id="waitScreen" class="hidden">
        <h2 style="color:var(--accent);" id="teamNameTitle"></h2>
        <p>ממתינים למנהל שיתחיל את הסיבוב...</p>
        <div style="font-size:3rem; margin-top:20px; animation: popIn 1s infinite alternate;">⏳</div>
    </div>

    <!-- Game -->
    <div id="gameScreen" class="hidden">
        <div class="top-bar">
            <div class="score-box">
                <i class="ph-bold ph-users"></i> <span id="teamNameDisplay"></span>
            </div>
            <div class="timer-badge" id="timer">60</div>
        </div>

        <div id="wordsArea" class="words-area">
            <div style="width:100%; text-align:center; opacity:0.5; margin-top:20px;">המילים יופיעו כאן...</div>
        </div>

        <div class="play-area">
            <!-- 7 סלוטים -->
            <div class="slots-container" id="slotsRow"></div>
            
            <!-- בנק אותיות -->
            <div class="bank-container" id="bankRow"></div>

            <!-- כפתורים -->
            <div class="controls">
                <button class="btn-game btn-clear" onclick="clearBoard()"><i class="ph-bold ph-x"></i></button>
                <button class="btn-game btn-submit" onclick="submitWord()">שלח <i class="ph-bold ph-paper-plane-right" style="margin-right:8px;"></i></button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket;
        let letters = [];
        let slotsState = new Array(7).fill(null);
        let myTeamId = null;

        // Auto-connect
        try { if(typeof io !== 'undefined') socket = io(); else throw new Error(); } 
        catch(e) { console.warn("Mock"); socket = { on:()=>{}, emit:()=>{} }; }

        // URL Params (For host auto-join)
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('code')) document.getElementById('pCode').value = urlParams.get('code');
        if(urlParams.get('name')) document.getElementById('pName').value = urlParams.get('name');
        if(urlParams.get('name')) setTimeout(joinGame, 500); // Auto click if name provided

        function joinGame() {
            const code = document.getElementById('pCode').value.toUpperCase();
            const name = document.getElementById('pName').value;
            const teamId = urlParams.get('teamId');
            
            if(!code || !name) {
                document.getElementById('statusMsg').innerText = "נא למלא את כל השדות";
                return;
            }
            socket.emit('speed:join', { code, name, teamId });
        }

        socket.on('speed:error', ({message}) => {
            document.getElementById('statusMsg').innerText = message;
        });

        socket.on('speed:joinedSuccess', ({ teamName, teamId, gameState, letters: existingLetters }) => {
            myTeamId = teamId;
            document.getElementById('teamNameTitle').innerText = teamName;
            document.getElementById('teamNameDisplay').innerText = teamName;
            
            document.getElementById('loginScreen').classList.add('hidden');
            
            if (gameState === 'playing' && existingLetters) {
                // הצטרפות באמצע משחק
                startRoundLogic(existingLetters, 60); // זמן משוער
            } else {
                document.getElementById('waitScreen').classList.remove('hidden');
            }
        });

        socket.on('speed:roundStart', ({ letters: sLetters, duration }) => {
            startRoundLogic(sLetters, duration);
        });

        function startRoundLogic(sLetters, duration) {
            letters = sLetters.map((char, i) => ({ char, id: i }));
            slotsState.fill(null);
            
            renderBoard();
            
            document.getElementById('waitScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('wordsArea').innerHTML = '';

            let sec = duration;
            const t = setInterval(() => {
                sec--;
                document.getElementById('timer').textContent = sec;
                if(sec <= 0) { clearInterval(t); } // השרת ינהל את הסיום
            }, 1000);
        }

        socket.on('speed:boardUpdated', ({ indices }) => {
            // עדכון הלוח מחבר צוות אחר
            slotsState = indices.map(id => id !== null ? letters.find(l => l.id === id) : null);
            renderBoard(false);
        });

        socket.on('speed:wordAccepted', ({ word }) => {
            // אנימציה והוספה לרשימה
            const tag = document.createElement('div');
            tag.className = 'found-word';
            tag.textContent = word;
            document.getElementById('wordsArea').appendChild(tag);
            // גלילה למטה
            const area = document.getElementById('wordsArea');
            area.scrollTop = area.scrollHeight;
            
            // ניקוי לוח רק לשולח? לא, לכולם
            slotsState.fill(null);
            renderBoard(false);
        });

        // --- Render & Logic ---
        function renderBoard(emit = true) {
            const slotsContainer = document.getElementById('slotsRow');
            const bankContainer = document.getElementById('bankRow');
            
            slotsContainer.innerHTML = '';
            bankContainer.innerHTML = '';

            // Render Slots
            for(let i=0; i<7; i++) {
                const slotEl = document.createElement('div');
                slotEl.className = 'slot';
                
                const letterObj = slotsState[i];
                if(letterObj) {
                    const tile = createTile(letterObj);
                    tile.onclick = () => { removeFromSlot(i); };
                    slotEl.appendChild(tile);
                } else {
                    // סלוט ריק - קליק עליו לא עושה כלום כרגע (אפשר להוסיף לוגיקה)
                }
                slotsContainer.appendChild(slotEl);
            }

            // Render Bank
            letters.forEach(l => {
                if(!slotsState.includes(l)) {
                    const tile = createTile(l);
                    tile.onclick = () => { addToFirstFreeSlot(l); };
                    bankContainer.appendChild(tile);
                }
            });

            if(emit && myTeamId) {
                const indices = slotsState.map(o => o ? o.id : null);
                socket.emit('speed:updateTeamBoard', { indices });
            }
        }

        function createTile(l) {
            const el = document.createElement('div');
            el.className = 'tile';
            el.innerText = l.char;
            return el;
        }

        function addToFirstFreeSlot(l) {
            const idx = slotsState.indexOf(null);
            if(idx !== -1) {
                slotsState[idx] = l;
                renderBoard(true);
            }
        }

        function removeFromSlot(idx) {
            slotsState[idx] = null;
            renderBoard(true);
        }

        function clearBoard() {
            slotsState.fill(null);
            renderBoard(true);
        }

        function submitWord() {
            const word = slotsState.filter(x => x).map(x => x.char).join('');
            if(word.length < 2) return;
            // אפקט לחיצה
            socket.emit('speed:submitWord', { word });
        }
    </script>
</body>
</html>
