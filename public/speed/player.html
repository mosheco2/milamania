<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ספיד מניה</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { 
            --bg: #2B1E4A; --tile: #fff; --accent: #FFD700; --primary: #F84779;
        }
        body { margin:0; background: var(--bg); color: white; font-family: "Varela Round", sans-serif; overflow: hidden; user-select: none; display: flex; flex-direction: column; height: 100dvh; }
        
        /* כניסה */
        #loginScreen, #waitScreen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .input-group { width: 100%; max-width: 300px; margin-bottom: 10px; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: none; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.9); }
        .btn-big { width: 100%; max-width: 300px; padding: 15px; border-radius: 50px; background: linear-gradient(135deg, var(--primary), #ff8e53); border: none; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(248, 71, 121, 0.4); margin-top: 10px; }
        .btn-big:active { transform: scale(0.98); }

        /* מסך משחק */
        #gameScreen { height: 100%; display: flex; flex-direction: column; }
        .top-bar { padding: 15px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(5px); }
        .score-box { font-size: 1.1rem; font-weight: bold; display: flex; gap: 10px; }
        .timer-badge { background: var(--primary); padding: 5px 12px; border-radius: 15px; font-variant-numeric: tabular-nums; }
        
        .words-area { flex: 1; margin: 10px; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 10px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start; border: 1px solid rgba(255,255,255,0.1); }
        .word-tag { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; animation: popIn 0.3s; font-size: 0.9rem; }

        /* אזור המשחק התחתון (מקובע למטה) */
        .play-area { 
            background: rgba(0,0,0,0.4); 
            border-radius: 25px 25px 0 0; 
            padding: 15px 10px 25px; 
            display: flex; flex-direction: column; gap: 15px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        
        /* סלוטים */
        .slots-container { display: flex; gap: 5px; justify-content: center; min-height: 55px; }
        .slot { width: 13vw; height: 13vw; max-width: 55px; max-height: 55px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        
        /* בנק אותיות */
        .bank-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; min-height: 60px; }
        
        /* אריח */
        .tile { 
            width: 13vw; height: 13vw; max-width: 55px; max-height: 55px; 
            background: var(--tile-bg); color: #2B1E4A; border-radius: 12px; 
            font-size: 1.6rem; font-weight: bold; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 0 #ccc; cursor: pointer; transition: transform 0.1s;
        }
        .tile:active { transform: scale(0.95); }

        /* כפתורים */
        .controls { display: flex; gap: 10px; height: 50px; }
        .btn-game { flex: 1; border: none; border-radius: 12px; font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-clear { background: #e74c3c; flex: 0.7; }
        .btn-submit { background: #2ecc71; flex: 2; font-weight: 800; }
        .btn-game:active { transform: translateY(3px); box-shadow: none; }

        .hidden { display: none !important; }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginScreen">
        <h1 style="color:var(--accent); font-size:2.5rem; margin-bottom:5px;">ספיד מניה ⚡</h1>
        <p style="opacity:0.8; margin-bottom:30px;">הצטרפות למשחק קבוצתי</p>
        
        <div class="input-group"><input type="text" id="pCode" placeholder="קוד משחק" style="text-transform:uppercase"></div>
        <div class="input-group"><input type="text" id="pName" placeholder="השם שלך"></div>
        <button class="btn-big" onclick="join()">הצטרף למשחק</button>
        <p id="statusMsg" style="color:#ff6b6b; margin-top:10px; font-size:0.9rem;"></p>
    </div>

    <!-- Wait -->
    <div id="waitScreen" class="hidden">
        <h2 style="color:var(--accent);" id="teamNameTitle"></h2>
        <p>ממתינים למנהל שיתחיל את הסיבוב...</p>
        <div style="font-size:3rem; margin-top:20px; animation: popIn 1s infinite alternate;">⏳</div>
    </div>

    <!-- Game -->
    <div id="gameScreen" class="hidden">
        <div class="top-bar">
            <div class="score-box">
                <i class="ph-bold ph-users"></i> <span id="teamNameDisplay"></span>
            </div>
            <div class="timer-badge" id="timer">60</div>
        </div>

        <div id="wordsArea" class="words-area">
            <div style="width:100%; text-align:center; opacity:0.5; margin-top:20px;">המילים יופיעו כאן...</div>
        </div>

        <div class="play-area">
            <div class="slots-container" id="slotsRow"></div>
            <div class="bank-container" id="bankRow"></div>
            <div class="controls">
                <button class="btn-game btn-clear" onclick="clearBoard()"><i class="ph-bold ph-x"></i></button>
                <button class="btn-game btn-submit" onclick="submit()">שלח <i class="ph-bold ph-paper-plane-right" style="margin-right:8px;"></i></button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket;
        let letters = [];
        let slotsState = Array(7).fill(null);
        let myTeamId = null;

        // חיבור בטוח
        try { if(typeof io !== 'undefined') socket = io(); else throw new Error(); } 
        catch(e) { console.warn("Mock Mode"); socket = { on:()=>{}, emit:()=>{} }; }

        // אוטומציה לפרמטרים ב-URL (תיקון שם המשתנה ל-urlParams)
        const urlParams = new URLSearchParams(location.search);
        if(urlParams.get('code')) document.getElementById('pCode').value = urlParams.get('code');
        if(urlParams.get('name')) document.getElementById('pName').value = urlParams.get('name');
        if(urlParams.get('name')) setTimeout(join, 500);

        function join() {
            const code = document.getElementById('pCode').value.toUpperCase();
            const name = document.getElementById('pName').value;
            const teamId = urlParams.get('teamId');
            
            if(!code || !name) {
                document.getElementById('statusMsg').innerText = "נא למלא קוד ושם";
                return;
            }
            socket.emit('speed:join', { code, name, teamId });
        }

        socket.on('speed:error', ({message}) => {
            document.getElementById('statusMsg').innerText = message;
        });

        socket.on('speed:joinedSuccess', ({ teamName, teamId, gameState, letters: existingLetters }) => {
            myTeamId = teamId;
            document.getElementById('teamNameTitle').innerText = teamName;
            document.getElementById('teamNameDisplay').innerText = teamName;
            
            document.getElementById('loginScreen').classList.add('hidden');
            
            if (gameState === 'playing' && existingLetters) {
                startRoundLogic(existingLetters, 60); 
            } else {
                document.getElementById('waitScreen').classList.remove('hidden');
            }
        });

        socket.on('speed:roundStart', ({ letters: l, duration }) => {
            startRoundLogic(l, duration);
        });

        function startRoundLogic(sLetters, duration) {
            letters = sLetters.map((c, i) => ({ char: c, id: i }));
            slotsState.fill(null);
            render();
            
            document.getElementById('waitScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('wordsArea').innerHTML = '';

            let sec = duration;
            const t = setInterval(() => {
                sec--;
                const timerEl = document.getElementById('timer');
                if(timerEl) timerEl.innerText = sec;
                if(sec<=0) clearInterval(t);
            }, 1000);
        }

        socket.on('speed:boardUpdated', ({ indices }) => {
            slotsState = indices.map(id => id !== null ? letters.find(l => l.id === id) : null);
            render(false);
        });

        socket.on('speed:wordAccepted', ({ word }) => {
            const tag = document.createElement('div');
            tag.className = 'word-tag';
            tag.innerText = word;
            const area = document.getElementById('wordsArea');
            area.appendChild(tag);
            area.scrollTop = area.scrollHeight;
            
            slotsState.fill(null);
            render(false);
        });

        function render(emit = true) {
            const slotsEl = document.getElementById('slotsRow');
            const bankEl = document.getElementById('bankRow');
            slotsEl.innerHTML = ''; bankEl.innerHTML = '';

            // Render Slots
            for(let i=0; i<7; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                if(slotsState[i]) {
                    const tile = createTile(slotsState[i]);
                    tile.onclick = () => { slotsState[i] = null; render(); };
                    slot.appendChild(tile);
                }
                slotsEl.appendChild(slot);
            }

            // Render Bank
            letters.forEach(l => {
                if(!slotsState.includes(l)) {
                    const tile = createTile(l);
                    tile.onclick = () => {
                        const idx = slotsState.indexOf(null);
                        if(idx !== -1) { slotsState[idx] = l; render(); }
                    };
                    bankEl.appendChild(tile);
                }
            });

            if(emit && myTeamId) {
                const indices = slotsState.map(o => o ? o.id : null);
                socket.emit('speed:updateTeamBoard', { indices });
            }
        }

        function createTile(l) {
            const d = document.createElement('div');
            d.className = 'tile';
            d.innerText = l.char;
            return d;
        }

        function clearBoard() { slotsState.fill(null); render(); }
        
        function submit() {
            const word = slotsState.filter(x => x).map(x => x.char).join('');
            if(word.length >= 2) socket.emit('speed:submitWord', { word });
        }
    </script>
</body>
</html>
