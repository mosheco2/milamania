<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×™×“ ×× ×™×” - × ×™×”×•×œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #2B1E4A; --accent: #FFD700; --panel-bg: #fff; }
        body { margin: 0; padding: 20px; background: radial-gradient(circle at center, #3a2a61, var(--bg-color)); color: #333; font-family: "Varela Round", sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header { text-align: center; color: white; margin-bottom: 20px; }
        .header img { height: 60px; }
        
        .card { background: var(--panel-bg); border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 700px; }
        
        h2 { margin-top: 0; color: var(--bg-color); }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 1.1rem; margin-top: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 15px; border-radius: 50px; border: none; font-size: 1.2rem; margin-top: 20px; background: linear-gradient(135deg, #F84779, #F7C948); color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { transform: scale(1.02); }
        
        /* ××–×•×¨ ×œ×•×‘×™ */
        .room-code-display { text-align: center; background: #f0f0f0; padding: 10px; border-radius: 10px; margin: 15px 0; }
        .code-big { font-size: 3rem; font-weight: 900; letter-spacing: 5px; color: #F84779; }
        
        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .team-box { background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .team-title { font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .player-list { font-size: 0.9rem; color: #666; min-height: 20px; }
        
        .wa-btn { background: #25D366; color: white; padding: 5px 10px; border-radius: 5px; text-decoration: none; font-size: 0.8rem; display: inline-block; margin-top: 5px; }

        /* ××¡×š ××©×—×§ */
        .timer-huge { font-size: 6rem; font-weight: 900; color: white; text-align: center; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .game-stats { text-align: center; color: #FFD700; font-size: 1.5rem; margin-top: 20px; }
        .live-feed { margin-top: 20px; color: white; text-align: center; font-size: 1.2rem; min-height: 30px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .hidden { display: none; }
        .btn-join-as-player { background: #2ecc71; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <img src="../m2.png" alt="×œ×•×’×•">
        <h1 style="margin:0;">×¡×¤×™×“ ×× ×™×” âš¡</h1>
    </div>

    <!-- 1. ×”×’×“×¨×•×ª -->
    <div id="setupScreen" class="card">
        <h2>×”×’×“×¨×•×ª ××©×—×§</h2>
        <label>×©× ×”×× ×”×œ</label>
        <input type="text" id="hostName" placeholder="×œ××©×œ: ×“× ×™">
        
        <div style="display:flex; gap:15px;">
            <div style="flex:1">
                <label>××¡×¤×¨ ×§×‘×•×¦×•×ª</label>
                <select id="teamCount">
                    <option value="2">2 ×§×‘×•×¦×•×ª</option>
                    <option value="3">3 ×§×‘×•×¦×•×ª</option>
                    <option value="4">4 ×§×‘×•×¦×•×ª</option>
                </select>
            </div>
            <div style="flex:1">
                <label>×–××Ÿ ×œ×¡×™×‘×•×‘ (×©× ×™×•×ª)</label>
                <input type="number" id="roundTime" value="60">
            </div>
        </div>

        <button onclick="createGame()">×¤×ª×— ×—×“×¨</button>
    </div>

    <!-- 2. ×œ×•×‘×™ -->
    <div id="lobbyScreen" class="card hidden">
        <div class="room-code-display">
            <div>×§×•×“ ×”×—×“×¨:</div>
            <div id="displayCode" class="code-big">---</div>
        </div>
        
        <h3>×§×‘×•×¦×•×ª ×•×©×—×§× ×™×:</h3>
        <div id="teamsContainer" class="teams-grid">
            <!-- ×§×‘×•×¦×•×ª ×™×™×•×•×¦×¨×• ×›××Ÿ -->
        </div>

        <button onclick="startGame()">×”×ª×—×œ ×¡×™×‘×•×‘! ğŸš€</button>
        <button class="btn-join-as-player" onclick="joinAsPlayer()">×”×¦×˜×¨×£ ×›×©×—×§×Ÿ ğŸ®</button>
    </div>

    <!-- 3. ××¡×š ××©×—×§ -->
    <div id="gameScreen" class="hidden">
        <div class="timer-huge" id="mainTimer">60</div>
        <div class="game-stats">
            ×¡×”"×› ××™×œ×™× ×©× ××¦××•: <span id="liveCount">0</span>
        </div>
        <div class="live-feed" id="liveFeed"></div>
        <div style="text-align:center; color:white; margin-top:20px;">
            ×”×©×—×§× ×™× ××©×—×§×™× ×›×¢×ª...
        </div>
    </div>

    <!-- 4. ×ª×•×¦××•×ª -->
    <div id="resultsScreen" class="card hidden">
        <h2 style="text-align:center; color:#F84779;">ğŸ† ×¡×™×›×•× ×¡×™×‘×•×‘</h2>
        <div id="leaderboard"></div>
        <button onclick="location.reload()">××©×—×§ ×—×“×©</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket;
        let myGameCode = null;

        try { if(typeof io !== 'undefined') socket = io(); else throw new Error(); } 
        catch(e) { console.warn("No Socket"); socket = { on:()=>{}, emit:()=>{} }; }

        function createGame() {
            const name = document.getElementById('hostName').value;
            const teams = document.getElementById('teamCount').value;
            const time = document.getElementById('roundTime').value;
            if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©×');
            
            socket.emit('speed:createGame', { 
                hostName: name, 
                teamCount: parseInt(teams),
                duration: parseInt(time)
            });
        }

        socket.on('speed:gameCreated', ({ gameCode, teams }) => {
            myGameCode = gameCode;
            document.getElementById('displayCode').textContent = gameCode;
            renderTeams(teams);
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.remove('hidden');
        });

        socket.on('speed:playerJoined', ({ teams }) => {
            renderTeams(teams);
        });

        function renderTeams(teams) {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            
            Object.values(teams).forEach(team => {
                const pNames = team.players.map(p => p.name).join(', ');
                // ×™×¦×™×¨×ª ×œ×™× ×§ ×œ×”×–×× ×”
                const inviteLink = `${window.location.origin}/speed/player.html?code=${myGameCode}&teamId=${team.id}`;
                const waText = `×”×™×™ ×§×‘×•×¦×ª ${team.name}! ×›× ×¡×• ×œ××©×—×§ ×›××Ÿ:\n${inviteLink}`;
                const waLink = `https://wa.me/?text=${encodeURIComponent(waText)}`;

                container.innerHTML += `
                    <div class="team-box">
                        <div class="team-title">
                            ${team.name}
                            <a href="${waLink}" target="_blank" class="wa-btn">×©×œ×— ×‘×•×•×¦××¤ ğŸ“²</a>
                        </div>
                        <div class="player-list">${pNames || '×××ª×™×Ÿ ×œ×©×—×§× ×™×...'}</div>
                    </div>
                `;
            });
        }

        function startGame() {
            socket.emit('speed:startGame', { code: myGameCode });
        }

        function joinAsPlayer() {
            if(!myGameCode) return;
            const name = document.getElementById('hostName').value;
            // ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×—×“×© ×œ××¡×š ×”×©×—×§×Ÿ ×¢× ×”×¤×¨×˜×™× ×›×‘×¨ ×‘×¤× ×™×
            window.open(`/speed/player.html?code=${myGameCode}&name=${encodeURIComponent(name)}`, '_blank');
        }

        socket.on('speed:roundStart', ({ duration }) => {
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            let sec = duration;
            const t = setInterval(() => {
                sec--;
                document.getElementById('mainTimer').textContent = sec;
                if(sec <= 0) clearInterval(t);
            }, 1000);
        });

        socket.on('speed:hostUpdate', ({ totalWords, recentWord, recentTeam }) => {
            document.getElementById('liveCount').textContent = totalWords;
            if(recentWord && recentTeam) {
                const feed = document.getElementById('liveFeed');
                feed.textContent = `${recentTeam} ××¦××• ××ª ×”××™×œ×”: ${recentWord}!`;
                setTimeout(() => feed.textContent = '', 3000);
            }
        });

        socket.on('speed:roundEnd', ({ leaderboard }) => {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            let html = '';
            leaderboard.forEach((t, i) => {
                html += `
                    <div style="background:#f9f9f9; padding:10px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span style="font-size:1.2rem; font-weight:bold;">#${i+1} ${t.name}</span>
                            <br><span style="font-size:0.9rem; color:#666;">××¦××• ${t.totalWords} ××™×œ×™×</span>
                        </div>
                        <div style="font-size:1.5rem; font-weight:bold; color:#F84779;">
                            ${t.score} × ×§'
                        </div>
                    </div>
                `;
            });
            document.getElementById('leaderboard').innerHTML = html;
        });
    </script>
</body>
</html>
