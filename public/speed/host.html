<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×¡×¤×™×“ ×× ×™×”</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --bg: #1a1a2e; --card: #fff; --primary: #F84779; }
        body { margin: 0; background: radial-gradient(circle, #2B1E4A, #1a1a2e); font-family: "Varela Round", sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Navigation */
        .nav { background: rgba(0,0,0,0.4); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-left { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; text-decoration: none; }
        
        .tabs { display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 30px; }
        .tab-btn { background: none; border: none; color: #ccc; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .card { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 900px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; }
        
        .info-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 900px; margin-bottom: 20px; color: white; }
        .code { font-size: 2.5rem; font-weight: 900; color: #FFD700; letter-spacing: 5px; }
        
        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; width: 100%; }
        .team-card { background: white; padding: 15px; border-radius: 15px; border-top: 5px solid #ccc; position: relative; }
        .score-badge { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .wa-btn { background: #25D366; color: white; text-decoration: none; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        
        /* Review Mode Styles */
        .review-word { display: inline-flex; align-items: center; gap: 5px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px; margin: 3px; cursor: pointer; border: 1px solid #ddd; }
        .review-word.rejected { background: #ffcccc; text-decoration: line-through; opacity: 0.6; }
        .review-word.approved { background: #ccffcc; border-color: #2ecc71; }

        iframe { width: 100%; height: 100%; border: none; border-radius: 15px; background: #2B1E4A; }
        .hidden { display: none !important; }
        
        .game-controls { display: flex; gap: 10px; align-items: center; }
        .btn-ctrl { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 0 #27ae60; }
        .timer { font-size: 1.5rem; font-weight: bold; font-variant-numeric: tabular-nums; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; }

        /* Floating Buttons (Manager-Player) */
        .fabs { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .fab { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .fab-help { background: #3498db; }
        .fab-manage { background: #F84779; }
    </style>
</head>
<body>

    <div class="nav">
        <div class="nav-left">
            <a href="/index.html" class="icon-btn" title="×”×‘×™×ª×”"><i class="ph-bold ph-house"></i></a>
            <a href="/instructions.html" target="_blank" class="icon-btn" title="×”×•×¨××•×ª"><i class="ph-bold ph-question"></i></a>
            <div style="font-weight:bold; font-size:1.2rem; margin-right:10px;">âš¡ ×¡×¤×™×“</div>
        </div>

        <div class="game-controls hidden" id="gameControls">
            <div class="timer" id="dTimer">00:00</div>
            <button class="btn-ctrl" id="btnStart" onclick="start()">â–¶ ×”×ª×—×œ</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('host')">ğŸ‘‘ × ×™×”×•×œ</button>
            <button class="tab-btn" onclick="setTab('player')">ğŸ® ×©×—×§×Ÿ</button>
        </div>
    </div>

    <div class="content">
        
        <!-- Host View -->
        <div id="view-host" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            
            <!-- Setup -->
            <div id="setup" class="card">
                <h2>×”×’×“×¨×•×ª ××©×—×§</h2>
                <label>×©× ×”×× ×”×œ</label><input type="text" id="hName" placeholder="×©×" style="width:100%; padding:10px; margin-bottom:10px;">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>×§×‘×•×¦×•×ª</label><select id="hTeams" style="width:100%; padding:10px;"><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                    <div style="flex:1"><label>×–××Ÿ</label><input type="number" id="hTime" value="60" style="width:100%; padding:10px;"></div>
                </div>
                <button onclick="create()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-size:1.2rem; margin-top:20px; cursor:pointer;">×¤×ª×— ×—×“×¨</button>
            </div>

            <!-- Dashboard / Review -->
            <div id="dashboard" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                
                <div id="reviewSection" class="card hidden" style="border:2px solid #F84779;">
                    <h2 style="text-align:center;">ğŸ›‘ ×–××Ÿ ×”×©×™×¤×•×˜!</h2>
                    <p style="text-align:center;">×œ×—×¥ ×¢×œ ××™×œ×™× ×©×’×•×™×•×ª ×›×“×™ ×œ×¤×¡×•×œ ××•×ª×Ÿ. ×‘×¡×™×•×, ×œ×—×¥ ×¢×œ "××©×¨ ×•×—×©×‘ × ×™×§×•×“".</p>
                    <div id="reviewGrid" class="teams-grid"></div>
                    <button onclick="finalizeRound()" style="width:100%; padding:15px; background:#2ecc71; color:white; border:none; border-radius:10px; font-size:1.2rem; margin-top:20px; cursor:pointer;">âœ… ××©×¨ ×•×—×©×‘ × ×™×§×•×“</button>
                </div>

                <div class="info-bar">
                    <div><span style="opacity:0.7">×§×•×“:</span><div class="code" id="dCode">---</div></div>
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:15px; display:flex; align-items:center; gap:10px;">
                        <span>×©×—×§:</span>
                        <select id="joinTeamSelect" style="margin:0; width:120px;"></select>
                        <button onclick="joinAsPlayer()" style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">×›× ×¡</button>
                    </div>
                </div>
                
                <div id="teamsGrid" class="teams-grid"></div>
            </div>
        </div>

        <!-- Player View -->
        <div id="view-player" class="hidden" style="width:100%; height:100%;">
            <iframe id="playerFrame" src="about:blank"></iframe>
            
            <!-- Floating Buttons for Host-Player -->
            <div class="fabs">
                <button class="fab fab-help" onclick="window.open('../instructions.html', '_blank')" title="×”×•×¨××•×ª"><i class="ph-bold ph-question"></i></button>
                <button class="fab fab-manage" onclick="setTab('host')" title="×—×–×•×¨ ×œ× ×™×”×•×œ"><i class="ph-bold ph-crown"></i></button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket, gameCode, hostName;
        let lastTeamsData = {}; // ×œ×©××™×¨×ª × ×ª×•× ×™× ×œ×©×™×¤×•×˜

        try { socket = io(); } catch(e) { socket = { on:()=>{}, emit:()=>{} }; }

        function setTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('view-host').classList.toggle('hidden', t !== 'host');
            document.getElementById('view-player').classList.toggle('hidden', t !== 'player');
        }

        function create() {
            hostName = document.getElementById('hName').value;
            if(!hostName) return alert('× × ×œ×”×–×™×Ÿ ×©×');
            socket.emit('speed:createGame', { hostName, teamCount: parseInt(document.getElementById('hTeams').value), duration: parseInt(document.getElementById('hTime').value) });
        }

        socket.on('speed:gameCreated', ({ gameCode: code, teams }) => {
            gameCode = code;
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('gameControls').classList.remove('hidden');
            document.getElementById('dCode').innerText = code;
            updateTeams(teams);
        });

        socket.on('speed:hostFullUpdate', ({ teams, state, timeLeft }) => {
            lastTeamsData = teams;
            updateTeams(teams);
            
            const timerEl = document.getElementById('dTimer');
            if(state === 'playing') {
                timerEl.innerText = timeLeft;
                document.getElementById('btnStart').disabled = true;
                document.getElementById('reviewSection').classList.add('hidden');
            } else if (state === 'review') {
                timerEl.innerText = "00:00";
                document.getElementById('reviewSection').classList.remove('hidden');
                renderReview(teams);
            } else {
                document.getElementById('btnStart').disabled = false;
            }
        });

        function updateTeams(teams) {
            const grid = document.getElementById('teamsGrid');
            const select = document.getElementById('joinTeamSelect');
            grid.innerHTML = '';
            
            if(select.children.length === 0) {
                Object.values(teams).forEach(t => select.innerHTML += `<option value="${t.id}">${t.name}</option>`);
            }

            Object.values(teams).forEach(t => {
                const players = t.players.map(p => p.name).join(', ');
                const link = `${window.location.origin}/speed/player.html?code=${gameCode}&teamId=${t.id}`;
                const waLink = `https://wa.me/?text=${encodeURIComponent('×‘×•××• ×œ×©×—×§ ×‘×§×‘×•×¦×” ×©×œ×™ ×‘×¡×¤×™×“-×× ×™×”! âš¡\n' + link)}`;

                grid.innerHTML += `
                    <div class="team-card" style="border-top-color:${t.color}">
                        <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                            <strong>${t.name}</strong>
                            <a href="${waLink}" target="_blank" class="wa-btn">×©×ª×£ <i class="ph-bold ph-whatsapp-logo"></i></a>
                        </div>
                        <div class="score-badge">${t.score}</div>
                        <div style="font-size:0.85rem; color:#555; margin-bottom:5px;"><strong>×©×—×§× ×™×:</strong> ${players || '××™×Ÿ'}</div>
                        <div style="font-size:0.85rem; color:#888;">××™×œ×™× ×©× ××¦××• ×›×¨×’×¢: ${t.foundWords.length}</div>
                    </div>
                `;
            });
        }

        // --- ×œ×•×’×™×§×ª ×©×™×¤×•×˜ ---
        function renderReview(teams) {
            const grid = document.getElementById('reviewGrid');
            grid.innerHTML = '';
            
            Object.values(teams).forEach(t => {
                let wordsHtml = t.foundWords.map((w, idx) => 
                    `<span class="review-word approved" onclick="toggleWord(this)" data-word="${w}">${w}</span>`
                ).join('');
                
                grid.innerHTML += `
                    <div class="team-card" data-teamid="${t.id}">
                        <strong>${t.name}</strong>
                        <div style="margin-top:10px; display:flex; flex-wrap:wrap;">${wordsHtml || '×œ× × ××¦××• ××™×œ×™×'}</div>
                    </div>
                `;
            });
            
            // ×× ×× ×—× ×• ×‘×˜××‘ ×©×—×§×Ÿ, × ×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ×× ×”×œ ×›×“×™ ×œ×©×¤×•×˜
            if(!document.getElementById('view-player').classList.contains('hidden')) {
                setTab('host');
            }
        }

        window.toggleWord = function(el) {
            if(el.classList.contains('approved')) {
                el.classList.remove('approved');
                el.classList.add('rejected');
            } else {
                el.classList.remove('rejected');
                el.classList.add('approved');
            }
        }

        window.finalizeRound = function() {
            const approvedWordsByTeam = {};
            
            document.querySelectorAll('#reviewGrid .team-card').forEach(card => {
                const teamId = card.dataset.teamid;
                const words = [];
                card.querySelectorAll('.review-word.approved').forEach(w => words.push(w.dataset.word));
                approvedWordsByTeam[teamId] = words;
            });

            socket.emit('speed:finalizeRound', { code: gameCode, approvedWordsByTeam });
            document.getElementById('reviewSection').classList.add('hidden');
        }

        // --------------------

        function start() { socket.emit('speed:startGame', { code: gameCode }); }

        function joinAsPlayer() {
            const teamId = document.getElementById('joinTeamSelect').value;
            document.getElementById('playerFrame').src = `player.html?code=${gameCode}&name=${encodeURIComponent(hostName + ' (×)')}&teamId=${teamId}`;
            setTab('player');
        }
        
        setInterval(() => { if(gameCode) socket.emit('speed:getHostState', { code: gameCode }); }, 3000);
    </script>
</body>
</html>
