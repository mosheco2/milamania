<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>×¡×¤×™×“ ×× ×™×” - ×©×—×§×Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #2B1E4A; --accent: #FFD700; --tile: #fff; }
        * { box-sizing: border-box; font-family: "Varela Round", sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin:0; background: var(--bg-color); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .screen { padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        input, button { padding: 15px; border-radius: 12px; border: none; font-size: 1.2rem; margin: 10px 0; width: 100%; }
        button { background: linear-gradient(135deg, #F84779, #F7C948); font-weight: bold; cursor: pointer; }
        
        /* ××©×—×§ */
        .top-bar { padding: 10px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); }
        .word-slot { background: rgba(0,0,0,0.3); height: 60px; margin: 10px; border-radius: 10px; display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 1.5rem; font-weight: bold; }
        .tile { width: 40px; height: 40px; background: var(--tile); color: var(--bg-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        
        .keyboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; padding: 10px; }
        .key { width: 50px; height: 50px; background: var(--tile); color: var(--bg-color); border-radius: 10px; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px #ccc; cursor: pointer; }
        .key.used { opacity: 0.3; transform: scale(0.9); box-shadow: none; background: #aaa; }
        
        .controls { display: flex; gap: 10px; padding: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen">
        <img src="../m2.png" height="60" style="object-fit:contain; margin-bottom:20px;" onerror="this.style.display='none'">
        <h2 style="margin:0; color:var(--accent);">×¡×¤×™×“ ×× ×™×” âš¡</h2>
        <input type="text" id="pGameCode" placeholder="×§×•×“ ××©×—×§" style="text-transform:uppercase">
        <input type="text" id="pName" placeholder="×”×©× ×©×œ×š">
        <button onclick="joinGame()">×›× ×¡ ×œ××©×—×§</button>
    </div>

    <div id="waitingScreen" class="screen hidden">
        <h1>â³ ×××ª×™×Ÿ...</h1>
        <p>×”××©×—×§ ×™×ª×—×™×œ ×‘×§×¨×•×‘</p>
    </div>

    <div id="gameScreen" class="hidden" style="height:100%; justify-content: flex-start;">
        <div class="top-bar">
            <span>â³ <span id="timer">60</span></span>
            <span>××™×œ×™×: <span id="score">0</span></span>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:10px;">
            <div id="foundWords" style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center;"></div>
        </div>

        <div id="currentWord" class="word-slot" onclick="clearWord()"></div>

        <div id="keyboard" class="keyboard"></div>

        <div class="controls">
            <button onclick="clearWord()" style="background:#e74c3c; flex:1;">âŒ</button>
            <button onclick="shuffle()" style="background:#3498db; flex:1;">ğŸ”€</button>
            <button onclick="submitWord()" style="background:#2ecc71; flex:2;">×©×œ×— âœ…</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        let socket;
        let letters = [];
        let currentSelection = []; 
        let foundWords = new Set();

        try {
            if (typeof io !== 'undefined') {
                socket = io();
            } else {
                throw new Error("Socket.io not found");
            }
        } catch (e) {
            console.warn("Socket.io missing. Running in Mock Mode.");
            socket = { on: (e,c)=>{}, emit: (e,d)=>console.log(e,d) };
        }

        function joinGame() {
            const code = document.getElementById('pGameCode').value.toUpperCase();
            const name = document.getElementById('pName').value;
            if(!code || !name) return alert('×—×¡×¨×™× ×¤×¨×˜×™×');
            socket.emit('speed:join', { code, name });
        }

        if (typeof io !== 'undefined') {
            socket.on('speed:joinedSuccess', () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('waitingScreen').classList.remove('hidden');
            });
            
            socket.on('speed:error', ({message}) => alert(message));

            socket.on('speed:roundStart', ({ letters: sLetters, duration }) => {
                letters = sLetters.map((char, i) => ({ char, id: i }));
                document.getElementById('waitingScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                renderKeyboard();
                
                let sec = duration;
                const t = setInterval(() => {
                    sec--;
                    document.getElementById('timer').textContent = sec;
                    if(sec <= 0) clearInterval(t);
                }, 1000);
            });

            socket.on('speed:roundEnd', () => {
                alert("× ×’××¨ ×”×–××Ÿ! ×‘×“×•×§ ××ª ×”××¡×š ×”×¨××©×™ ×œ×ª×•×¦××•×ª.");
                location.reload();
            });
        }

        function renderKeyboard() {
            const board = document.getElementById('keyboard');
            board.innerHTML = '';
            letters.forEach(l => {
                const div = document.createElement('div');
                div.className = 'key' + (currentSelection.includes(l.id) ? ' used' : '');
                div.textContent = l.char;
                div.onclick = () => { if(!currentSelection.includes(l.id)) { currentSelection.push(l.id); updateUI(); }};
                board.appendChild(div);
            });
        }

        function updateUI() {
            renderKeyboard();
            const slot = document.getElementById('currentWord');
            slot.innerHTML = currentSelection.map(id => {
                const char = letters.find(l => l.id === id).char;
                return `<div class="tile">${char}</div>`;
            }).join('');
        }

        function clearWord() { currentSelection = []; updateUI(); }
        
        function shuffle() { 
            letters.sort(() => Math.random() - 0.5); 
            updateUI(); 
        }

        function submitWord() {
            if(currentSelection.length < 2) return;
            const word = currentSelection.map(id => letters.find(l => l.id === id).char).join('');
            
            if(foundWords.has(word)) {
                clearWord(); return;
            }

            socket.emit('speed:submitWord', { word });
            foundWords.add(word);
            
            const tag = document.createElement('span');
            tag.style.cssText = "background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:5px; font-size:0.9rem;";
            tag.textContent = word;
            document.getElementById('foundWords').appendChild(tag);
            document.getElementById('score').textContent = foundWords.size;
            
            clearWord();
        }
    </script>
</body>
</html>
