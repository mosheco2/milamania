<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” Â· ××¡×š ××¦×™×’ ğŸ“º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ×¤×•× ×˜ ×ª×•×× ×œ×›×œ ×”××¢×¨×›×ª -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root {
      font-size: 16px;
    }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #FFF0F5 0, #FFF8EA 45%, #EAFBFF 100%);
      color: #1E1638;
      min-height: 100vh;
    }

    .app {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 26px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(43, 30, 74, 0.08);
      margin-bottom: 16px;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #6B618F;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(43, 30, 74, 0.22);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 1rem;
    }

    input:focus {
      outline: none;
      border-color: #F84779;
      box-shadow: 0 0 0 1px rgba(248, 71, 121, 0.55);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row > div {
      flex: 1 1 220px;
    }

    .btn {
      border-radius: 999px;
      padding: 10px 18px;
      border: none;
      cursor: pointer;
      font-size: 0.98rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #F84779, #F6A21E);
      color: #FFFFFF;
      box-shadow: 0 12px 26px rgba(248, 71, 121, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(248, 71, 121, 0.5);
    }
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 7px 20px rgba(248, 71, 121, 0.4);
    }
    .btn-ghost {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 999px;
      border: 1px solid rgba(43, 30, 74, 0.18);
      color: #2B1E4A;
      padding: 7px 12px;
      font-size: 0.86rem;
    }
    .btn-ghost:hover {
      background: #FFFFFF;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 0.82rem;
    }

    .status-text {
      font-size: 0.9rem;
      color: #7C7598;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(180, 169, 214, 0.7);
      font-size: 0.8rem;
      color: #58457F;
      gap: 6px;
      background: radial-gradient(circle at top left,
        rgba(248, 71, 121, 0.18),
        rgba(255, 255, 255, 0.96));
      margin-bottom: 4px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .page-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-small {
      height: 54px;
      width: auto;
      border-radius: 16px;
      object-fit: contain;
      background: #FFFFFF;
      padding: 4px 8px;
      border: 1px solid rgba(180, 169, 214, 0.65);
      box-shadow:
        0 0 0 3px #FFF8EA,
        0 10px 26px rgba(0,0,0,0.12);
    }

    .hidden {
      display: none !important;
    }

    /* ××–×•×¨ ×”××™×œ×” ×•×”×˜×™×™××¨ ×œ××¡×š ×’×“×•×œ */
    .presenter-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 1.5fr);
      gap: 18px;
      align-items: stretch;
    }

    .word-panel {
      background: linear-gradient(135deg, #241B4B, #3A265F);
      border-radius: 24px;
      padding: 18px 18px 24px;
      color: #FDF9FF;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 260px;
    }

    .word-label {
      font-size: 0.9rem;
      color: #C8BDF4;
      margin-bottom: 6px;
    }

    #currentWord {
      font-size: clamp(2rem, 6vw, 3.5rem);
      font-weight: 800;
      letter-spacing: 0.08em;
      text-align: center;
      margin: 8px 0 4px;
      text-transform: none;
      word-break: break-word;
    }

    #currentCategory {
      font-size: 0.95rem;
      text-align: center;
      color: #FCE58F;
      margin-bottom: 4px;
    }

    .team-explainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.95rem;
    }

    .team-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(252, 211, 77, 0.16);
      border: 1px solid rgba(252, 211, 77, 0.55);
      color: #FDE68A;
      font-size: 0.9rem;
    }

    .explainer-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.1);
      border: 1px solid rgba(226, 232, 240, 0.5);
      color: #E5E7EB;
      font-size: 0.9rem;
    }

    .timer-panel {
      background: radial-gradient(circle at top, #FDF2F8 0, #F5F3FF 45%, #ECFEFF 100%);
      border-radius: 24px;
      padding: 18px 18px 24px;
      border: 1px solid rgba(199, 210, 254, 0.8);
      box-shadow: 0 12px 30px rgba(129, 140, 248, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 260px;
    }

    .timer-label {
      font-size: 0.9rem;
      color: #4C1D95;
      margin-bottom: 4px;
    }

    #roundTimerPresenter {
      font-size: clamp(2.4rem, 6.4vw, 3.8rem);
      font-weight: 800;
      letter-spacing: 0.18em;
      color: #1F2937;
      text-align: center;
      margin: 12px 0 0;
    }

    #roundStateText {
      margin-top: 10px;
      font-size: 0.96rem;
      color: #4B5563;
      text-align: center;
    }

    #presenterBottomInfo {
      margin-top: 12px;
      font-size: 0.9rem;
      color: #6B7280;
      text-align: center;
    }

    #teamsSummary {
      margin-top: 6px;
      font-size: 0.9rem;
    }

    #presenter-banner-slot {
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .presenter-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 640px) {
      body {
        font-size: 1.05rem;
      }
      .app {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 18px 14px 20px;
        border-radius: 20px;
      }
      h1 {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª -->
    <div class="card">
      <div class="page-header">
        <div class="page-header-main">
          <img id="presenter-logo" class="logo-small hidden" alt="××™×œ×× ×™×” ×œ×•×’×•" />
          <div>
            <div class="chip">××™×œ×× ×™×” Â· ××¡×š ××¦×™×’ ğŸ“º</div>
            <h1 style="margin:4px 0 0; font-size:1.8rem;">×—×“×¨ ×”××¦×™×’</h1>
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" onclick="location.href='home.html'">â¬… ××¡×š ×”×‘×™×ª</button>
        </div>
      </div>
      <p class="status-text" style="margin-top:8px;">
        ××—×‘×¨×™× ××ª ×”××¡×š ×”×’×“×•×œ ×œ×—×“×¨ ×”××©×—×§. ×›××Ÿ ×™×•×¤×™×¢×• ×”××™×œ×” ×œ×¡×™×‘×•×‘, ×”×˜×™×™××¨, ×”×§×‘×•×¦×” ×•×”××¡×‘×™×¨.
      </p>
    </div>

    <!-- ×”×ª×—×‘×¨×•×ª ×›×—×“×¨ ××¦×™×’ -->
    <div class="card" id="connectCard">
      <h3 style="margin:0 0 8px;">×—×™×‘×•×¨ ×œ×—×“×¨ ××©×—×§</h3>
      <div class="row">
        <div>
          <label for="presenterGameCode">×§×•×“ ××©×—×§</label>
          <input id="presenterGameCode" type="text" placeholder="×œ×“×•×’××”: AB12" />
        </div>
        <div style="flex:0 0 170px; align-self:flex-end;">
          <button id="connectPresenterBtn" class="btn btn-primary" style="width:100%;">
            ×”×ª×—×‘×¨×•×ª ×›×—×“×¨ ××¦×™×’
          </button>
        </div>
      </div>
      <div id="connectStatus" class="status-text" style="margin-top:4px;"></div>
    </div>

    <!-- ×ª×¦×•×’×ª ××¦×™×’ -->
    <div class="card hidden" id="presenterCard">
      <div class="presenter-layout">
        <!-- ××™×œ×” -->
        <div class="word-panel">
          <div>
            <div class="word-label">×”××™×œ×” ×œ×¡×™×‘×•×‘</div>
            <div id="currentWord">×××ª×™×Ÿ ×œ×”×ª×—×œ×ª ×¡×™×‘×•×‘...</div>
            <div id="currentCategory"></div>
          </div>
          <div class="team-explainer">
            <div id="presenterTeamPill" class="team-pill hidden"></div>
            <div id="presenterExplainerPill" class="explainer-pill hidden"></div>
          </div>
        </div>

        <!-- ×˜×™×™××¨ ×•××¦×‘ ×¡×™×‘×•×‘ -->
        <div class="timer-panel">
          <div>
            <div class="timer-label">×˜×™×™××¨ ×¡×™×‘×•×‘</div>
            <div id="roundTimerPresenter">--:--</div>
          </div>
          <div id="roundStateText">
            ××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.
          </div>
          <div id="presenterBottomInfo">
            ×”×ª×—×‘×¨ ×œ×—×“×¨ ×‘×§×•×“ ×”××ª××™×. ×‘×¨×’×¢ ×©×× ×”×œ ×”××©×—×§ ×™×ª×—×™×œ ×¡×™×‘×•×‘ â€“ ×”×›×œ ×™×ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª.
          </div>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.45); margin:12px 0;" />

      <h3 style="margin:0 0 4px; font-size:0.98rem;">××¦×‘ ×”××©×—×§ (×ª×§×¦×™×¨)</h3>
      <div id="teamsSummary" class="status-text"></div>

      <div id="presenter-banner-slot"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const presenterLogoEl = document.getElementById("presenter-logo");
    const presenterBannerSlot = document.getElementById("presenter-banner-slot");

    const presenterGameCodeInput = document.getElementById("presenterGameCode");
    const connectPresenterBtn = document.getElementById("connectPresenterBtn");
    const connectStatusEl = document.getElementById("connectStatus");
    const connectCard = document.getElementById("connectCard");
    const presenterCard = document.getElementById("presenterCard");

    const currentWordEl = document.getElementById("currentWord");
    const currentCategoryEl = document.getElementById("currentCategory");
    const presenterTeamPill = document.getElementById("presenterTeamPill");
    const presenterExplainerPill = document.getElementById("presenterExplainerPill");

    const roundTimerPresenterEl = document.getElementById("roundTimerPresenter");
    const roundStateTextEl = document.getElementById("roundStateText");
    const presenterBottomInfoEl = document.getElementById("presenterBottomInfo");
    const teamsSummaryEl = document.getElementById("teamsSummary");

    let presenterGameCode = null;
    let lastGameState = null;

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds));
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = (s % 60).toString().padStart(2, "0");
      return `${m}:${ss}`;
    }

    function applyBranding() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          const logoCfg = data.logo;
          if (logoCfg && logoCfg.imageUrl && presenterLogoEl) {
            presenterLogoEl.src = logoCfg.imageUrl;
            presenterLogoEl.alt = logoCfg.altText || "××™×œ×× ×™×”";
            presenterLogoEl.classList.remove("hidden");
            presenterLogoEl.addEventListener("error", () => {
              presenterLogoEl.classList.add("hidden");
            });
          }

          if (!presenterBannerSlot) return;
          const cfg = data.presenter || data.display || null;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = cfg.altText || "Banner";
          img.style.maxWidth = "100%";
          img.style.borderRadius = "18px";
          img.style.display = "block";
          img.style.marginTop = "8px";

          img.addEventListener("error", () => {
            a.style.display = "none";
          });

          a.appendChild(img);
          presenterBannerSlot.appendChild(a);
        })
        .catch(() => {});
    }

    applyBranding();

    function renderPresenter(game) {
      lastGameState = game;

      if (!game || !presenterGameCode || game.code !== presenterGameCode) {
        roundStateTextEl.textContent = "×œ× × ××¦× ××©×—×§ ×¤×¢×™×œ ×¢× ×”×§×•×“ ×”×–×”.";
        roundTimerPresenterEl.textContent = "--:--";
        currentWordEl.textContent = "×××ª×™×Ÿ ×œ×”×ª×—×œ×ª ×¡×™×‘×•×‘...";
        currentCategoryEl.textContent = "";
        presenterTeamPill.classList.add("hidden");
        presenterExplainerPill.classList.add("hidden");
        teamsSummaryEl.textContent = "";
        return;
      }

      // ×ª×§×¦×™×¨ ×§×‘×•×¦×•×ª ×•× ×™×§×•×“
      if (game.teams) {
        const lines = Object.entries(game.teams).map(([teamId, team]) => {
          const name = team.name || `×§×‘×•×¦×” ${teamId}`;
          const score = team.score || 0;
          return `${name}: ${score} × ×§×•×“×•×ª`;
        });
        teamsSummaryEl.innerHTML = lines.join("<br/>");
      } else {
        teamsSummaryEl.textContent = "";
      }

      const round = game.currentRound || game.round || {};
      const isActive = !!round.isActive;
      const secondsLeft = typeof round.secondsLeft === "number"
        ? round.secondsLeft
        : null;

      const word =
        round.word ||
        game.currentWord ||
        game.word ||
        "";

      const category =
        round.category ||
        (game.currentWordCategory || game.category || "");

      const teamName =
        (round.teamId && game.teams && game.teams[round.teamId] &&
          (game.teams[round.teamId].name || `×§×‘×•×¦×” ${round.teamId}`)) ||
        round.teamName ||
        "";

      const explainerName = round.explainerName || "";

      if (word) {
        currentWordEl.textContent = word;
      } else if (isActive) {
        currentWordEl.textContent = "××™×œ×” ×‘×˜×¢×™× ×”...";
      } else {
        currentWordEl.textContent = "×××ª×™×Ÿ ×œ×”×ª×—×œ×ª ×¡×™×‘×•×‘...";
      }

      if (category) {
        currentCategoryEl.textContent = `×§×˜×’×•×¨×™×”: ${category}`;
      } else {
        currentCategoryEl.textContent = "";
      }

      if (teamName) {
        presenterTeamPill.textContent = `×§×‘×•×¦×”: ${teamName}`;
        presenterTeamPill.classList.remove("hidden");
      } else {
        presenterTeamPill.classList.add("hidden");
      }

      if (explainerName) {
        presenterExplainerPill.textContent = `××¡×‘×™×¨/×”: ${explainerName}`;
        presenterExplainerPill.classList.remove("hidden");
      } else {
        presenterExplainerPill.classList.add("hidden");
      }

      if (isActive) {
        roundStateTextEl.innerHTML =
          "×¡×™×‘×•×‘ ×¤×¢×™×œ! " +
          (teamName ? `×–×” ×ª×•×¨ ×”×§×‘×•×¦×” <strong>${teamName}</strong>. ` : "") +
          (explainerName ? `××¡×‘×™×¨/×”: <strong>${explainerName}</strong>.` : "");
        presenterBottomInfoEl.textContent =
          "×‘×¨×’×¢ ×©×”××™×œ×” ××ª×—×œ×¤×ª â€“ ×›×•×œ× ×¨×•××™× ×›××Ÿ ××ª ×”×¢×“×›×•×Ÿ ×‘×–××Ÿ ×××ª.";
      } else {
        roundStateTextEl.textContent = "××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
        presenterBottomInfoEl.textContent =
          "×”××™×œ×” ×”×‘××” ×ª×•×¤×™×¢ ×‘×¨×’×¢ ×©×× ×”×œ ×”××©×—×§ ×™×ª×—×™×œ ×¡×™×‘×•×‘ ×—×“×©.";
      }

      if (secondsLeft !== null && secondsLeft >= 0) {
        roundTimerPresenterEl.textContent = formatTime(secondsLeft);
      } else if (isActive) {
        roundTimerPresenterEl.textContent = "Â·Â·:Â·Â·";
      } else {
        roundTimerPresenterEl.textContent = "--:--";
      }
    }

    if (connectPresenterBtn) {
      connectPresenterBtn.addEventListener("click", () => {
        const rawCode = (presenterGameCodeInput.value || "").trim().toUpperCase();
        if (!rawCode || rawCode.length < 3) {
          connectStatusEl.textContent = "× × ×œ×”×–×™×Ÿ ×§×•×“ ××©×—×§ ×ª×§×™×Ÿ.";
          return;
        }

        presenterGameCode = rawCode;
        connectStatusEl.textContent = "×‘×•×“×§ ××ª ××¦×‘ ×”××©×—×§...";
        connectPresenterBtn.disabled = true;

        socket.emit("getGameState", { gameCode: presenterGameCode }, (resp) => {
          connectPresenterBtn.disabled = false;

          if (!resp || !resp.ok || !resp.game) {
            connectStatusEl.textContent =
              "×œ× × ××¦× ××©×—×§ ×¤×¢×™×œ ×¢× ×”×§×•×“ ×”×–×”. ×‘×“×•×§ ×¢× ×× ×”×œ ×”××©×—×§.";
            return;
          }

          connectStatusEl.textContent = `××—×•×‘×¨ ×œ×—×“×¨ ${presenterGameCode} ×›××¦×™×’.`;
          connectCard.classList.add("hidden");
          presenterCard.classList.remove("hidden");

          renderPresenter(resp.game);
        });
      });
    }

    socket.on("gameState", (game) => {
      if (!presenterGameCode || !game || game.code !== presenterGameCode) return;
      renderPresenter(game);
    });

    socket.on("gameUpdated", (game) => {
      if (!presenterGameCode || !game || game.code !== presenterGameCode) return;
      renderPresenter(game);
    });

    socket.on("gameEnded", (data) => {
      if (data && data.code && presenterGameCode && data.code !== presenterGameCode) return;
      roundStateTextEl.textContent = "×”××©×—×§ ×”×¡×ª×™×™×. ×ª×•×“×” ×©×©×™×—×§×ª×! ğŸ‰";
      roundTimerPresenterEl.textContent = "--:--";
      presenterBottomInfoEl.textContent =
        "× ×™×ª×Ÿ ×œ×—×‘×¨ ××ª ×”××¡×š ×œ××©×—×§ ×—×“×© ×¢×œ ×™×“×™ ×§×•×“ ×—×“×©.";
      currentWordEl.textContent = "×”××©×—×§ ×”×¡×ª×™×™×.";
      currentCategoryEl.textContent = "";
    });
  </script>
</body>
</html>
