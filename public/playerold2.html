<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - ××¡×š ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root { font-size: 16px; }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #FFF8EA;
      color: #2B1E4A;
      min-height: 100vh;
      font-size: 1rem;
      position: relative;
    }
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      z-index: -1;
    }
    body::before {
      top: -120px;
      left: -60px;
      background: radial-gradient(circle at center,
        rgba(248, 71, 121, 0.30),
        transparent 60%);
    }
    body::after {
      bottom: -140px;
      right: -40px;
      background: radial-gradient(circle at center,
        rgba(21, 196, 193, 0.28),
        transparent 60%);
    }

    .app {
      max-width: 900px;
      width: 100%;
      padding: 20px 14px 40px;
      margin: 0 auto;
    }
    .card {
      background: #FFFFFF;
      border-radius: 24px;
      padding: 18px 16px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(43, 30, 74, 0.06);
      margin-bottom: 16px;
    }

    h1, h2, h3 { margin-top: 0; }
    h1 { font-size: 1.6rem; }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #6B618F;
    }

    input, select {
      width: 100%;
      padding: 9px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43, 30, 74, 0.22);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 0.98rem;
    }
    input::placeholder { color: #B0A6CC; }
    input:focus, select:focus {
      outline: none;
      border-color: #F84779;
      box-shadow: 0 0 0 1px rgba(248, 71, 121, 0.55);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row > div { flex: 1 1 200px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #F84779, #F7C948);
      color: #2B1E4A;
      box-shadow: 0 10px 25px rgba(248, 71, 121, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(248, 71, 121, 0.5);
    }
    .btn-success {
      background: linear-gradient(135deg, #15C4C1, #2DD4BF);
      color: #083344;
      box-shadow: 0 10px 24px rgba(21, 196, 193, 0.35);
    }
    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(21, 196, 193, 0.5);
    }
    .btn-danger {
      background: linear-gradient(135deg, #EF4444, #F97373);
      color: #FFF7F7;
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(239, 68, 68, 0.5);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(107, 97, 143, 0.55);
      color: #6B618F;
    }
    .btn-ghost:hover { background: rgba(248, 249, 255, 0.9); }
    .btn-small { padding: 6px 10px; font-size: 0.82rem; }
    .btn-wide { width: 100%; }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(180, 169, 214, 0.7);
      font-size: 0.8rem;
      color: #58457F;
      gap: 6px;
      background: radial-gradient(circle at top left,
        rgba(248, 71, 121, 0.18),
        rgba(255, 255, 255, 0.96));
      margin-bottom: 4px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .page-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .logo-small {
      height: 52px;
      width: auto;
      border-radius: 16px;
      object-fit: contain;
      background: #FFFFFF;
      padding: 4px 8px;
      border: 1px solid rgba(180, 169, 214, 0.65);
      box-shadow: 0 0 0 3px #FFF8EA, 0 10px 26px rgba(0, 0, 0, 0.12);
    }

    .status-text {
      font-size: 0.9rem;
      color: #7C7598;
    }

    .hidden { display: none !important; }

    .team-block-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
      color: #433362;
    }

    #presenterWord {
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      margin: 10px 0 4px;
      letter-spacing: 0.03em;
      color: #2B1E4A;
    }
    #presenterCategory {
      text-align: center;
      font-size: 0.9rem;
      color: #A18CCF;
      margin-bottom: 10px;
    }

    .presenter-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 4px;
    }

    .team-players-list {
      font-size: 0.9rem;
    }

    #playerBigTimer {
      margin-top: 6px;
      font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #F84779;
      text-align: center;
    }

    @media (max-width: 640px) {
      body { font-size: 1.05rem; }
      .app { padding: 16px 10px 32px; }
      .card { padding: 18px 14px 20px; border-radius: 20px; }
      h1 { font-size: 1.5rem; }
      h3 { font-size: 1.1rem; }
      input, select { font-size: 1rem; }
      .btn { font-size: 1rem; padding: 10px 16px; }
      #presenterWord { font-size: 2.1rem; }
      #playerBigTimer { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” -->
    <div class="card">
      <div class="page-header">
        <div class="page-header-main">
          <img id="playerLogo" class="logo-small hidden" alt="××™×œ×× ×™×” ×œ×•×’×•" />
          <div>
            <div class="chip">××™×œ×× ×™×” Â· ××¡×š ×©×—×§×Ÿ ğŸ®</div>
            <h1 style="margin:4px 0 0;">×‘×¨×•×›×™× ×”×‘××™× ×œ××©×—×§</h1>
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-ghost btn-small" type="button" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" type="button" onclick="location.href='home.html'">â¬… ××¡×š ×”×‘×™×ª</button>
        </div>
      </div>

      <p class="status-text" style="margin-top:8px;">
        ××¦×˜×¨×¤×™× ×œ×—×“×¨ ×¢× ×§×•×“ ×”××©×—×§, ×‘×•×—×¨×™× ×©× ××¦×—×™×§, ×•× ×›× ×¡×™× ×œ×§×‘×•×¦×” ×©×”×•×’×“×¨×” ×œ×›× ×¢×œ ×™×“×™ ×× ×”×œ ×”××©×—×§ ğŸ˜„
      </p>
    </div>

    <!-- ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
    <div class="card" id="joinSection">
      <h3 style="margin:0 0 8px;">×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h3>

      <div id="inviteInfo" class="status-text" style="margin-bottom:8px; display:none;"></div>

      <div class="row">
        <div>
          <label for="gameCodeInput">×§×•×“ ××©×—×§</label>
          <input id="gameCodeInput" type="text" placeholder="×œ×“×•×’××”: AB12" />
        </div>
        <div>
          <label for="playerNameInput">×”×©× ×©×œ×š ×‘××©×—×§</label>
          <input id="playerNameInput" type="text" placeholder="×œ×“×•×’××”: ×¡×•×¤×¨-××™×œ×•×œ×Ÿ" />
        </div>
      </div>

      <div class="row" id="teamChoiceRow" style="display:none;">
        <div>
          <label for="teamSelect">×”×§×‘×•×¦×” ×©×œ×š</label>
          <select id="teamSelect">
            <option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>
          </select>
        </div>
      </div>

      <button id="joinBtn" class="btn btn-primary" type="button">×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</button>

      <div id="joinStatus" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ××—×¨×™ ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
    <div class="card hidden" id="playerGameCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <h3 style="margin:0 0 6px;">××¦×‘ ×”××©×—×§ ×©×œ×™</h3>
        <div style="display:flex; gap:6px;">
          <button id="backToHostBtn" class="btn btn-ghost btn-small hidden" type="button">
            â¬… ×—×–×¨×” ×œ××¡×š × ×™×”×•×œ
          </button>
          <button id="exitGameBtn" class="btn btn-danger btn-small" type="button">
            ×™×¦×™××” ××”××©×—×§
          </button>
        </div>
      </div>

      <div id="myGameInfo" class="status-text" style="margin-bottom:8px;"></div>

      <div style="margin-bottom:8px;">
        <div class="team-block-title">×”×§×‘×•×¦×” ×©×œ×™</div>
        <div id="myTeamName" class="status-text"></div>
      </div>

      <div style="margin-bottom:8px;">
        <div class="team-block-title">×”×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×™</div>
        <div id="myTeamPlayers" class="team-players-list status-text"></div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

      <h3 style="margin:0 0 6px;">× ×™×§×•×“ ×›×œ×œ×™</h3>
      <div id="scoreboard" class="status-text"></div>

      <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

      <h3 style="margin:0 0 6px;">××¦×‘ ×”×¡×™×‘×•×‘</h3>
      <div id="roundStatusPlayer" class="status-text"></div>
      <div id="playerBigTimer">×˜×™×™××¨: --:--</div>

      <!-- ××¡×š ××¦×™×’ ×œ××¡×‘×™×¨ -->
      <div id="presenterSection" class="hidden" style="margin-top:12px; padding-top:8px; border-top:1px dashed rgba(180,169,214,0.6);">
        <div class="team-block-title" style="text-align:center; margin-bottom:4px;">
          ××ª×” ×”××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”! ğŸ—£ï¸
        </div>
        <div id="presenterWord">××™×œ×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>
        <div id="presenterCategory"></div>
        <div class="presenter-actions">
          <button id="btnCorrect" class="btn btn-success" type="button">âœ… × ×›×•×Ÿ</button>
          <button id="btnSkip" class="btn btn-primary" type="button">â­ ×“×œ×’ (××™× ×•×¡ × ×§×•×“×”)</button>
        </div>
        <div class="status-text" style="margin-top:6px; text-align:center;">
          ×›×œ "× ×›×•×Ÿ" ××•×¡×™×£ × ×§×•×“×”, ×›×œ "×“×œ×’" ××•×¨×™×“ × ×§×•×“×” (×œ× ×™×•×¨×“×™× ××ª×—×ª ×œÖ¾0). ×”××™×œ×” ×ª×ª×—×œ×£ ××•×˜×•××˜×™×ª ×‘×›×œ ×œ×—×™×¦×”.
        </div>
      </div>

</div>
      <div id="player-banner-slot" style="margin-top:10px;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const LOCAL_PLAYER_KEY = "millmania-player-join";

    const gameCodeInput = document.getElementById("gameCodeInput");
    const playerNameInput = document.getElementById("playerNameInput");
    const joinBtn = document.getElementById("joinBtn");
    const joinStatus = document.getElementById("joinStatus");
    const joinSection = document.getElementById("joinSection");
    const playerGameCard = document.getElementById("playerGameCard");

    const inviteInfo = document.getElementById("inviteInfo");
    const teamChoiceRow = document.getElementById("teamChoiceRow");
    const teamSelect = document.getElementById("teamSelect");

    const myGameInfo = document.getElementById("myGameInfo");
    const myTeamNameEl = document.getElementById("myTeamName");
    const myTeamPlayersEl = document.getElementById("myTeamPlayers");
    const scoreboardEl = document.getElementById("scoreboard");
    const roundStatusPlayerEl = document.getElementById("roundStatusPlayer");
    const playerBigTimerEl = document.getElementById("playerBigTimer");

    const playerLogoEl = document.getElementById("playerLogo");
    const playerBannerSlot = document.getElementById("player-banner-slot");

    const presenterSection = document.getElementById("presenterSection");
    const presenterWordEl = document.getElementById("presenterWord");
    const presenterCategoryEl = document.getElementById("presenterCategory");
    const btnCorrect = document.getElementById("btnCorrect");
    const btnSkip = document.getElementById("btnSkip");
    const exitGameBtn = document.getElementById("exitGameBtn");
    const backToHostBtn = document.getElementById("backToHostBtn");

    let myClientId = null;
    let currentGameCode = null;
    let myTeamId = null;
    let lastGameState = null;

    let currentWord = null;
    let currentCategory = "";
    let lastRoundKey = null;
    let iAmCurrentExplainer = false;

    const urlParams = new URLSearchParams(window.location.search);
    const hostModeFlag = urlParams.get("hostMode") === "1";

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = (s % 60).toString().padStart(2, "0");
      return m + ":" + ss;
    }

    (function loadPlayerBranding() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          if (data.logo && data.logo.imageUrl && playerLogoEl) {
            playerLogoEl.src = data.logo.imageUrl;
            playerLogoEl.alt = data.logo.altText || "××™×œ×× ×™×”";
            playerLogoEl.classList.remove("hidden");
            playerLogoEl.addEventListener("error", () => {
              playerLogoEl.classList.add("hidden");
            });
          }

          if (!playerBannerSlot) return;
          const cfg = data.player;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = cfg.altText || "Banner";
          img.style.maxWidth = "100%";
          img.style.borderRadius = "18px";
          img.style.display = "block";
          img.style.marginTop = "8px";

          img.addEventListener("error", () => {
            a.style.display = "none";
          });

          a.appendChild(img);
          playerBannerSlot.appendChild(a);
        })
        .catch(() => {});
    })();

    if (hostModeFlag && backToHostBtn) {
      backToHostBtn.classList.remove("hidden");
      backToHostBtn.addEventListener("click", () => {
        window.location.href = "host.html";
      });
    }
document.getElementById("hostControlsAsPlayer").classList.remove("hidden");
    
    function updatePresenterUI() {
      if (!iAmCurrentExplainer || !lastGameState || !lastGameState.currentRound) {
        presenterSection.classList.add("hidden");
        return;
      }

      presenterSection.classList.remove("hidden");

      if (!currentWord) {
        presenterWordEl.textContent = "×××ª×™×Ÿ ×œ××™×œ×” ××”×©×¨×ª...";
        presenterCategoryEl.textContent = "";
      } else {
        presenterWordEl.textContent = currentWord;
        presenterCategoryEl.textContent = currentCategory
          ? "×§×˜×’×•×¨×™×”: " + currentCategory
          : "";
      }
    }

    function requestNextWord() {
      if (!currentGameCode) return;
      socket.emit("getNextWord", { gameCode: currentGameCode }, (resp) => {
        if (!resp || !resp.ok) {
          presenterWordEl.textContent = resp && resp.error
            ? resp.error
            : "×©×’×™××” ×‘×˜×¢×™× ×ª ××™×œ×”.";
          presenterCategoryEl.textContent = "";
          return;
        }
        currentWord = resp.word || "";
        currentCategory = resp.category || "";
        updatePresenterUI();
      });
    }

    function renderGameStateForPlayer(game) {
      lastGameState = game;

      if (!myClientId || !game) {
        myGameInfo.textContent = "×¢×“×™×™×Ÿ ×œ× ××—×•×‘×¨ ×œ××©×—×§.";
        myTeamNameEl.textContent = "";
        myTeamPlayersEl.textContent = "";
        scoreboardEl.textContent = "";
        roundStatusPlayerEl.textContent = "";
        playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
        presenterSection.classList.add("hidden");
        return;
      }

      const playersMap = game.players || game.playersByClientId || {};
      const me = playersMap[myClientId];

      if (!me) {
        myGameInfo.textContent = "×œ× × ××¦××ª ×‘×¨×©×™××ª ×”×©×—×§× ×™×. ×™×™×ª×›×Ÿ ×©×”×•×¡×¨×ª ××”××©×—×§.";
        myTeamNameEl.textContent = "";
        myTeamPlayersEl.textContent = "";
        scoreboardEl.textContent = "";
        roundStatusPlayerEl.textContent = "";
        playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
        presenterSection.classList.add("hidden");
        return;
      }

      currentGameCode = game.code || currentGameCode;
      myTeamId = me.teamId || myTeamId;

      const team = game.teams && myTeamId ? game.teams[myTeamId] : null;
      const teamName = team ? (team.name || `×§×‘×•×¦×” ${myTeamId}`) : "×œ×œ× ×§×‘×•×¦×”";

      myGameInfo.innerHTML =
        `××ª×” ××—×•×‘×¨ ×œ×—×“×¨ ×‘×§×•×“ <strong>${currentGameCode || "-"}</strong> ×‘×©× <strong>${me.name || ""}</strong>.`;

      myTeamNameEl.textContent = teamName;

      if (team && team.players && team.players.length) {
        const names = team.players
          .map((cid) => (playersMap[cid] && playersMap[cid].name) ? playersMap[cid].name : null)
          .filter(Boolean);
        myTeamPlayersEl.textContent = names.length
          ? names.join(", ")
          : "××™×Ÿ ×¢×“×™×™×Ÿ ×©×—×§× ×™× × ×•×¡×¤×™× ×‘×§×‘×•×¦×” ×©×œ×š.";
      } else {
        myTeamPlayersEl.textContent = "×¢×“×™×™×Ÿ ×œ× ×”×•×§×¦×• ×©×—×§× ×™× ×œ×§×‘×•×¦×” ×©×œ×š.";
      }

      if (game.teams) {
        const lines = Object.entries(game.teams).map(([teamId, t]) => {
          const name = t.name || `×§×‘×•×¦×” ${teamId}`;
          const score = t.score || 0;
          return `${name}: ${score} × ×§×•×“×•×ª`;
        });
        scoreboardEl.innerHTML = lines.join("<br/>");
      } else {
        scoreboardEl.textContent = "";
      }

      const r = game.currentRound || game.round || null;
      if (r && (r.active === true || r.isActive === true)) {
        const roundSecondsLeft = typeof r.secondsLeft === "number"
          ? r.secondsLeft
          : null;
        const explainerName = r.explainerName || "";
        const explainerTeamId = r.teamId || "";
        const teamObj = explainerTeamId && game.teams ? game.teams[explainerTeamId] : null;
        const explainerTeamName = teamObj ? (teamObj.name || `×§×‘×•×¦×” ${explainerTeamId}`) : "";
        const explainerTeamText = explainerTeamName
          || (explainerTeamId ? `×§×‘×•×¦×” ${explainerTeamId}` : "");

        let msg = "×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
        if (explainerName && explainerTeamText) {
          msg = `×¢×›×©×™×• ××¡×‘×™×¨/×”: <strong>${explainerName}</strong> (${explainerTeamText}).`;
        } else if (explainerName) {
          msg = `×¢×›×©×™×• ××¡×‘×™×¨/×”: <strong>${explainerName}</strong>.`;
        }

        if (roundSecondsLeft !== null) {
          msg += ` Â· × ×©××¨×• ×›Ö¾${roundSecondsLeft} ×©× ×™×•×ª.`;
        }

        if (myTeamId && explainerTeamId && myTeamId === explainerTeamId) {
          msg += " ×–×” ×”×¡×™×‘×•×‘ ×©×œ ×”×§×‘×•×¦×” ×©×œ×š â€“ ×ª×¨×™××• ×œ×•/×œ×”! ğŸ¯";
        }

        if (typeof r.roundScore === "number") {
          msg += ` Â· × ×™×§×•×“ ×‘×¡×™×‘×•×‘: ${r.roundScore}`;
        }

        roundStatusPlayerEl.innerHTML = msg;

        if (roundSecondsLeft !== null) {
          playerBigTimerEl.textContent = "×˜×™×™××¨: " + formatTime(roundSecondsLeft);
        } else {
          playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
        }

        iAmCurrentExplainer = (r.explainerId && r.explainerId === myClientId);

        if (iAmCurrentExplainer) {
          const roundKey = String(r.startedAt || "") + "|" + String(r.teamId || "");
          if (roundKey !== lastRoundKey) {
            lastRoundKey = roundKey;
            currentWord = null;
            currentCategory = "";
          }
          if (!currentWord) {
            requestNextWord();
          } else {
            updatePresenterUI();
          }
        } else {
          presenterSection.classList.add("hidden");
        }
      } else {
        roundStatusPlayerEl.textContent =
          "×›×¨×’×¢ ××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ. ×—×›×• ×©×× ×”×œ ×”××©×—×§ ×™×ª×—×™×œ ×¡×™×‘×•×‘ ×—×“×©.";
        playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
        iAmCurrentExplainer = false;
        presenterSection.classList.add("hidden");
      }
    }

    joinBtn.addEventListener("click", () => {
      const rawCode = (gameCodeInput.value || "").trim().toUpperCase();
      const playerName = (playerNameInput.value || "").trim();

      if (!rawCode || rawCode.length < 3) {
        joinStatus.textContent = "× × ×œ×”×§×œ×™×“ ×§×•×“ ××©×—×§ ×ª×§×™×Ÿ.";
        return;
      }
      if (!playerName || playerName.length < 2) {
        joinStatus.textContent = "× × ×œ×‘×—×•×¨ ×©× ×œ×©×—×§×Ÿ (×œ×¤×—×•×ª 2 ×ª×•×•×™×).";
        return;
      }

      const gameCode = rawCode;

      let existingJoin = null;
      try {
        const raw = localStorage.getItem(LOCAL_PLAYER_KEY);
        existingJoin = raw ? JSON.parse(raw) : null;
      } catch (e) {
        existingJoin = null;
      }

      if (
        existingJoin &&
        existingJoin.gameCode === gameCode &&
        existingJoin.name &&
        existingJoin.name !== playerName
      ) {
        joinStatus.textContent =
          `×‘×“×¤×“×¤×Ÿ ×”×–×” ×›×‘×¨ ×”×¦×˜×¨×¤×ª ×œ××©×—×§ ${gameCode} ×‘×©× "${existingJoin.name}". ` +
          "××™ ××¤×©×¨ ×œ×”×¦×˜×¨×£ ×©×•×‘ ×œ××•×ª×• ××©×—×§ ×¢× ×©× ××—×¨ ×××•×ª×• ××›×©×™×¨.";
        return;
      }

      const payload = {
        gameCode,
        name: playerName,
        teamId: teamSelect.value || null,
      };

      joinStatus.textContent = "××¦×˜×¨×£ ×œ××©×—×§...";
      joinBtn.disabled = true;

      socket.emit("joinGame", payload, (resp) => {
        joinBtn.disabled = false;

        if (!resp || !resp.ok) {
          joinStatus.textContent =
            (resp && resp.error) ||
            "×œ× ×”×¦×œ×—× ×• ×œ×¦×¨×£ ××•×ª×š ×œ××©×—×§. ×‘×“×•×§ ××ª ×”×§×•×“ ×•× ×¡×” ×©×•×‘.";
          return;
        }

        try {
          localStorage.setItem(
            LOCAL_PLAYER_KEY,
            JSON.stringify({
              gameCode,
              name: playerName,
              joinedAt: Date.now(),
            })
          );
        } catch (e) {}

        joinStatus.textContent = "×”×¦×˜×¨×¤×ª ×‘×”×¦×œ×—×” ×œ××©×—×§!";
        myClientId = resp.clientId;
        currentGameCode = gameCode;
        myTeamId = resp.teamId || null;

        joinSection.classList.add("hidden");
        playerGameCard.classList.remove("hidden");

        if (resp.game) {
          renderGameStateForPlayer(resp.game);
        } else {
          socket.emit("getGameState", { gameCode }, (resp2) => {
            if (resp2 && resp2.ok && resp2.game) {
              renderGameStateForPlayer(resp2.game);
            }
          });
        }
      });
    });

    if (btnCorrect) {
      btnCorrect.addEventListener("click", () => {
        if (!currentGameCode || !iAmCurrentExplainer) return;
        socket.emit(
          "changeRoundScore",
          { gameCode: currentGameCode, delta: +1 },
          () => {
            requestNextWord();
          }
        );
      });
    }

    if (btnSkip) {
      btnSkip.addEventListener("click", () => {
        if (!currentGameCode || !iAmCurrentExplainer) return;
        socket.emit(
          "changeRoundScore",
          { gameCode: currentGameCode, delta: -1 },
          () => {
            requestNextWord();
          }
        );
      });
    }

    if (exitGameBtn) {
      exitGameBtn.addEventListener("click", () => {
        const ok = confirm("×œ×¦××ª ××”××©×—×§? ×ª×•×›×œ ×œ×”×¦×˜×¨×£ ×©×•×‘ ××—×¨ ×›×š ×¢× ××•×ª×• ×§×•×“.");
        if (!ok) return;
        window.location.href = "home.html";
      });
    }

    socket.on("gameUpdated", (game) => {
      if (!game || (currentGameCode && game.code && game.code !== currentGameCode)) {
        return;
      }
      renderGameStateForPlayer(game);
    });

    socket.on("gameState", (game) => {
      if (!game || (currentGameCode && game.code && game.code !== currentGameCode)) {
        return;
      }
      renderGameStateForPlayer(game);
    });

    socket.on("gameEnded", (data) => {
      if (data && data.code && currentGameCode && data.code !== currentGameCode) return;

      roundStatusPlayerEl.textContent = "×”××©×—×§ ×”×¡×ª×™×™×. ×ª×•×“×” ×©×©×™×—×§×ª×! ğŸ‰";
      playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
      iAmCurrentExplainer = false;
      presenterSection.classList.add("hidden");
    });

    socket.on("roundTimeUp", (data) => {
      if (!data) return;
      const score = typeof data.roundScore === "number" ? data.roundScore : 0;

      let msgLine;
      if (score <= 5) {
        msgLine = "××ª× ×¦×•×•×ª ×—×œ×©, ×›×“××™ ×©×ª×ª××× ×• ×™×•×ª×¨";
      } else if (score <= 10) {
        msgLine = "××ª× ×¦×•×•×ª × ×—××“, ×‘×˜×•×— ×©××ª× ×™×›×•×œ×™× ×™×•×ª×¨";
      } else {
        msgLine = "××ª× ×¦×•×•×ª ×¢×œ, ×”×©××¨×ª× ×œ×”× ××‘×§...";
      }

const tName = data.teamName || "×”×§×‘×•×¦×”";

alert(
  `â± × ×’××¨ ×”×–××Ÿ!\n\n${tName} ×¡×™×™××” ××ª ×”×¡×™×‘×•×‘!\n\n${msgLine}\n\n(× ×™×§×•×“ ×‘×¡×™×‘×•×‘: ${score})`
);
      playerBigTimerEl.textContent = "×˜×™×™××¨: --:--";
      iAmCurrentExplainer = false;
      presenterSection.classList.add("hidden");
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && currentGameCode) {
        socket.emit("getGameState", { gameCode: currentGameCode }, (resp) => {
          if (resp && resp.ok && resp.game) {
            renderGameStateForPlayer(resp.game);
          }
        });
      }
    });

    (function handleAutoJoinFromUrl() {
      const code = (urlParams.get("code") || "").toUpperCase();
      const name = urlParams.get("name") || "";
      const teamId = urlParams.get("teamId") || "";
      const autoJoin = urlParams.get("autoJoin") === "1";

      if (code) {
        gameCodeInput.value = code;
      }
      if (name) {
        playerNameInput.value = name;
      }
      if (teamId) {
        teamChoiceRow.style.display = "block";
        teamSelect.innerHTML = "";
        const opt = document.createElement("option")
opt.value = teamId;
opt.textContent = teamId;
        teamSelect.appendChild(opt);
        teamSelect.value = teamId;
        inviteInfo.style.display = "block";
        inviteInfo.textContent =
          `×§×™×‘×œ×ª ×”×–×× ×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×” "${teamId}".`;
      }

      if (autoJoin && code && name) {
        setTimeout(() => {
          joinBtn.click();
        }, 200);
      }
    })();
  </script>
</body>
</html>
