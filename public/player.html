<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×›×”× '×¡ - ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app {
      max-width: 480px;
      width: 100%;
      padding: 20px 16px 40px;
    }
    .card {
      background: #020617;
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow: 0 14px 35px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 16px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-bottom: 2px;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 10px 25px rgba(56,189,248,0.35);
      width: 100%;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(56,189,248,0.5);
    }
    .btn-success {
      background: #22c55e;
      color: #022c22;
      flex: 1;
    }
    .btn-warning {
      background: #fbbf24;
      color: #451a03;
      flex: 1;
    }
    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .hidden {
      display: none !important;
    }
    .status-text {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .big-word {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 8px 0 12px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.75rem;
      color: #9ca3af;
      gap: 6px;
    }
    .score-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.9rem;
    }
    .score-val {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .score-me {
      color: #22c55e;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="join-card">
      <h2 style="margin-bottom:8px;">×›×”× '×¡ - ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h2>
      <p style="margin:0 0 10px; font-size:0.85rem; color:#9ca3af;">
        ×§×‘×œ×• ××”×× ×”×œ ×§×•×“ ××©×—×§, ×‘×—×¨×• ×©× ×•×§×‘×•×¦×”, ×•×”×¦×˜×¨×¤×•.
      </p>
      <div style="margin-bottom:10px;">
        <label for="joinCode">×§×•×“ ××©×—×§</label>
        <input id="joinCode" type="text" placeholder="×œ×“×•×’××”: AB4F" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="playerName">×”×©× ×©×œ×š</label>
        <input id="playerName" type="text" placeholder="×œ×“×•×’××”: ××©×”" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="teamId">×œ××™×–×• ×§×‘×•×¦×” ××ª×” ××¦×˜×¨×£?</label>
        <select id="teamId">
          <option value="A">×§×‘×•×¦×” 1 (A)</option>
          <option value="B">×§×‘×•×¦×” 2 (B)</option>
          <option value="C">×§×‘×•×¦×” 3 (C)</option>
          <option value="D">×§×‘×•×¦×” 4 (D)</option>
          <option value="E">×§×‘×•×¦×” 5 (E)</option>
        </select>
      </div>
      <button id="joinBtn" class="btn btn-primary">×”×¦×˜×¨×£ ×œ××©×—×§</button>
      <p id="joinError" class="status-text" style="color:#f97373; margin-top:8px;"></p>
    </div>

    <div class="card hidden" id="player-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <h3 style="margin:0; font-size:1.1rem;">×›×”× '×¡ - ××©×—×§ ×¤×¢×™×œ</h3>
        <span class="tag">
          <span id="tagGameCode">×§×•×“: ----</span>
        </span>
      </div>
      <div class="status-text" id="playerInfo">
        ××—×›×” ×œ×”×ª×—×œ×ª ×”××©×—×§...
      </div>
    </div>

    <div class="card hidden" id="explainer-card">
      <div class="tag" style="margin-bottom:6px;">
        ××ª×” ×”××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”
      </div>
      <div class="big-word" id="currentWord">××™×œ×” ×ª×•×¤×™×¢ ×›××Ÿ</div>
      <div class="status-text" id="explainerHint">
        ××¡×•×¨ ×œ×•××¨ ××ª ×”××™×œ×” ×¢×¦××”, ×—×œ×§×™× ××× ×” ××• ×œ×ª×¨×’× â€“ ×¨×§ ×œ×ª××¨ ×‘×¨××–×™×.
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button id="correctBtn" class="btn btn-success">âœ… × ×›×•×Ÿ</button>
        <button id="skipBtn" class="btn btn-warning">â­ ×“×™×œ×•×’</button>
      </div>
    </div>

    <div class="card hidden" id="round-status-card">
      <h3 style="margin:0 0 8px; font-size:1rem;">××¦×‘ ×¡×™×‘×•×‘</h3>
      <div class="status-text" id="roundStatus">××—×›×™× ×œ×”×ª×—×œ×ª ×¡×™×‘×•×‘...</div>
    </div>

    <div class="card hidden" id="score-card">
      <h3 style="margin:0 0 8px; font-size:1rem;">× ×™×§×•×“</h3>
      <div id="scoreboardDynamic"></div>
      <div class="status-text" id="scoreTarget" style="margin-top:6px;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const STORAGE_KEY = "cohens-player-state";

    let mySocketId = null;
    let joinedGameCode = null;
    let myName = null;
    let myTeamId = null;
    let isExplainer = false;
    let lastGameState = null;

    const joinCard = document.getElementById("join-card");
    const joinCodeInput = document.getElementById("joinCode");
    const playerNameInput = document.getElementById("playerName");
    const teamIdSelect = document.getElementById("teamId");
    const joinBtn = document.getElementById("joinBtn");
    const joinError = document.getElementById("joinError");

    const playerCard = document.getElementById("player-card");
    const tagGameCode = document.getElementById("tagGameCode");
    const playerInfo = document.getElementById("playerInfo");

    const explainerCard = document.getElementById("explainer-card");
    const currentWordEl = document.getElementById("currentWord");
    const explainerHint = document.getElementById("explainerHint");
    const correctBtn = document.getElementById("correctBtn");
    const skipBtn = document.getElementById("skipBtn");

    const roundStatusCard = document.getElementById("round-status-card");
    const roundStatus = document.getElementById("roundStatus");

    const scoreCard = document.getElementById("score-card");
    const scoreboardDynamic = document.getElementById("scoreboardDynamic");
    const scoreTarget = document.getElementById("scoreTarget");

    socket.on("connect", () => {
      mySocketId = socket.id;
    });

    // ××™×œ×•×™ ××•×˜×•××˜×™ ××”-localStorage
    (function prefillFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        if (!saved) return;
        if (saved.gameCode) joinCodeInput.value = saved.gameCode;
        if (saved.playerName) playerNameInput.value = saved.playerName;
        if (saved.teamId) teamIdSelect.value = saved.teamId;
      } catch (e) {
        // ××ª×¢×œ××™×
      }
    })();

    joinBtn.addEventListener("click", () => {
      joinError.textContent = "";
      const code = (joinCodeInput.value || "").trim().toUpperCase();
      const name = (playerNameInput.value || "").trim();
      const teamId = (teamIdSelect.value || "A").toUpperCase();

      if (!code) {
        joinError.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×§×•×“ ××©×—×§.";
        return;
      }
      if (!name) {
        joinError.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×©×.";
        return;
      }

      socket.emit("joinGame", {
        gameCode: code,
        playerName: name,
        teamId
      }, (res) => {
        if (!res || !res.ok) {
          joinError.textContent = (res && res.error) ? res.error : "×œ× ×”×¦×œ×—× ×• ×œ×”×¦×˜×¨×£ ×œ××©×—×§.";
          return;
        }

        joinedGameCode = res.gameCode;
        myName = name;
        myTeamId = teamId;
        lastGameState = res.game;

        // ×©××™×¨×” ×œ×˜×¢×™× ×” ××—×“×©
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            gameCode: joinedGameCode,
            playerName: myName,
            teamId: myTeamId
          }));
        } catch (e) {}

        joinCard.classList.add("hidden");
        playerCard.classList.remove("hidden");
        roundStatusCard.classList.remove("hidden");
        scoreCard.classList.remove("hidden");

        tagGameCode.textContent = "×§×•×“: " + joinedGameCode;
        renderScoresFromGame(res.game);
        updatePlayerInfo();
      });
    });

    function updatePlayerInfo() {
      if (!myName || !myTeamId || !lastGameState || !lastGameState.teams) {
        playerInfo.textContent = "××—×•×‘×¨ ×›-" + (myName || "×©×—×§×Ÿ") + ".";
        return;
      }
      const team = lastGameState.teams[myTeamId];
      const teamName = team ? team.name || ("×§×‘×•×¦×” " + myTeamId) : ("×§×‘×•×¦×” " + myTeamId);
      playerInfo.textContent = "××—×•×‘×¨ ×›-" + myName + " ×‘×§×‘×•×¦×” " + teamName + " (" + myTeamId + ").";
    }

    function renderScoresFromGame(game) {
      if (!game || !game.teams) return;
      lastGameState = game;

      const teams = game.teams;
      scoreboardDynamic.innerHTML = "";

      const ids = Object.keys(teams);
      ids.forEach(id => {
        const t = teams[id];
        const score = t.score || 0;

        const row = document.createElement("div");
        row.className = "score-row";

        const left = document.createElement("span");
        left.textContent = t.name || ("×§×‘×•×¦×” " + id);

        const right = document.createElement("span");
        right.className = "score-val";
        if (myTeamId === id) {
          right.classList.add("score-me");
        }
        right.textContent = score;

        row.appendChild(left);
        row.appendChild(right);
        scoreboardDynamic.appendChild(row);
      });

      if (game.targetScore) {
        scoreTarget.textContent = "××©×—×§ ×œ-" + game.targetScore + " × ×§×•×“×•×ª.";
      } else {
        scoreTarget.textContent = "";
      }

      updatePlayerInfo();
    }

    socket.on("gameUpdated", (game) => {
      if (!joinedGameCode || !game || game.code !== joinedGameCode) return;
      renderScoresFromGame(game);
    });

    socket.on("roundStarted", (payload) => {
      if (!joinedGameCode || !payload) return;

      if (!lastGameState) lastGameState = {};
      if (payload.teams) {
        lastGameState.teams = payload.teams;
      }
      if (payload.scores && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
      }
      if (payload.targetScore) {
        lastGameState.targetScore = payload.targetScore;
      }

      renderScoresFromGame(lastGameState);

      const isMyTeamTurn = (myTeamId === payload.teamId);
      isExplainer = (mySocketId && mySocketId === payload.explainerId);

      let txt = "×¡×™×‘×•×‘ ×”×ª×—×™×œ ×œ×§×‘×•×¦×” " + (lastGameState.teams?.[payload.teamId]?.name || payload.teamId) + ".";
      if (isMyTeamTurn) {
        txt += " ×–×” ×”×ª×•×¨ ×©×œ ×”×§×‘×•×¦×” ×©×œ×š.";
      } else {
        txt += " ×›×¨×’×¢ ×–×• ×§×‘×•×¦×” ××—×¨×ª.";
      }
      roundStatus.textContent = txt;

      if (isExplainer) {
        explainerCard.classList.remove("hidden");
        currentWordEl.textContent = "××™×œ×” × ×˜×¢× ×ª...";
        explainerHint.textContent = "××ª×” ×”××¡×‘×™×¨! ×”××ª×Ÿ ×œ××™×œ×” ×•×”×ª×—×œ ×œ×ª××¨ ×‘×œ×™ ×œ×•××¨ ××•×ª×”.";
      } else {
        explainerCard.classList.add("hidden");
      }
    });

    socket.on("wordForExplainer", (data) => {
      if (!isExplainer) return;
      if (!data || !data.word) return;
      currentWordEl.textContent = data.word;
    });

    socket.on("scoreUpdated", (payload) => {
      if (!payload) return;
      if (!lastGameState) lastGameState = {};
      if (payload.teams) {
        lastGameState.teams = payload.teams;
      }
      if (payload.scores && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
      }
      if (payload.targetScore) {
        lastGameState.targetScore = payload.targetScore;
      }
      renderScoresFromGame(lastGameState);
    });

    socket.on("roundEnded", (payload) => {
      let txt = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.";
      if (payload && payload.teamId && lastGameState && lastGameState.teams) {
        const teamName = lastGameState.teams[payload.teamId]?.name || payload.teamId;
        txt = "×”×¡×™×‘×•×‘ ×©×œ " + teamName + " ×”×¡×ª×™×™×.";
      }
      roundStatus.textContent = txt;
      isExplainer = false;
      explainerCard.classList.add("hidden");

      if (payload && payload.scores && lastGameState) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
        renderScoresFromGame(lastGameState);
      }
    });

    socket.on("gameEnded", (payload) => {
      if (!payload) return;

      if (!lastGameState) lastGameState = {};
      if (payload.teams) {
        lastGameState.teams = payload.teams;
      }
      if (payload.scores && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
      }
      renderScoresFromGame(lastGameState);

      let msg = "×”××©×—×§ ×”×¡×ª×™×™×.";
      if (payload.teams && payload.winnerTeamIds && payload.winnerTeamIds.length) {
        const names = payload.winnerTeamIds
          .map(id => payload.teams[id]?.name || ("×§×‘×•×¦×” " + id));
        if (names.length === 1) {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×›×œ ×”×›×‘×•×“ ×œ-" + names[0] + " ğŸš€";
        } else {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×ª×™×§×• ×‘×™×Ÿ: " + names.join(", ");
        }
      }
      roundStatus.textContent = msg;
      isExplainer = false;
      explainerCard.classList.add("hidden");

      // ×× ×§×™× ××ª ×”-localStorage ×›×“×™ ×©×”××©×—×§ ×”×‘× ×™×ª×—×™×œ × ×§×™
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    });

    correctBtn.addEventListener("click", () => {
      if (!isExplainer || !joinedGameCode) return;
      socket.emit("markCorrect", { gameCode: joinedGameCode });
    });

    skipBtn.addEventListener("click", () => {
      if (!isExplainer || !joinedGameCode) return;
      socket.emit("skipWord", { gameCode: joinedGameCode });
    });
  </script>
</body>
</html>
