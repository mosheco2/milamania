<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - ××¡×š ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root { font-size: 16px; }
    * { box-sizing: border-box; font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; background: #FFF8EA; color: #2B1E4A; min-height: 100vh; font-size: 1rem; position: relative; overflow-x: hidden; }
    body::before, body::after { content: ""; position: fixed; width: 300px; height: 300px; border-radius: 50%; z-index: -1; filter: blur(40px); opacity: 0.15; }
    body::before { top: -100px; left: -100px; background: radial-gradient(circle, #F84779 0%, transparent 70%); }
    body::after { bottom: -100px; right: -100px; background: radial-gradient(circle, #15C4C1 0%, transparent 70%); }

    .app { max-width: 600px; width: 100%; padding: 20px 16px 90px; margin: 0 auto; }
    .card { background: #FFFFFF; border-radius: 24px; padding: 24px 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); border: 1px solid rgba(43, 30, 74, 0.04); margin-bottom: 16px; transition: all 0.2s ease; }

    h1, h2, h3 { margin-top: 0; color: #2B1E4A; }
    h1 { font-size: 1.8rem; margin-bottom: 0.5rem; font-weight:800; }
    h3 { font-size: 1.2rem; margin-bottom: 1rem; font-weight:700; }

    label { display: block; margin-bottom: 8px; font-size: 0.95rem; color: #6B618F; font-weight: 700; }
    input, select { width: 100%; padding: 14px; border-radius: 18px; border: 2px solid rgba(43, 30, 74, 0.1); background: #FFFDF7; color: #2B1E4A; font-size: 1.1rem; transition: all 0.2s; text-align:center; font-weight:600; }
    input::placeholder { color: #B0A6CC; font-weight:400; }
    input:focus, select:focus { outline: none; border-color: #F84779; background: #fff; box-shadow: 0 4px 15px rgba(248, 71, 121, 0.15); }

    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .row > div { flex: 1 1 100%; }

    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 14px 24px; border-radius: 18px; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 800; transition: all 0.2s; white-space: nowrap; width: 100%; letter-spacing: 0.02em; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: linear-gradient(135deg, #F84779, #FF8566); color: #ffffff; box-shadow: 0 8px 25px rgba(248, 71, 121, 0.3); }
    .btn-success { background: linear-gradient(135deg, #15C4C1, #42E695); color: #ffffff; box-shadow: 0 8px 25px rgba(21, 196, 193, 0.3); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 2px solid currentColor; font-size:0.9rem; padding:8px 16px; width:auto; }
    .btn-ghost { background: transparent; color: #6B618F; border: 2px solid rgba(107, 97, 143, 0.2); padding: 8px 16px; font-size: 0.9rem; width:auto; border-radius:12px; }

    .chip { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 999px; background: rgba(248, 71, 121, 0.1); color: #F84779; font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .logo-small { height: 50px; width: auto; border-radius: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .status-text { font-size: 1rem; color: #6B618F; line-height: 1.5; }
    .hidden { display: none !important; }

    .data-block { background: #F8F7FF; padding: 14px 18px; border-radius: 18px; margin-bottom: 10px; }
    .data-label { font-size: 0.9rem; color: #A18CCF; margin-bottom: 4px; font-weight: 700; }
    .data-value { font-size: 1.1rem; color: #433362; font-weight: 700; }

    #presenterSection { background: linear-gradient(135deg, #FFFDF7, #FFF); border: 3px dashed #E2DCEF; border-radius: 24px; padding: 28px 20px; text-align: center; margin-top: 24px; }
    #presenterTitle { font-size: 1.2rem; color: #F84779; font-weight: 800; margin-bottom: 16px; }
    #presenterWord { font-size: 3rem; font-weight: 900; color: #2B1E4A; margin: 0 0 10px; line-height: 1.1; }
    #presenterCategory { display: inline-block; background: #E2DCEF; color: #6B618F; padding: 6px 16px; border-radius: 20px; font-size: 0.95rem; margin-bottom: 24px; font-weight:600; }
    .presenter-actions { display: flex; gap: 14px; }
    .presenter-actions .btn { flex: 1; padding: 18px; font-size: 1.2rem; }

    #playerBigTimer { font-size: 4rem; font-weight: 900; color: #F84779; text-align: center; line-height: 1; margin: 16px 0; font-variant-numeric: tabular-nums; }

    #adminFab { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #2B1E4A; color: #FFD76F; padding: 12px 24px; border-radius: 50px; font-weight: 700; box-shadow: 0 10px 25px rgba(43, 30, 74, 0.3); cursor: pointer; z-index: 100; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    #adminFab:active { transform: translateX(-50%) scale(0.95); }
    #adminFloatingPanel { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: #FFFFFF; border-radius: 24px; padding: 20px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); z-index: 99; border: 2px solid #E2DCEF; }
    .admin-panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .close-panel-btn { background:none; border:none; font-size:1.8rem; color:#6B618F; cursor:pointer; padding:4px; line-height:1; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(43, 30, 74, 0.7); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-box { background: #fff; width: 85%; max-width: 420px; border-radius: 28px; padding: 32px 24px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.3); transform: translateY(40px); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .modal-overlay.active .modal-box { transform: translateY(0); }
    .modal-title { font-size: 1.6rem; font-weight: 800; margin-bottom: 16px; color: #2B1E4A; }
    .modal-content { font-size: 1.1rem; color: #6B618F; margin-bottom: 28px; line-height: 1.6; }

    /* ×›×¤×ª×•×¨ ×ª××™×›×” ×¦×£ */
    #support-wa-btn {
        position: fixed; bottom: 24px; right: 24px; z-index: 101;
        background: #25D366; color: white; border-radius: 50px;
        padding: 12px 20px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 8px; cursor: pointer; text-decoration: none;
    }
    #support-wa-btn:hover { background: #1ebc57; transform: translateY(-2px); }

    @media (min-width: 640px) { .row > div { flex: 1 1 45%; } .btn { width: auto; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="page-header">
        <div style="display:flex; align-items:center; gap:12px;">
             <img id="playerLogo" class="logo-small hidden" alt="×œ×•×’×•" />
             <div><div class="chip" style="border:none; background: rgba(248, 71, 121, 0.1);">××¡×š ×©×—×§×Ÿ ğŸ®</div></div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost" onclick="location.href='home.html'">ğŸ  ×‘×™×ª</button>
        </div>
    </div>

    <div class="card" id="joinSection">
      <h1>×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h1>
      <p class="status-text" style="margin-bottom: 24px;">×”×›× ×™×¡×• ×§×•×“, ×‘×—×¨×• ×©× ××¦×—×™×§ ×•×›× ×¡×• ×œ×§×‘×•×¦×”!</p>
      <div id="inviteInfo" class="data-block" style="display:none; background:#F0EBFF; color:#58457F; font-weight:700; text-align:center;"></div>
      <div class="row">
        <div><label for="gameCodeInput">×§×•×“ ××©×—×§</label><input id="gameCodeInput" type="text" placeholder="AB12" style="text-transform:uppercase; letter-spacing:2px;" /></div>
        <div><label for="playerNameInput">×”×©× ×©×œ×š</label><input id="playerNameInput" type="text" placeholder="×œ×“×•×’××”: ×‘×•×‘×¡×¤×•×’" /></div>
      </div>
      <div class="row" id="teamChoiceRow" style="display:none;">
        <div><label for="teamSelect">×‘×—×™×¨×ª ×§×‘×•×¦×”</label><select id="teamSelect"><option value="">×˜×•×¢×Ÿ ×§×‘×•×¦×•×ª...</option></select></div>
      </div>
      <button id="joinBtn" class="btn btn-primary" type="button" style="margin-top:16px; font-size:1.2rem;">ğŸš€ ×›× ×™×¡×” ×œ××©×—×§</button>
      <div id="joinStatus" class="status-text" style="margin-top:16px; text-align:center; font-weight:700;"></div>
    </div>

    <div class="card hidden" id="playerGameCard" style="background:transparent; box-shadow:none; border:none; padding:0;">
      <div style="background:#fff; border-radius:24px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h1 style="margin:0;">×—×“×¨ ×”××©×—×§</h1>
            <button id="exitGameBtn" class="btn btn-danger" type="button">×™×¦×™××”</button>
          </div>
          <div class="data-block" style="background:#F8F7FF; color:#433362;" id="myGameInfo"></div>
          <div class="row">
              <div class="data-block" style="flex:1;"><div class="data-label">×”×§×‘×•×¦×” ×©×œ×™</div><div id="myTeamName" class="data-value"></div></div>
              <div class="data-block" style="flex:1.5;"><div class="data-label">×—×‘×¨×™ ×”×§×‘×•×¦×”</div><div id="myTeamPlayers" class="data-value" style="font-weight:400; font-size:1rem;"></div></div>
          </div>

          <div style="text-align:center; padding: 24px 0;">
              <div id="roundStatusPlayer" class="status-text" style="font-weight:700; font-size:1.2rem; color:#2B1E4A;"></div>
              <div id="playerBigTimer">--:--</div>
          </div>

          <div id="presenterSection" class="hidden">
            <div id="presenterTitle">××ª×” ×”××¡×‘×™×¨! ğŸ—£ï¸</div>
            <div id="presenterWord">...</div>
            <div id="presenterCategory">×˜×•×¢×Ÿ...</div>
            <div class="presenter-actions">
              <button id="btnSkip" class="btn btn-primary" style="background: #FFB4CB; color:#A11C4B; box-shadow:none;">â­ ×“×œ×’ (-1)</button>
              <button id="btnCorrect" class="btn btn-success" style="flex:1.5; font-size:1.3rem;">âœ… × ×›×•×Ÿ! (+1)</button>
            </div>
          </div>

          <hr style="border:none; border-top:2px dashed #E2DCEF; margin: 24px 0;" />
          <h3>×˜×‘×œ×ª × ×™×§×•×“</h3>
          <div id="scoreboard" class="data-block" style="font-family:monospace; white-space:pre-wrap; font-size:1.1rem;"></div>
          <button id="viewAllPlayersBtn" class="btn btn-ghost" style="width:100%; margin-top:8px;">ğŸ‘€ ×”×¦×’ ××ª ×›×œ ×”×©×—×§× ×™×</button>
          <div id="player-banner-slot" style="margin-top:24px; text-align:center;"></div>
      </div>
    </div>
  </div>

  <div id="adminFab" class="hidden"><span>ğŸ‘‘</span> × ×™×”×•×œ ×¡×‘×‘</div>
  <div id="adminFloatingPanel" class="hidden">
      <div class="admin-panel-header"><h3 style="margin:0;">× ×™×”×•×œ ×¡×‘×‘ ××”×™×¨</h3><button class="close-panel-btn" id="closeAdminPanel">Ã—</button></div>
      <div class="row" style="margin-bottom:16px;">
          <div style="flex:1.5;"><label for="floatTeamSelect">×§×‘×•×¦×”</label><select id="floatTeamSelect"></select></div>
          <div style="flex:1.5;"><label for="floatExplainerSelect">××¡×‘×™×¨/×”</label><select id="floatExplainerSelect"><option value="">××•×˜×•××˜×™</option></select></div>
          <div style="flex:1;"><label for="floatSeconds">×©× ×™×•×ª</label><input type="number" id="floatSeconds" value="60" min="10" max="300"></div>
      </div>
      <div style="display:flex; gap:12px;">
          <button id="floatStartBtn" class="btn btn-success" style="flex:2; font-size:1.1rem;">â–¶ ×”×ª×—×œ</button>
          <button id="floatStopBtn" class="btn btn-danger" style="flex:1;" disabled>â¹ ×¡×™×™×</button>
      </div>
  </div>

  <div class="modal-overlay" id="customModal">
      <div class="modal-box">
          <div class="modal-title" id="modalTitle"></div>
          <div class="modal-content" id="modalContent"></div>
          <button class="btn btn-primary" id="modalCloseBtn" style="width:100%; font-size:1.1rem;">×¡×’×•×¨</button>
      </div>
  </div>

  <div id="support-wa-btn" onclick="openSupportWhatsapp()">
      <span>ğŸ’¬ ×¢×–×¨×” ×•×ª××™×›×”</span>
  </div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const LOCAL_PLAYER_KEY = "millmania-player-join";

    const gameCodeInput = document.getElementById("gameCodeInput"), playerNameInput = document.getElementById("playerNameInput");
    const joinBtn = document.getElementById("joinBtn"), joinStatus = document.getElementById("joinStatus"), joinSection = document.getElementById("joinSection");
    const playerGameCard = document.getElementById("playerGameCard"), inviteInfo = document.getElementById("inviteInfo");
    const teamChoiceRow = document.getElementById("teamChoiceRow"), teamSelect = document.getElementById("teamSelect");
    const myGameInfo = document.getElementById("myGameInfo"), myTeamNameEl = document.getElementById("myTeamName"), myTeamPlayersEl = document.getElementById("myTeamPlayers");
    const scoreboardEl = document.getElementById("scoreboard"), roundStatusPlayerEl = document.getElementById("roundStatusPlayer"), playerBigTimerEl = document.getElementById("playerBigTimer");
    const playerLogoEl = document.getElementById("playerLogo"), playerBannerSlot = document.getElementById("player-banner-slot");
    const presenterSection = document.getElementById("presenterSection"), presenterWordEl = document.getElementById("presenterWord"), presenterCategoryEl = document.getElementById("presenterCategory");
    const btnCorrect = document.getElementById("btnCorrect"), btnSkip = document.getElementById("btnSkip"), exitGameBtn = document.getElementById("exitGameBtn");
    const adminFab = document.getElementById("adminFab"), adminFloatingPanel = document.getElementById("adminFloatingPanel"), closeAdminPanelBtn = document.getElementById("closeAdminPanel");
    const floatTeamSelect = document.getElementById("floatTeamSelect"), floatExplainerSelect = document.getElementById("floatExplainerSelect"), floatSecondsInput = document.getElementById("floatSeconds"), floatStartBtn = document.getElementById("floatStartBtn"), floatStopBtn = document.getElementById("floatStopBtn");
    const customModal = document.getElementById("customModal"), modalTitle = document.getElementById("modalTitle"), modalContent = document.getElementById("modalContent"), modalCloseBtn = document.getElementById("modalCloseBtn");
    const viewAllPlayersBtn = document.getElementById("viewAllPlayersBtn");

    let myClientId = null, currentGameCode = null, myTeamId = null, iAmHost = false, lastGameState = null;
    let currentWord = null, currentCategory = "", lastRoundKey = null, iAmCurrentExplainer = false, roundTimerInterval = null;

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = (s % 60).toString().padStart(2, "0");
      return m + ":" + ss;
    }

    function showModal(title, content) { modalTitle.textContent = title; modalContent.innerHTML = content; customModal.classList.add("active"); }
    modalCloseBtn.addEventListener("click", () => { customModal.classList.remove("active"); });

    function openSupportWhatsapp() {
        let text = "";
        if (currentGameCode && lastGameState) {
            let myName = playerNameInput.value || "×©×—×§×Ÿ";
            text = `×©×œ×•×, ×× ×™ ×¦×¨×™×š ×¢×–×¨×” ×‘××©×—×§ ××™×œ×× ×™×”.\n×§×•×“ ×—×“×¨: ${currentGameCode}\n×©× ×× ×”×œ: ${lastGameState.hostName}\n×©× ××©×ª××©: ${myName}`;
        } else {
            text = "×©×œ×•×, ×× ×™ ×¤×•× ×” ×‘× ×•×©× ×©××œ×”/×ª××™×›×” ×‘××™×œ×× ×™×”.";
        }
        window.open(`https://wa.me/972504000024?text=${encodeURIComponent(text)}`, '_blank');
    }

    viewAllPlayersBtn.addEventListener("click", () => {
        if(!lastGameState || !lastGameState.teams) return;
        let html = `<div style="text-align:right;">`;
        Object.values(lastGameState.teams).forEach(t => {
            const pNames = t.players.map(cid => lastGameState.playersByClientId[cid]?.name).filter(Boolean).join(", ");
            html += `<div style="margin-bottom:12px;">
                        <div style="font-weight:800; color:#2B1E4A; margin-bottom:4px;">${t.name} (${t.score})</div>
                        <div style="background:#F8F7FF; padding:8px; border-radius:8px; color:#6B618F; font-size:0.9rem;">${pNames || "××™×Ÿ ×©×—×§× ×™×"}</div>
                     </div>`;
        });
        html += `</div>`;
        showModal("×¨×©×™××ª ×§×‘×•×¦×•×ª ×•×©×—×§× ×™×", html);
    });

    adminFab.addEventListener("click", () => { adminFloatingPanel.classList.remove("hidden"); adminFab.classList.add("hidden"); populateFloatTeamSelect(); });
    closeAdminPanelBtn.addEventListener("click", () => { adminFloatingPanel.classList.add("hidden"); adminFab.classList.remove("hidden"); });

    function refreshFloatExplainerOptions() {
        const teamId = floatTeamSelect.value;
        floatExplainerSelect.innerHTML = '<option value="">××•×˜×•××˜×™</option>';
        if (!teamId || !lastGameState || !lastGameState.teams) return;
        const team = lastGameState.teams[teamId];
        const playersMap = lastGameState.playersByClientId || {};
        if (Array.isArray(team.players)) {
            team.players.forEach(cid => {
                const p = playersMap[cid];
                if(p) { const opt = document.createElement("option"); opt.value = cid; opt.textContent = p.name; floatExplainerSelect.appendChild(opt); }
            });
        }
    }
    floatTeamSelect.addEventListener("change", refreshFloatExplainerOptions);

    function populateFloatTeamSelect() {
        if (!lastGameState || !lastGameState.teams) return;
        floatTeamSelect.innerHTML = "";
        Object.entries(lastGameState.teams).forEach(([tid, team]) => {
            const opt = document.createElement("option"); opt.value = tid; opt.textContent = team.name || tid; floatTeamSelect.appendChild(opt);
        });
        if (lastGameState.currentRound && lastGameState.currentRound.teamId) {
             const teamIds = Object.keys(lastGameState.teams);
             const nextIdx = (teamIds.indexOf(lastGameState.currentRound.teamId) + 1) % teamIds.length;
             floatTeamSelect.value = teamIds[nextIdx];
        }
        refreshFloatExplainerOptions();
    }
    floatStartBtn.addEventListener("click", () => {
        if(!currentGameCode) return;
        socket.emit("startRound", {
            gameCode: currentGameCode,
            teamId: floatTeamSelect.value,
            explainerClientId: floatExplainerSelect.value,
            roundSeconds: parseInt(floatSecondsInput.value) || 60
        });
        adminFloatingPanel.classList.add("hidden"); adminFab.classList.remove("hidden");
    });
    floatStopBtn.addEventListener("click", () => { if(!currentGameCode) return; socket.emit("endRound", { gameCode: currentGameCode }); });

    function updatePresenterUI() {
      if (!iAmCurrentExplainer) { presenterSection.classList.add("hidden"); return; }
      presenterSection.classList.remove("hidden");
      if (!currentWord) { presenterWordEl.textContent = "×˜×•×¢×Ÿ ××™×œ×”..."; presenterCategoryEl.textContent = "..."; btnCorrect.disabled = true; btnSkip.disabled = true; }
      else {
        presenterWordEl.textContent = currentWord;
        const catMap = { general: '×›×œ×œ×™', animals:'×—×™×•×ª', food:'××•×›×œ', objects:'×—×¤×¦×™×', technology:'×˜×›× ×•×œ×•×’×™×”', family:'××©×¤×—×”', travel:'×˜×™×•×œ×™×', sports:'×¡×¤×•×¨×˜', entertainment:'×‘×™×“×•×¨', music:'××•×–×™×§×”', nature:'×˜×‘×¢', holidays:'×—×’×™×', school:'×œ×™××•×“×™×', work:'×¢×‘×•×“×”', hard:'×§×©×”' };
        presenterCategoryEl.textContent = catMap[currentCategory] || currentCategory || '×›×œ×œ×™';
        btnCorrect.disabled = false; btnSkip.disabled = false;
      }
    }
    function requestNextWord() {
      if (!currentGameCode) return; btnCorrect.disabled = true; btnSkip.disabled = true;
      socket.emit("getNextWord", { gameCode: currentGameCode }, (resp) => {
        if (resp && resp.ok) { currentWord = resp.word; currentCategory = resp.category; updatePresenterUI(); }
      });
    }

    function renderGameStateForPlayer(game) {
      lastGameState = game;
      if (!myClientId || !game) { resetPlayerState(); return; }
      const me = game.playersByClientId[myClientId];
      if (!me) { resetPlayerState(); joinStatus.textContent = "× ×•×ª×§×ª ××”××©×—×§."; return; }

      currentGameCode = game.code; myTeamId = me.teamId; iAmHost = me.isHost || false;
      if (iAmHost) adminFab.classList.remove("hidden"); else { adminFab.classList.add("hidden"); adminFloatingPanel.classList.add("hidden"); }

      const team = game.teams[myTeamId];
      myGameInfo.innerHTML = `××—×•×‘×¨ ×›-<strong>${me.name}</strong>`;
      myTeamNameEl.textContent = team ? (team.name || myTeamId) : "×œ×œ×";
      myTeamPlayersEl.textContent = team?.players.map(cid => game.playersByClientId[cid]?.name).filter(Boolean).join(", ") || "×œ×‘×“ ×‘×™× ×ª×™×™×...";
      scoreboardEl.innerHTML = Object.values(game.teams).map(t => `<div style="display:flex; justify-content:space-between;"><span>${t.name || t.id}</span><strong>${t.score}</strong></div>`).join("");

      clearInterval(roundTimerInterval);
      const r = game.currentRound;
      if (r && r.isActive) {
        floatStopBtn.disabled = false; floatStartBtn.disabled = true;
        const explainerTeamName = game.teams[r.teamId]?.name || r.teamId;
        let statusHtml = `×‘×¡×‘×‘: <strong>${explainerTeamName}</strong><br>××¡×‘×™×¨/×”: ${r.explainerName}<br>× ×™×§×•×“ ×‘×¡×‘×‘: ${r.roundScore}`;
        if(r.teamId === myTeamId) statusHtml += " <span style='color:#F84779; display:block; margin-top:4px;'>×”×§×‘×•×¦×” ×©×œ×š! ğŸ¯</span>";
        roundStatusPlayerEl.innerHTML = statusHtml;

        let secondsLeft = r.secondsLeft || 0;
        const updateTimer = () => { playerBigTimerEl.textContent = formatTime(secondsLeft); };
        updateTimer();
        if(secondsLeft > 0) roundTimerInterval = setInterval(() => { secondsLeft--; updateTimer(); if(secondsLeft <= 0) clearInterval(roundTimerInterval); }, 1000);

        iAmCurrentExplainer = (r.explainerId === myClientId);
        if (iAmCurrentExplainer) {
          const roundKey = r.startedAt + r.teamId;
          if (roundKey !== lastRoundKey) { lastRoundKey = roundKey; currentWord = null; requestNextWord(); } else { updatePresenterUI(); }
        } else { presenterSection.classList.add("hidden"); }
      } else {
        roundStatusPlayerEl.textContent = "×××ª×™×Ÿ ×œ×ª×—×™×œ×ª ×¡×‘×‘..."; playerBigTimerEl.textContent = "--:--"; iAmCurrentExplainer = false; presenterSection.classList.add("hidden"); floatStopBtn.disabled = true; floatStartBtn.disabled = false;
      }
    }

    function resetPlayerState() { playerGameCard.classList.add("hidden"); joinSection.classList.remove("hidden"); adminFab.classList.add("hidden"); localStorage.removeItem(LOCAL_PLAYER_KEY); myClientId = null; currentGameCode = null; iAmHost = false; }

    joinBtn.addEventListener("click", () => {
      const code = gameCodeInput.value.toUpperCase().trim(), name = playerNameInput.value.trim(), teamId = teamSelect.value;
      if (code.length < 3 || name.length < 2 || !teamId) { joinStatus.textContent = "× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™×"; return; }
      joinStatus.textContent = "××ª×—×‘×¨..."; joinBtn.disabled = true;
      socket.emit("joinGame", { gameCode: code, name, teamId }, (resp) => {
        joinBtn.disabled = false;
        if (!resp.ok) { joinStatus.textContent = resp.error; return; }
        myClientId = resp.clientId; iAmHost = resp.isHost;
        localStorage.setItem(LOCAL_PLAYER_KEY, JSON.stringify({ gameCode: code, name }));
        joinSection.classList.add("hidden"); playerGameCard.classList.remove("hidden");
        renderGameStateForPlayer(resp.game);
      });
    });

    btnCorrect.addEventListener("click", () => { if (iAmCurrentExplainer) socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: 1 }, requestNextWord); });
    btnSkip.addEventListener("click", () => { if (iAmCurrentExplainer) socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: -1 }, requestNextWord); });
    exitGameBtn.addEventListener("click", () => { if(confirm("×œ×¦××ª ××”××©×—×§?")) resetPlayerState(); });

    socket.on("gameUpdated", renderGameStateForPlayer);
    socket.on("roundTimeUp", (data) => {
      if (!data) return;
      const score = data.roundScore || 0;
      const teamName = data.teamName || "×”×§×‘×•×¦×”";
      let title = "â° ×”×–××Ÿ × ×’××¨!";
      let body = `<div style="font-size:1.3rem; font-weight:800; margin-bottom:12px; color:#F84779;">${teamName}</div>`;
      if (score <= 4) body += "×œ× × ×•×¨×, ××ª× ×¢×“×™×™×Ÿ ××ª×—×××™×... ğŸ§Š";
      else if (score <= 9) body += "×¡×‘×‘ ×¡×‘×‘×” ×œ×’××¨×™! ğŸ‘";
      else body += "×•×•××•! ×©×™×—×§×ª× ××•×ª×” ×‘×¢× ×§! ğŸ”¥";
      body += `<div style="margin-top:20px; font-size:1.6rem; font-weight:800; color:#2B1E4A; background:#F8F7FF; padding:12px; border-radius:16px;">× ×™×§×•×“ ×‘×¡×‘×‘: ${score}</div>`;
      showModal(title, body);
      iAmCurrentExplainer = false; presenterSection.classList.add("hidden"); playerBigTimerEl.textContent = "00:00";
    });
    socket.on("gameEnded", () => { showModal("×”××©×—×§ ×”×¡×ª×™×™×!", "×ª×•×“×” ×©×©×™×—×§×ª× ×‘××™×œ×× ×™×”! ğŸ‰"); resetPlayerState(); });

    fetch("/api/banners").then(r=>r.json()).then(d => {
        if(d.logo?.imageUrl) { playerLogoEl.src=d.logo.imageUrl; playerLogoEl.classList.remove("hidden"); }
        if(d.player?.imageUrl) playerBannerSlot.innerHTML = `<a href="${d.player.linkUrl}" target="_blank"><img src="${d.player.imageUrl}" style="max-width:100%; border-radius:16px;"></a>`;
    }).catch(()=>{});

    (function handleUrlAndTeams() {
      const params = new URLSearchParams(window.location.search);
      const urlCode = params.get("code"), urlTeamId = params.get("teamId");
      const urlTeamName = params.get("teamName") ? decodeURIComponent(params.get("teamName")) : null;
      if (urlTeamName) { inviteInfo.style.display = "block"; inviteInfo.textContent = `×”×•×–×× ×ª ×œ×§×‘×•×¦×ª "${urlTeamName}"`; }
      if(urlCode) {
          gameCodeInput.value = urlCode; joinStatus.textContent = "×‘×•×“×§ ×¤×¨×˜×™ ××©×—×§...";
          socket.emit("getGameState", { gameCode: urlCode }, (resp) => {
              if(resp.ok && resp.game.teams) {
                  joinStatus.textContent = ""; teamChoiceRow.style.display = "block"; teamSelect.innerHTML = "";
                  Object.entries(resp.game.teams).forEach(([tid, team]) => {
                      const tName = team.name || tid; const opt = document.createElement("option"); opt.value = tid; opt.textContent = tName; teamSelect.appendChild(opt);
                      if(urlTeamId === tid || urlTeamName === tName) teamSelect.value = tid;
                  });
                  if(params.get("autoJoin") && playerNameInput.value) joinBtn.click();
              } else { joinStatus.textContent = "×”××©×—×§ ×œ× × ××¦× ××• ×©×”×¡×ª×™×™×."; teamSelect.innerHTML = '<option>×©×’×™××” ×‘×˜×¢×™× ×”</option>'; }
          });
      } else {
          const saved = JSON.parse(localStorage.getItem(LOCAL_PLAYER_KEY));
          if(saved && saved.gameCode && saved.name) { gameCodeInput.value = saved.gameCode; playerNameInput.value = saved.name; joinBtn.click(); }
      }
    })();
  </script>
</body>
</html>
