<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - ××¡×š ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root { font-size: 16px; }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      background: #FFF8EA;
      color: #2B1E4A;
      min-height: 100vh;
      font-size: 1rem;
      position: relative;
      overflow-x: hidden; /* ××•× ×¢ ×’×œ×™×œ×” ××•×¤×§×™×ª */
    }
    /* <--- ×©×™× ×•×™: ×¨×§×¢×™ Gradient ×¢×“×™× ×™× ×™×•×ª×¨ */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      z-index: -1;
      filter: blur(40px);
      opacity: 0.15;
    }
    body::before {
      top: -100px;
      left: -100px;
      background: radial-gradient(circle, #F84779 0%, transparent 70%);
    }
    body::after {
      bottom: -100px;
      right: -100px;
      background: radial-gradient(circle, #15C4C1 0%, transparent 70%);
    }

    .app {
      max-width: 600px; /* <--- ×©×™× ×•×™: ×¨×•×—×‘ ×¦×¨ ×™×•×ª×¨ ×œ××•×‘×™×™×œ */
      width: 100%;
      padding: 20px 16px 80px; /* ×”×•×¡×¤× ×• ×¤×“×™× ×’ ×ª×—×ª×•×Ÿ ×œ×¤×× ×œ ×¦×£ */
      margin: 0 auto;
    }
    .card {
      background: #FFFFFF;
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(43, 30, 74, 0.04);
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    h1, h2, h3 { margin-top: 0; color: #2B1E4A; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    h3 { font-size: 1.1rem; margin-bottom: 1rem; }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: #6B618F;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 2px solid rgba(43, 30, 74, 0.1);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 1rem;
      transition: all 0.2s;
    }
    input::placeholder { color: #B0A6CC; }
    input:focus, select:focus {
      outline: none;
      border-color: #F84779;
      background: #fff;
      box-shadow: 0 4px 12px rgba(248, 71, 121, 0.1);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .row > div { flex: 1 1 100%; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      transition: all 0.2s;
      white-space: nowrap;
      width: 100%; /* ×›×¤×ª×•×¨×™× ×¨×—×‘×™× ×‘××•×‘×™×™×œ */
      letter-spacing: 0.02em;
    }
    .btn:active { transform: scale(0.98); }

    .btn-primary {
      background: linear-gradient(135deg, #F84779, #FF8566);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(248, 71, 121, 0.25);
    }
    .btn-success {
      background: linear-gradient(135deg, #15C4C1, #42E695);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(21, 196, 193, 0.25);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #EF4444;
      border: 2px solid currentColor;
    }
    .btn-ghost {
      background: transparent;
      color: #6B618F;
      border: 2px solid rgba(107, 97, 143, 0.2);
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    .btn-small { padding: 8px 16px; font-size: 0.9rem; width: auto; }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(248, 71, 121, 0.1);
      color: #F84779;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logo-small {
      height: 48px;
      width: auto;
      border-radius: 12px;
    }

    .status-text {
      font-size: 0.95rem;
      color: #6B618F;
      line-height: 1.5;
    }

    .hidden { display: none !important; }

    .data-block {
        background: #F8F7FF;
        padding: 12px 16px;
        border-radius: 14px;
        margin-bottom: 8px;
    }
    .data-label {
      font-size: 0.85rem;
      color: #A18CCF;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .data-value {
        font-size: 1rem;
        color: #433362;
        font-weight: 600;
    }

    /* --- ××™×–×•×¨ ×”××¡×‘×™×¨ --- */
    #presenterSection {
        background: linear-gradient(135deg, #FFFDF7, #FFF);
        border: 2px dashed #E2DCEF;
        border-radius: 20px;
        padding: 24px 16px;
        text-align: center;
        margin-top: 20px;
    }
    #presenterTitle { font-size: 1.1rem; color: #F84779; font-weight: 700; margin-bottom: 12px; }
    #presenterWord {
      font-size: 2.8rem;
      font-weight: 800;
      color: #2B1E4A;
      margin: 0 0 8px;
      line-height: 1.1;
    }
    #presenterCategory {
      display: inline-block;
      background: #E2DCEF;
      color: #6B618F;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    .presenter-actions {
      display: flex;
      gap: 12px;
    }
    .presenter-actions .btn { flex: 1; padding: 16px; font-size: 1.1rem; }

    /* --- ×˜×™×™××¨ ×’×“×•×œ --- */
    #playerBigTimer {
      font-size: 3.5rem;
      font-weight: 800;
      color: #F84779;
      text-align: center;
      line-height: 1;
      margin: 16px 0;
      font-variant-numeric: tabular-nums;
    }

    /* --- <--- ×©×™× ×•×™: ×¢×™×¦×•×‘ ×œ×¤×× ×œ × ×™×”×•×œ ×¦×£ --- */
    #adminFab {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #2B1E4A;
      color: #FFD76F;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(43, 30, 74, 0.3);
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    #adminFab:active { transform: translateX(-50%) scale(0.95); }

    #adminFloatingPanel {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 500px;
      background: #FFFFFF;
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      z-index: 99;
      border: 2px solid #E2DCEF;
    }
    .admin-panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .close-panel-btn { background:none; border:none; font-size:1.5rem; color:#6B618F; cursor:pointer; padding:4px; }


    /* --- <--- ×©×™× ×•×™: ×¢×™×¦×•×‘ ×œ××•×“×œ (×¤×•×¤××¤) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(43, 30, 74, 0.6);
        backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-box {
        background: #fff; width: 85%; max-width: 400px;
        border-radius: 28px; padding: 28px 24px;
        text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        transform: translateY(30px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.active .modal-box { transform: translateY(0); }
    .modal-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 12px; color: #2B1E4A; }
    .modal-content { font-size: 1.05rem; color: #6B618F; margin-bottom: 24px; line-height: 1.5; }

    @media (min-width: 640px) {
        .row > div { flex: 1 1 45%; }
        .btn { width: auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="page-header">
        <div style="display:flex; align-items:center; gap:12px;">
             <img id="playerLogo" class="logo-small hidden" alt="×œ×•×’×•" />
             <div>
                 <div class="chip">××¡×š ×©×—×§×Ÿ ğŸ®</div>
             </div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" onclick="location.href='home.html'">ğŸ  ×‘×™×ª</button>
        </div>
    </div>

    <div class="card" id="joinSection">
      <h1>×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h1>
      <p class="status-text" style="margin-bottom: 20px;">×”×›× ×™×¡×• ××ª ×§×•×“ ×”××©×—×§ ×©×§×™×‘×œ×ª×, ×‘×—×¨×• ×©× ××¦×—×™×§ ×•×›× ×¡×• ×œ×§×‘×•×¦×”!</p>

      <div id="inviteInfo" class="data-block" style="display:none; background:#F0EBFF; color:#58457F;"></div>

      <div class="row">
        <div>
          <label for="gameCodeInput">×§×•×“ ××©×—×§</label>
          <input id="gameCodeInput" type="text" placeholder="AB12" style="text-transform:uppercase; font-weight:700; letter-spacing:1px; text-align:center;" />
        </div>
        <div>
          <label for="playerNameInput">×”×©× ×©×œ×š</label>
          <input id="playerNameInput" type="text" placeholder="×œ×“×•×’××”: ×‘×•×‘×¡×¤×•×’" style="text-align:center;" />
        </div>
      </div>

      <div class="row" id="teamChoiceRow" style="display:none;">
        <div>
          <label for="teamSelect">×‘×—×™×¨×ª ×§×‘×•×¦×”</label>
          <select id="teamSelect" style="text-align:center; font-weight:600;">
            <option value="">×˜×•×¢×Ÿ ×§×‘×•×¦×•×ª...</option>
          </select>
        </div>
      </div>

      <button id="joinBtn" class="btn btn-primary" type="button" style="margin-top:12px;">ğŸš€ ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</button>
      <div id="joinStatus" class="status-text" style="margin-top:16px; text-align:center; font-weight:600;"></div>
    </div>

    <div class="card hidden" id="playerGameCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h1 style="margin:0;">×—×“×¨ ×”××©×—×§</h1>
        <button id="exitGameBtn" class="btn btn-danger btn-small" type="button">×™×¦×™××”</button>
      </div>

      <div class="data-block">
          <div id="myGameInfo" style="font-weight:600; color:#433362;"></div>
      </div>

      <div class="row">
          <div class="data-block">
            <div class="data-label">×”×§×‘×•×¦×” ×©×œ×™</div>
            <div id="myTeamName" class="data-value"></div>
          </div>
          <div class="data-block">
            <div class="data-label">×—×‘×¨×™ ×”×§×‘×•×¦×”</div>
            <div id="myTeamPlayers" class="data-value" style="font-weight:400; font-size:0.95rem;"></div>
          </div>
      </div>

      <div style="text-align:center; padding: 20px 0;">
          <div id="roundStatusPlayer" class="status-text" style="font-weight:600; font-size:1.1rem; color:#2B1E4A;"></div>
          <div id="playerBigTimer">--:--</div>
      </div>

      <div id="presenterSection" class="hidden">
        <div id="presenterTitle">××ª×” ×”××¡×‘×™×¨! ğŸ—£ï¸</div>
        <div id="presenterWord">...</div>
        <div id="presenterCategory">×˜×•×¢×Ÿ...</div>
        <div class="presenter-actions">
          <button id="btnSkip" class="btn btn-primary" style="background: #FFB4CB; color:#A11C4B; box-shadow:none;">â­ ×“×œ×’ (-1)</button>
          <button id="btnCorrect" class="btn btn-success" style="flex:1.5; font-size:1.2rem;">âœ… × ×›×•×Ÿ! (+1)</button>
        </div>
      </div>

      <hr style="border:none; border-top:2px dashed #E2DCEF; margin: 24px 0;" />

      <h3>×˜×‘×œ×ª × ×™×§×•×“</h3>
      <div id="scoreboard" class="data-block" style="font-family:monospace; white-space:pre-wrap;"></div>

      <div id="player-banner-slot" style="margin-top:20px; text-align:center;"></div>
    </div>
  </div>

  <div id="adminFab" class="hidden">
      <span>ğŸ‘‘</span> × ×™×”×•×œ ×¡×‘×‘
  </div>

  <div id="adminFloatingPanel" class="hidden">
      <div class="admin-panel-header">
          <h3 style="margin:0;">× ×™×”×•×œ ×¡×‘×‘ ××”×™×¨</h3>
          <button class="close-panel-btn" id="closeAdminPanel">Ã—</button>
      </div>
      <div class="row">
          <div>
             <label for="floatTeamSelect">×§×‘×•×¦×”</label>
             <select id="floatTeamSelect"></select>
          </div>
          <div>
             <label for="floatSeconds">×©× ×™×•×ª</label>
             <input type="number" id="floatSeconds" value="60" min="10" max="300">
          </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
          <button id="floatStartBtn" class="btn btn-success" style="flex:1;">â–¶ ×”×ª×—×œ</button>
          <button id="floatStopBtn" class="btn btn-danger" style="flex:1;" disabled>â¹ ×¡×™×™×</button>
      </div>
  </div>

  <div class="modal-overlay" id="customModal">
      <div class="modal-box">
          <div class="modal-title" id="modalTitle"></div>
          <div class="modal-content" id="modalContent"></div>
          <button class="btn btn-primary" id="modalCloseBtn">×¡×’×•×¨</button>
      </div>
  </div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const LOCAL_PLAYER_KEY = "millmania-player-join";

    // ××œ×× ×˜×™× ×›×œ×œ×™×™×
    const gameCodeInput = document.getElementById("gameCodeInput");
    const playerNameInput = document.getElementById("playerNameInput");
    const joinBtn = document.getElementById("joinBtn");
    const joinStatus = document.getElementById("joinStatus");
    const joinSection = document.getElementById("joinSection");
    const playerGameCard = document.getElementById("playerGameCard");

    const inviteInfo = document.getElementById("inviteInfo");
    const teamChoiceRow = document.getElementById("teamChoiceRow");
    const teamSelect = document.getElementById("teamSelect");

    // ××œ×× ×˜×™× ×‘×ª×•×š ×”××©×—×§
    const myGameInfo = document.getElementById("myGameInfo");
    const myTeamNameEl = document.getElementById("myTeamName");
    const myTeamPlayersEl = document.getElementById("myTeamPlayers");
    const scoreboardEl = document.getElementById("scoreboard");
    const roundStatusPlayerEl = document.getElementById("roundStatusPlayer");
    const playerBigTimerEl = document.getElementById("playerBigTimer");

    const playerLogoEl = document.getElementById("playerLogo");
    const playerBannerSlot = document.getElementById("player-banner-slot");

    // ××œ×× ×˜×™× ×©×œ ×”××¡×‘×™×¨
    const presenterSection = document.getElementById("presenterSection");
    const presenterWordEl = document.getElementById("presenterWord");
    const presenterCategoryEl = document.getElementById("presenterCategory");
    const btnCorrect = document.getElementById("btnCorrect");
    const btnSkip = document.getElementById("btnSkip");
    const exitGameBtn = document.getElementById("exitGameBtn");

    // <--- ×©×™× ×•×™: ××œ×× ×˜×™× ×©×œ ×¤×× ×œ × ×™×”×•×œ ×¦×£
    const adminFab = document.getElementById("adminFab");
    const adminFloatingPanel = document.getElementById("adminFloatingPanel");
    const closeAdminPanelBtn = document.getElementById("closeAdminPanel");
    const floatTeamSelect = document.getElementById("floatTeamSelect");
    const floatSecondsInput = document.getElementById("floatSeconds");
    const floatStartBtn = document.getElementById("floatStartBtn");
    const floatStopBtn = document.getElementById("floatStopBtn");

    // <--- ×©×™× ×•×™: ××œ×× ×˜×™× ×©×œ ×”××•×“×œ
    const customModal = document.getElementById("customModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    const modalCloseBtn = document.getElementById("modalCloseBtn");


    let myClientId = null;
    let currentGameCode = null;
    let myTeamId = null;
    let iAmHost = false; // <--- ×©×™× ×•×™: ×“×’×œ ×œ×–×™×”×•×™ ×× ×× ×™ ×”×× ×”×œ
    let lastGameState = null;

    let currentWord = null;
    let currentCategory = "";
    let lastRoundKey = null;
    let iAmCurrentExplainer = false;
    let roundTimerInterval = null;

    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = (s % 60).toString().padStart(2, "0");
      return m + ":" + ss;
    }

    // <--- ×©×™× ×•×™: ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”××•×“×œ ×”××¢×•×¦×‘
    function showModal(title, content) {
        modalTitle.textContent = title;
        modalContent.innerHTML = content;
        customModal.classList.add("active");
    }

    modalCloseBtn.addEventListener("click", () => {
        customModal.classList.remove("active");
    });


    // --- ×œ×•×’×™×§×ª ×¤×× ×œ × ×™×”×•×œ ×¦×£ ---
    adminFab.addEventListener("click", () => {
        adminFloatingPanel.classList.remove("hidden");
        adminFab.classList.add("hidden");
        populateFloatTeamSelect(); // <--- ×©×™× ×•×™: ××™×œ×•×™ ×”×¨×©×™××” ×‘×¤×ª×™×—×”
    });

    closeAdminPanelBtn.addEventListener("click", () => {
        adminFloatingPanel.classList.add("hidden");
        adminFab.classList.remove("hidden");
    });

    function populateFloatTeamSelect() {
        if (!lastGameState || !lastGameState.teams) return;
        floatTeamSelect.innerHTML = "";
        Object.entries(lastGameState.teams).forEach(([tid, team]) => {
            const opt = document.createElement("option");
            opt.value = tid;
            opt.textContent = team.name || tid;
            floatTeamSelect.appendChild(opt);
        });
        // × ×™×¡×™×•×Ÿ ×œ×‘×—×•×¨ ××ª ×”×§×‘×•×¦×” ×”×‘××” ×‘×ª×•×¨ (×¤×©×•×˜×”)
        if (lastGameState.currentRound && lastGameState.currentRound.teamId) {
             const teamIds = Object.keys(lastGameState.teams);
             const currentIdx = teamIds.indexOf(lastGameState.currentRound.teamId);
             const nextIdx = (currentIdx + 1) % teamIds.length;
             floatTeamSelect.value = teamIds[nextIdx];
        }
    }

    floatStartBtn.addEventListener("click", () => {
        if(!currentGameCode) return;
        socket.emit("startRound", {
            gameCode: currentGameCode,
            teamId: floatTeamSelect.value,
            roundSeconds: parseInt(floatSecondsInput.value) || 60
        });
        adminFloatingPanel.classList.add("hidden");
        adminFab.classList.remove("hidden");
    });

    floatStopBtn.addEventListener("click", () => {
         if(!currentGameCode) return;
         socket.emit("endRound", { gameCode: currentGameCode });
    });


    // --- ×˜×¢×™× ×ª × ×ª×•× ×™× ×¨××©×•× ×™×ª ---

    (function loadPlayerBranding() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          if (data.logo && data.logo.imageUrl && playerLogoEl) {
            playerLogoEl.src = data.logo.imageUrl;
            playerLogoEl.classList.remove("hidden");
          }

          if (!playerBannerSlot) return;
          const cfg = data.player;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.href = cfg.linkUrl;
          a.target = "_blank";
          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.style.maxWidth = "100%";
          img.style.borderRadius = "16px";
          a.appendChild(img);
          playerBannerSlot.appendChild(a);
        })
        .catch(() => {});
    })();


    // --- ×œ×•×’×™×§×ª ××©×—×§ ---

    function updatePresenterUI() {
      if (!iAmCurrentExplainer) {
        presenterSection.classList.add("hidden");
        return;
      }
      presenterSection.classList.remove("hidden");

      if (!currentWord) {
        presenterWordEl.textContent = "×˜×•×¢×Ÿ ××™×œ×”...";
        presenterCategoryEl.textContent = "...";
        btnCorrect.disabled = true;
        btnSkip.disabled = true;
      } else {
        presenterWordEl.textContent = currentWord;
        // ×ª×¨×’×•× ×§×˜×’×•×¨×™×•×ª ×‘×¡×™×¡×™ (××¤×©×¨ ×œ×”×¨×—×™×‘)
        const catMap = { general: '×›×œ×œ×™', animals:'×—×™×•×ª', food:'××•×›×œ', objects:'×—×¤×¦×™×', technology:'×˜×›× ×•×œ×•×’×™×”', family:'××©×¤×—×”', travel:'×˜×™×•×œ×™×', sports:'×¡×¤×•×¨×˜', entertainment:'×‘×™×“×•×¨', music:'××•×–×™×§×”', nature:'×˜×‘×¢', holidays:'×—×’×™×', school:'×œ×™××•×“×™×', work:'×¢×‘×•×“×”', hard:'×§×©×”' };
        presenterCategoryEl.textContent = catMap[currentCategory] || currentCategory || '×›×œ×œ×™';
        btnCorrect.disabled = false;
        btnSkip.disabled = false;
      }
    }

    function requestNextWord() {
      if (!currentGameCode) return;
      btnCorrect.disabled = true;
      btnSkip.disabled = true;
      socket.emit("getNextWord", { gameCode: currentGameCode }, (resp) => {
        if (!resp || !resp.ok) {
          presenterWordEl.textContent = "×©×’×™××”";
          return;
        }
        currentWord = resp.word || "";
        currentCategory = resp.category || "";
        updatePresenterUI();
      });
    }

    function renderGameStateForPlayer(game) {
      lastGameState = game;

      if (!myClientId || !game) {
        resetPlayerState();
        return;
      }

      const playersMap = game.players || game.playersByClientId || {};
      const me = playersMap[myClientId];

      if (!me) {
        // ×× ×”×©×—×§×Ÿ × ××—×§, × ×—×–×™×¨ ××•×ª×• ×œ××¡×š ×”×‘×™×ª
        resetPlayerState();
        joinStatus.textContent = "× ×•×ª×§×ª ××”××©×—×§.";
        return;
      }

      currentGameCode = game.code;
      myTeamId = me.teamId;
      iAmHost = me.isHost || false; // <--- ×©×™× ×•×™: ×©××™×¨×ª ×¡×˜×˜×•×¡ ×”×× ×”×œ

      // <--- ×©×™× ×•×™: ×”×¦×’×”/×”×¡×ª×¨×” ×©×œ ×›×¤×ª×•×¨ ×”× ×™×”×•×œ ×”×¦×£
      if (iAmHost) {
          adminFab.classList.remove("hidden");
      } else {
          adminFab.classList.add("hidden");
          adminFloatingPanel.classList.add("hidden");
      }


      const team = game.teams ? game.teams[myTeamId] : null;
      // <--- ×©×™× ×•×™: ×©×™××•×© ×‘×©× ×”×§×‘×•×¦×” ×”×××™×ª×™
      const teamName = team ? (team.name || myTeamId) : "×œ×œ× ×§×‘×•×¦×”";

      myGameInfo.innerHTML = `××—×•×‘×¨ ×›-<strong>${me.name}</strong> (×§×•×“: ${currentGameCode})`;
      myTeamNameEl.textContent = teamName;

      if (team && team.players) {
        const names = team.players
          .map((cid) => playersMap[cid]?.name)
          .filter(Boolean);
        myTeamPlayersEl.textContent = names.length ? names.join(", ") : "×××ª×™×Ÿ ×œ×©×—×§× ×™×...";
      }

      // ×˜×‘×œ×ª × ×™×§×•×“ ××¢×•×¦×‘×ª ×™×•×ª×¨
      if (game.teams) {
        scoreboardEl.innerHTML = Object.values(game.teams)
          .map(t => `<div style="display:flex; justify-content:space-between;"><span>${t.name || t.id}</span><strong>${t.score}</strong></div>`)
          .join("");
      }

      // ××¦×‘ ×¡×‘×‘
      const r = game.currentRound;
      clearInterval(roundTimerInterval); // ××™×¤×•×¡ ×˜×™×™××¨ ××§×•××™ ×™×©×Ÿ

      if (r && r.isActive) {
        floatStopBtn.disabled = false; // <--- ×©×™× ×•×™: ××¤×©×•×¨ ×›×¤×ª×•×¨ ×¢×¦×™×¨×” ×œ×× ×”×œ
        floatStartBtn.disabled = true;

        const explainerName = r.explainerName || "?";
        // <--- ×©×™× ×•×™: ×©×™××•×© ×‘×©× ×”×§×‘×•×¦×” ×”×××™×ª×™ ×©×œ ×”××¡×‘×™×¨
        const explainerTeam = game.teams[r.teamId];
        const explainerTeamName = explainerTeam ? (explainerTeam.name || r.teamId) : r.teamId;

        let statusHtml = `×‘×¡×‘×‘: <strong>${explainerTeamName}</strong><br>××¡×‘×™×¨/×”: ${explainerName}`;
        if(r.teamId === myTeamId) statusHtml += " <span style='color:#F84779;'>Your Team!</span>";
        roundStatusPlayerEl.innerHTML = statusHtml;

        // ×˜×™×™××¨ ××§×•××™ ×—×›× ×©××¡×ª× ×›×¨×Ÿ
        let secondsLeft = r.secondsLeft || 0;
        playerBigTimerEl.textContent = formatTime(secondsLeft);
        if(secondsLeft > 0) {
             roundTimerInterval = setInterval(() => {
                 secondsLeft--;
                 playerBigTimerEl.textContent = formatTime(secondsLeft);
                 if(secondsLeft <= 0) clearInterval(roundTimerInterval);
             }, 1000);
        }


        iAmCurrentExplainer = (r.explainerId === myClientId);
        if (iAmCurrentExplainer) {
          const roundKey = r.startedAt + r.teamId;
          if (roundKey !== lastRoundKey) {
            lastRoundKey = roundKey;
            currentWord = null;
            requestNextWord();
          } else {
            updatePresenterUI();
          }
        } else {
          presenterSection.classList.add("hidden");
        }

      } else {
        // ××™×Ÿ ×¡×‘×‘ ×¤×¢×™×œ
        roundStatusPlayerEl.textContent = "×××ª×™×Ÿ ×œ×ª×—×™×œ×ª ×¡×‘×‘...";
        playerBigTimerEl.textContent = "--:--";
        iAmCurrentExplainer = false;
        presenterSection.classList.add("hidden");
        floatStopBtn.disabled = true; // <--- ×©×™× ×•×™: ×›×™×‘×•×™ ×›×¤×ª×•×¨×™× ×œ×× ×”×œ
        floatStartBtn.disabled = false;
      }
    }

    function resetPlayerState() {
        playerGameCard.classList.add("hidden");
        joinSection.classList.remove("hidden");
        adminFab.classList.add("hidden"); // <--- ×©×™× ×•×™: ×”×¡×ª×¨×ª ×¤×× ×œ × ×™×”×•×œ
        localStorage.removeItem(LOCAL_PLAYER_KEY);
        myClientId = null; currentGameCode = null; iAmHost = false;
    }


    // --- ××™×¨×•×¢×™× (Events) ---

    joinBtn.addEventListener("click", () => {
      const code = gameCodeInput.value.toUpperCase().trim();
      const name = playerNameInput.value.trim();
      const teamId = teamSelect.value;

      if (code.length < 3 || name.length < 2) {
        joinStatus.textContent = "× × ×œ××œ× ×§×•×“ ×ª×§×™×Ÿ ×•×©× (×œ×¤×—×•×ª 2 ×ª×•×•×™×)";
        return;
      }

      joinStatus.textContent = "××ª×—×‘×¨...";
      joinBtn.disabled = true;

      socket.emit("joinGame", { gameCode: code, name, teamId }, (resp) => {
        joinBtn.disabled = false;
        if (!resp || !resp.ok) {
          joinStatus.textContent = resp?.error || "×ª×§×œ×” ×‘×”×ª×—×‘×¨×•×ª";
          return;
        }

        // ×—×™×‘×•×¨ ××•×¦×œ×—
        myClientId = resp.clientId;
        iAmHost = resp.isHost || false; // <--- ×©×™× ×•×™: ×§×‘×œ×ª ×¡×˜×˜×•×¡ ×× ×”×œ ××”×©×¨×ª
        localStorage.setItem(LOCAL_PLAYER_KEY, JSON.stringify({ gameCode: code, name }));

        joinSection.classList.add("hidden");
        playerGameCard.classList.remove("hidden");

        if (resp.game) renderGameStateForPlayer(resp.game);
      });
    });


    btnCorrect.addEventListener("click", () => {
      if (!iAmCurrentExplainer) return;
      socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: 1 }, requestNextWord);
    });

    btnSkip.addEventListener("click", () => {
       if (!iAmCurrentExplainer) return;
      socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: -1 }, requestNextWord);
    });

    exitGameBtn.addEventListener("click", () => {
      if(confirm("×œ×¦××ª ××”××©×—×§?")) resetPlayerState();
    });

    // --- ×¡×•×§×˜×™× ---

    socket.on("gameUpdated", renderGameStateForPlayer);

    // <--- ×©×™× ×•×™: ×˜×™×¤×•×œ ×‘××™×¨×•×¢ ×¡×™×•× ×–××Ÿ ×¢× ×”××•×“×œ ×”×—×“×©
    socket.on("roundTimeUp", (data) => {
      if (!data) return;
      const score = data.roundScore || 0;
      // <--- ×©×™× ×•×™: ×©×™××•×© ×‘×©× ×”×§×‘×•×¦×” ×”××œ× ×©×”×’×™×¢ ××”×©×¨×ª
      const teamName = data.teamName || "×”×§×‘×•×¦×”";

      let title = "â° ×”×–××Ÿ × ×’××¨!";
      let body = `<div style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">${teamName}</div>`;

      if (score <= 4) body += "×œ× × ×•×¨×, ××ª× ×¢×“×™×™×Ÿ ××ª×—×××™×... ğŸ§Š";
      else if (score <= 9) body += "×¡×‘×‘ ×¡×‘×‘×” ×œ×’××¨×™! ğŸ‘";
      else body += "×•×•××•! ×©×™×—×§×ª× ××•×ª×” ×‘×¢× ×§! ğŸ”¥";

      body += `<div style="margin-top:16px; font-size:1.4rem; font-weight:800; color:#F84779;">× ×™×§×•×“ ×‘×¡×‘×‘: ${score}</div>`;

      showModal(title, body);

      // ××™×¤×•×¡ ××¦×‘ ××§×•××™
      iAmCurrentExplainer = false;
      presenterSection.classList.add("hidden");
      playerBigTimerEl.textContent = "00:00";
    });

    socket.on("gameEnded", () => {
        showModal("×”××©×—×§ ×”×¡×ª×™×™×!", "×ª×•×“×” ×©×©×™×—×§×ª× ×‘××™×œ×× ×™×”! ğŸ‰");
        resetPlayerState();
    });


    // --- ××ª×—×•×œ ---

    // ×©×—×–×•×¨ ×—×™×‘×•×¨ ××•×˜×•××˜×™
    const saved = JSON.parse(localStorage.getItem(LOCAL_PLAYER_KEY));
    if(saved && saved.gameCode && saved.name) {
        gameCodeInput.value = saved.gameCode;
        playerNameInput.value = saved.name;
        // × ×™×¡×™×•×Ÿ ×—×™×‘×•×¨ ××”×™×¨ (××¤×©×¨ ×œ×©×¤×¨)
        joinBtn.click();
    }


    // <--- ×©×™× ×•×™: ×˜×™×¤×•×œ ××©×•×¤×¨ ×‘×›× ×™×¡×” ××§×™×©×•×¨ (AutoJoin) ×•×˜×¢×™× ×ª ×§×‘×•×¦×•×ª
    (function handleUrlAndTeams() {
      const params = new URLSearchParams(window.location.search);
      const urlCode = params.get("code");
      const urlTeamId = params.get("teamId");
      const urlTeamName = params.get("teamName"); // <--- ×©×™× ×•×™: ×§×¨×™××ª ×©× ×”×§×‘×•×¦×”

      if(urlCode) {
          gameCodeInput.value = urlCode;
          // ×˜×¢×™× ×ª ×¨×©×™××ª ×§×‘×•×¦×•×ª
          socket.emit("getGameState", { gameCode: urlCode }, (resp) => {
              if(resp && resp.ok && resp.game && resp.game.teams) {
                  teamChoiceRow.style.display = "block";
                  teamSelect.innerHTML = "";
                  Object.entries(resp.game.teams).forEach(([tid, team]) => {
                      // <--- ×©×™× ×•×™: ×©×™××•×© ×‘×©× ×”×××™×ª×™
                      const tName = team.name || tid;
                      const opt = document.createElement("option");
                      opt.value = tid;
                      opt.textContent = tName;
                      teamSelect.appendChild(opt);

                      // <--- ×©×™× ×•×™: ×‘×—×™×¨×” ××•×˜×•××˜×™×ª ×œ×¤×™ ID ××• ×œ×¤×™ ×©×
                      if(urlTeamId === tid || (urlTeamName && urlTeamName === tName)) {
                          teamSelect.value = tid;
                          inviteInfo.style.display = "block";
                          inviteInfo.textContent = `×”×•×–×× ×ª ×œ×§×‘×•×¦×ª "${tName}"`;
                      }
                  });

                  if(params.get("autoJoin") && playerNameInput.value) {
                       joinBtn.click();
                  }
              } else {
                  teamSelect.innerHTML = '<option>×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×§×‘×•×¦×•×ª</option>';
              }
          });
      }
    })();

  </script>
</body>
</html>
