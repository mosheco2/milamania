<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>××™×œ×× ×™×” Â· ××¡×š ×©×—×§×Ÿ ğŸ®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #f9efff 0, #efe7ff 45%, #ebf0ff 100%);
        color: #2b1e4a;
        direction: rtl;
      }

      .app {
        max-width: 780px;
        margin: 0 auto;
        padding: 18px 16px 40px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 22px;
        padding: 20px 18px 18px;
        box-shadow: 0 14px 40px rgba(25, 19, 54, 0.18);
        border: 1px solid rgba(186, 172, 230, 0.5);
        backdrop-filter: blur(18px);
        margin-bottom: 14px;
      }

      h1,
      h3 {
        margin: 0;
        font-weight: 700;
        color: #2b1e4a;
      }

      h1 {
        font-size: 1.9rem;
      }

      h3 {
        font-size: 1.1rem;
      }

      label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #514470;
      }

      input,
      select {
        width: 100%;
        padding: 9px 10px;
        border-radius: 14px;
        border: 1px solid rgba(150, 134, 204, 0.7);
        font-size: 1rem;
        outline: none;
        transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        background: rgba(255, 255, 255, 0.95);
      }

      input:focus,
      select:focus {
        border-color: #7c5cff;
        box-shadow: 0 0 0 1px rgba(124, 92, 255, 0.25);
        background: #ffffff;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .row > div {
        flex: 1;
        min-width: 150px;
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 11px 18px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: transform 0.1s ease, box-shadow 0.1s ease,
          background 0.1s ease, color 0.1s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, #7c5cff, #ff4f8b);
        color: #ffffff;
        box-shadow: 0 10px 22px rgba(124, 92, 255, 0.35);
      }

      .btn-primary:active {
        transform: translateY(1px);
        box-shadow: 0 5px 12px rgba(124, 92, 255, 0.4);
      }

      .btn-ghost {
        background: transparent;
        color: #514470;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 0.85rem;
        border: 1px solid rgba(155, 140, 210, 0.45);
      }

      .btn-ghost:active {
        transform: translateY(1px);
      }

      .btn-small {
        font-size: 0.85rem;
        padding: 7px 12px;
      }

      .status-text {
        font-size: 0.9rem;
        color: #5b4c84;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.8rem;
        color: #7b6aaf;
        border: 1px solid rgba(196, 179, 255, 0.8);
      }

      .logo-small {
        height: 40px;
        width: auto;
        margin-inline-start: 8px;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .page-header-main {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .team-block-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #4b3b78;
        margin-bottom: 3px;
      }

      .team-players-list {
        font-size: 0.9rem;
      }

      #scoreboard {
        margin-top: 6px;
        font-size: 0.9rem;
      }

      #roundStatusPlayer {
        margin-top: 6px;
        font-weight: 500;
        color: #3b2a73;
      }

      .hidden {
        display: none;
      }

      #player-banner-slot {
        margin-top: 10px;
      }

      @media (max-width: 640px) {
        body {
          font-size: 1.05rem;
        }
        .app {
          padding: 16px 10px 32px;
        }
        .card {
          padding: 18px 14px 20px;
          border-radius: 20px;
        }
        h1 {
          font-size: 1.6rem;
        }
        h3 {
          font-size: 1.05rem;
        }
        label {
          font-size: 0.9rem;
        }
        input,
        select {
          font-size: 1rem;
        }
        .btn {
          font-size: 1rem;
          padding: 10px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- ×›×•×ª×¨×ª -->
      <div class="card">
        <div class="page-header">
          <div class="page-header-main">
            <img
              id="player-logo"
              class="logo-small hidden"
              alt="××™×œ×× ×™×” ×œ×•×’×•"
            />
            <div>
              <div class="chip">××™×œ×× ×™×” Â· ××¡×š ×©×—×§×Ÿ ğŸ®</div>
              <h1 style="margin: 4px 0 0; font-size: 1.7rem">×©×—×§×Ÿ</h1>
            </div>
          </div>
          <div
            style="
              display: flex;
              gap: 6px;
              flex-wrap: wrap;
              justify-content: flex-end;
            "
          >
            <button
              class="btn btn-ghost btn-small"
              onclick="location.href='instructions.html'"
            >
              â” ×”×•×¨××•×ª
            </button>
            <button
              class="btn btn-ghost btn-small"
              onclick="location.href='home.html'"
            >
              â¬… ××¡×š ×”×‘×™×ª
            </button>
          </div>
        </div>
        <p class="status-text" style="margin-top: 8px">
          ××¦×˜×¨×¤×™× ×œ×—×“×¨ ×¢× ×§×•×“ ×”××©×—×§, ×‘×•×—×¨×™× ×©× ××¦×—×™×§, ×•× ×›× ×¡×™× ×œ×§×‘×•×¦×” ×©×”×•×’×“×¨×”
          ×œ×›× ×¢×œ ×™×“×™ ×× ×”×œ ×”××©×—×§ ğŸ˜„
        </p>
      </div>

      <!-- ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
      <div class="card" id="joinSection">
        <h3 style="margin: 0 0 8px">×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h3>

        <div
          id="inviteInfo"
          class="status-text"
          style="margin-bottom: 8px; display: none"
        ></div>

        <div class="row">
          <div>
            <label for="gameCodeInput">×§×•×“ ××©×—×§</label>
            <input
              id="gameCodeInput"
              type="text"
              placeholder="×œ×“×•×’××”: AB12"
            />
          </div>
          <div>
            <label for="playerNameInput">×”×©× ×©×œ×™ ×‘××©×—×§</label>
            <input
              id="playerNameInput"
              type="text"
              placeholder="×‘×—×¨ ×©× ××¦×—×™×§ ğŸ˜œ"
            />
          </div>
        </div>

        <!-- ×‘×—×™×¨×ª ×§×‘×•×¦×” ×™×“× ×™×ª ×¨×§ ×× ××™×Ÿ ×§×‘×•×¦×” ×©×”×’×™×¢×” ××”×œ×™× ×§ -->
        <div class="row" id="teamChoiceRow">
          <div>
            <label for="teamSelect">×”×§×‘×•×¦×” ×©×œ×™</label>
            <select id="teamSelect">
              <option value="">×”×§×¦××” ××•×˜×•××˜×™×ª</option>
            </select>
          </div>
        </div>

        <button
          id="joinBtn"
          class="btn btn-primary"
          style="margin-top: 6px"
        >
          ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§
        </button>

        <div
          id="joinStatus"
          class="status-text"
          style="margin-top: 8px"
        ></div>
      </div>

      <!-- ××—×¨×™ ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
      <div class="card hidden" id="playerGameCard">
        <h3 style="margin: 0 0 6px">××¦×‘ ×”××©×—×§ ×©×œ×™</h3>
        <div
          id="myGameInfo"
          class="status-text"
          style="margin-bottom: 8px"
        ></div>

        <div style="margin-bottom: 8px">
          <div class="team-block-title">×”×§×‘×•×¦×” ×©×œ×™</div>
          <div id="myTeamName" class="status-text"></div>
        </div>

        <div style="margin-bottom: 8px">
          <div class="team-block-title">×”×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×™</div>
          <div
            id="myTeamPlayers"
            class="team-players-list status-text"
          ></div>
        </div>

        <div style="margin-bottom: 8px">
          <div class="team-block-title">× ×™×§×•×“ ×›×œ×œ×™</div>
          <div id="scoreboard" class="status-text"></div>
        </div>

        <div
          id="roundStatusPlayer"
          class="status-text"
          style="margin-top: 4px"
        >
          ××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.
        </div>

        <div id="player-banner-slot"></div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      // ××œ×× ×˜×™×
      const gameCodeInput = document.getElementById("gameCodeInput");
      const playerNameInput = document.getElementById("playerNameInput");
      const teamSelect = document.getElementById("teamSelect");
      const joinBtn = document.getElementById("joinBtn");
      const joinStatus = document.getElementById("joinStatus");
      const inviteInfo = document.getElementById("inviteInfo");
      const teamChoiceRow = document.getElementById("teamChoiceRow");

      const joinSection = document.getElementById("joinSection");
      const playerGameCard = document.getElementById("playerGameCard");
      const myGameInfoEl = document.getElementById("myGameInfo");
      const myTeamNameEl = document.getElementById("myTeamName");
      const myTeamPlayersEl = document.getElementById("myTeamPlayers");
      const scoreboardEl = document.getElementById("scoreboard");
      const roundStatusPlayerEl = document.getElementById("roundStatusPlayer");
      const playerLogoEl = document.getElementById("player-logo");
      const playerBannerSlot = document.getElementById("player-banner-slot");

      // ××¦×‘
      let currentGameCode = null;
      let lastGameState = null;
      let myClientId = null;
      let myTeamId = null;
      let invitedTeamId = null;

      // ×¤×¨××˜×¨×™× ××”Ö¾URL (×”×–×× ×” ××”××¡×š ×©×œ ×”×× ×”×œ)
      (function readUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const code = (params.get("code") || "").toUpperCase();
        const teamId = params.get("teamId") || "";
        const teamName = params.get("teamName") || "";

        if (code) {
          gameCodeInput.value = code;
          currentGameCode = code;
        }

        if (teamId) {
          invitedTeamId = teamId;
          inviteInfo.style.display = "block";
          inviteInfo.textContent =
            teamName && teamName.trim()
              ? `×”×•×–×× ×ª ×œ×§×‘×•×¦×” "${teamName}". ×ª×•×›×œ ×œ×©× ×•×ª ×§×‘×•×¦×” ×× ×ª×¨×¦×”.`
              : "×”×•×–×× ×ª ×œ×§×‘×•×¦×” ××¡×•×™××ª ×‘××©×—×§ ×”×–×”.";
        }

        if (invitedTeamId) {
          teamChoiceRow.style.display = "none";
        }
      })();

      // ×”×ª×—×‘×¨×•×ª ×œ××©×—×§
      if (joinBtn) {
        joinBtn.addEventListener("click", () => {
          const gameCode = (gameCodeInput.value || "").toUpperCase();
          const playerName = (playerNameInput.value || "").trim();

          // âœ… ×× ×™×¢×ª ×¨×™×©×•× ×›×¤×•×œ ×××•×ª×• ×“×¤×“×¤×Ÿ ×œ××•×ª×• ××©×—×§
          if (
            myClientId &&
            currentGameCode &&
            currentGameCode === gameCode
          ) {
            joinStatus.textContent = "××ª×” ×›×‘×¨ ××—×•×‘×¨ ×œ××©×—×§ ×”×–×”.";
            return;
          }

          if (!gameCode) {
            joinStatus.textContent = "× × ×œ×”×–×™×Ÿ ×§×•×“ ××©×—×§.";
            return;
          }
          if (!playerName) {
            joinStatus.textContent = "× × ×œ×”×–×™×Ÿ ×©× ×œ×©×—×§×Ÿ.";
            return;
          }

          let chosenTeamId = invitedTeamId || "";
          if (!chosenTeamId && teamSelect) {
            chosenTeamId = teamSelect.value || "";
          }

          joinStatus.textContent = "××ª×—×‘×¨ ×œ××©×—×§...";

          socket.emit(
            "joinGame",
            { gameCode, name: playerName, teamId: chosenTeamId || null },
            (resp) => {
              if (!resp || !resp.ok) {
                joinStatus.textContent =
                  (resp && resp.error) ||
                  "×œ× ×”×¦×œ×—× ×• ×œ×—×‘×¨ ××•×ª×š ×œ××©×—×§. ×‘×“×•×§ ××ª ×”×§×•×“ ×•× ×¡×” ×©×•×‘.";
                return;
              }

              // ×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”
              currentGameCode = gameCode;
              myClientId = resp.clientId || null;
              myTeamId = resp.teamId || null;

              joinStatus.textContent = "×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ××©×—×§!";

              if (joinSection && playerGameCard) {
                joinSection.classList.add("hidden");
                playerGameCard.classList.remove("hidden");
              }

              if (resp.game) {
                renderGame(resp.game);
              }
            }
          );
        });
      }

      // ×¨×™× ×“×•×¨ ××©×—×§ ×œ×©×—×§×Ÿ
      function renderGame(game) {
        lastGameState = game;

        if (!game || !currentGameCode || game.code !== currentGameCode) {
          if (myGameInfoEl) {
            myGameInfoEl.textContent =
              "×œ× × ××¦××” ×”×ª×××” ×œ××©×—×§ ×¢× ×”×§×•×“ ×”×–×”. ××•×œ×™ ×”××©×—×§ × ×¡×’×¨?";
          }
          return;
        }

        const playersMap = game.players || {};
        const teams = game.teams || {};

        const me = myClientId ? playersMap[myClientId] : null;

        // ×˜×§×¡×˜ ×›×œ×œ×™ ×¢×œ ××¦×‘ ×”××©×—×§
        if (myGameInfoEl) {
          let text = "";
          if (!me) {
            text =
              "××ª×” ××—×•×‘×¨ ×œ××©×—×§ ××‘×œ ×¢×“×™×™×Ÿ ×œ× ×–×•×”×™×ª ×›×©×—×§×Ÿ ×¤×¢×™×œ. ×™×™×ª×›×Ÿ ×©×”××©×—×§ ×‘×’×œ×’×•×œ ××• × ×¡×’×¨.";
          } else {
            const teamName =
              (me.teamId && teams[me.teamId] && teams[me.teamId].name) ||
              (me.teamId ? `×§×‘×•×¦×” ${me.teamId}` : "×œ×œ× ×§×‘×•×¦×”");

            text = `××ª×” ××—×•×‘×¨ ×œ××©×—×§ "${game.code}". ×”×©× ×©×œ×š ×‘××©×—×§: ${
              me.name || "×œ×œ× ×©×"
            }. ×”×§×‘×•×¦×” ×©×œ×š: ${teamName}.`;
          }
          myGameInfoEl.textContent = text;
        }

        // ×©× ×”×§×‘×•×¦×” ×©×œ×™
        if (myTeamNameEl) {
          const t = myTeamId ? teams[myTeamId] : null;
          if (t) {
            myTeamNameEl.textContent = t.name || `×§×‘×•×¦×” ${myTeamId}`;
          } else if (myTeamId) {
            myTeamNameEl.textContent = `×§×‘×•×¦×” ${myTeamId}`;
          } else {
            myTeamNameEl.textContent = "×¢×“×™×™×Ÿ ×œ× ×©×•×™×›×ª ×œ×§×‘×•×¦×”.";
          }
        }

        // ×”×¦×’×ª ×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×™
        if (myTeamPlayersEl) {
          const myTeam = myTeamId ? teams[myTeamId] : null;
          if (
            myTeam &&
            Array.isArray(myTeam.players) &&
            myTeam.players.length
          ) {
            const names = myTeam.players
              .map((cid) =>
                playersMap[cid] && playersMap[cid].name
                  ? playersMap[cid].name
                  : null
              )
              .filter(Boolean);
            myTeamPlayersEl.textContent = names.length
              ? names.join(", ")
              : "×¢×“×™×™×Ÿ ××™×Ÿ ×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×š.";
          } else if (myTeamId) {
            myTeamPlayersEl.textContent = "×¢×“×™×™×Ÿ ××™×Ÿ ×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×š.";
          } else {
            myTeamPlayersEl.textContent = "×¢×“×™×™×Ÿ ×œ× ×©×•×™×›×ª ×œ×§×‘×•×¦×”.";
          }
        }

        // × ×™×§×•×“ ×›×œ×œ×™
        if (scoreboardEl) {
          scoreboardEl.innerHTML = "";
          Object.entries(teams).forEach(([teamId, team]) => {
            const line = document.createElement("div");
            line.style.display = "flex";
            line.style.justifyContent = "space-between";
            line.style.padding = "3px 0";

            const nameSpan = document.createElement("span");
            nameSpan.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;

            const scoreSpan = document.createElement("span");
            scoreSpan.textContent = team.score || 0;

            line.appendChild(nameSpan);
            line.appendChild(scoreSpan);
            scoreboardEl.appendChild(line);
          });
        }

        // ××¦×‘ ×¡×™×‘×•×‘
        if (roundStatusPlayerEl) {
          if (game.currentRound && game.currentRound.teamId) {
            const t = teams[game.currentRound.teamId];
            const teamName = t
              ? t.name || `×§×‘×•×¦×” ${game.currentRound.teamId}`
              : "";
            const explainerName = game.currentRound.explainerName || "";
            let text = `×¡×™×‘×•×‘ ×¤×¢×™×œ ×œ×§×‘×•×¦×”: ${teamName}`;
            if (explainerName) text += ` Â· ××¡×‘×™×¨: ${explainerName}`;
            roundStatusPlayerEl.textContent = text;
          } else {
            roundStatusPlayerEl.textContent = "××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
          }
        }
      }

      // ×”××–× ×” ×œ×¢×“×›×•× ×™ ××©×—×§ ××”×©×¨×ª
      socket.on("gameState", (game) => {
        if (!game || !currentGameCode) return;
        if (game.code && game.code !== currentGameCode) return;
        renderGame(game);
      });

      socket.on("gameUpdated", (game) => {
        if (!game || !currentGameCode) return;
        if (game.code && game.code !== currentGameCode) return;
        renderGame(game);
      });

      // ×›×©×”××©×—×§ × ×¡×’×¨ ×¢×œ ×™×“×™ ×”×× ×”×œ
      socket.on("gameEnded", () => {
        if (roundStatusPlayerEl) {
          roundStatusPlayerEl.textContent = "×”××©×—×§ × ×¡×’×¨.";
        }

        // ××™×¤×•×¡ ××¦×‘ ×›×“×™ ×©× ×™×ª×Ÿ ×™×”×™×” ×œ×”×¦×˜×¨×£ ×œ××©×—×§ ×—×“×©
        currentGameCode = null;
        lastGameState = null;
        myClientId = null;
        myTeamId = null;

        if (playerGameCard && joinSection) {
          playerGameCard.classList.add("hidden");
          joinSection.classList.remove("hidden");
        }
      });

      // ×˜×¢×™× ×ª ×œ×•×’×• ×•×‘×× ×¨ ×œ××¡×š ×©×—×§×Ÿ (×¢× ×× ×™×¢×ª ×ª××•× ×” ×©×‘×•×¨×”)
      (function loadBrandingForPlayer() {
        fetch("/api/banners")
          .then((res) => res.json())
          .then((data) => {
            if (!data) return;

            const logoCfg = data.logo;
            if (logoCfg && logoCfg.imageUrl && playerLogoEl) {
              playerLogoEl.src = logoCfg.imageUrl;
              playerLogoEl.alt = logoCfg.altText || "××™×œ×× ×™×”";
              playerLogoEl.classList.remove("hidden");
              playerLogoEl.addEventListener("error", () => {
                playerLogoEl.classList.add("hidden");
              });
            }

            if (!playerBannerSlot) return;
            const cfg = data.player;
            if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

            const a = document.createElement("a");
            a.href = cfg.linkUrl;
            a.target = "_blank";
            a.rel = "noopener";

            const img = document.createElement("img");
            img.src = cfg.imageUrl;
            img.alt = cfg.altText || "Banner";
            img.style.maxWidth = "100%";
            img.style.borderRadius = "18px";
            img.style.display = "block";
            img.style.marginTop = "8px";

            img.addEventListener("error", () => {
              a.style.display = "none";
            });

            a.appendChild(img);
            playerBannerSlot.appendChild(a);
          })
          .catch(() => {});
      })();
    </script>
  </body>
</html>
