<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - ××¡×š ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ×¤×•× ×˜ ×ª×•×× ×œ×× ×”×œ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root {
      font-size: 16px;
    }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #FFF8EA;
      color: #2B1E4A;
      min-height: 100vh;
      font-size: 1rem;
      position: relative;
    }
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 280px;
      height: 280px;
      border-radius: 50%;
      z-index: -1;
    }
    body::before {
      top: -130px;
      left: -70px;
      background: radial-gradient(circle at center,
        rgba(248, 71, 121, 0.30),
        transparent 60%);
    }
    body::after {
      bottom: -150px;
      right: -50px;
      background: radial-gradient(circle at center,
        rgba(21, 196, 193, 0.28),
        transparent 60%);
    }

    .app {
      max-width: 1024px;
      width: 100%;
      padding: 20px 14px 40px;
      margin: 0 auto;
    }

    .card {
      background: #FFFFFF;
      border-radius: 26px;
      padding: 18px 16px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(43, 30, 74, 0.06);
      margin-bottom: 16px;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.87rem;
      color: #6B618F;
    }

    input, select {
      width: 100%;
      padding: 9px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43, 30, 74, 0.22);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 0.98rem;
    }

    input::placeholder,
    select::placeholder {
      color: #B0A6CC;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #F84779;
      box-shadow: 0 0 0 1px rgba(248, 71, 121, 0.55);
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .btn {
      border-radius: 999px;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 0.98rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.07s ease, box-shadow 0.07s ease, background 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #F84779, #F6A21E);
      color: #FFFFFF;
      box-shadow: 0 10px 24px rgba(248, 71, 121, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(248, 71, 121, 0.45);
    }
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(248, 71, 121, 0.35);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(43, 30, 74, 0.18);
      color: #2B1E4A;
    }
    .btn-ghost:hover {
      background: #FFFFFF;
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .status-text {
      font-size: 0.9rem;
      color: #7C7598;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(180, 169, 214, 0.7);
      font-size: 0.8rem;
      color: #58457F;
      gap: 6px;
      background: radial-gradient(circle at top left,
        rgba(248, 71, 121, 0.18),
        rgba(255, 255, 255, 0.96));
      margin-bottom: 4px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .page-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .logo-small {
      height: 50px;
      width: auto;
      border-radius: 16px;
      object-fit: contain;
      background: #FFFFFF;
      padding: 4px 8px;
      border: 1px solid rgba(180, 169, 214, 0.65);
      box-shadow:
        0 0 0 3px #FFF8EA,
        0 10px 26px rgba(0,0,0,0.12);
    }

    .hidden {
      display: none !important;
    }

    /* ×¨×©×™××•×ª */
    .team-block-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .team-players-list {
      font-size: 0.9rem;
    }

    @media (max-width: 640px) {
      body {
        font-size: 1.05rem;
      }
      .app {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 18px 14px 20px;
        border-radius: 20px;
      }
      h1 {
        font-size: 1.6rem;
      }
      h3 {
        font-size: 1.05rem;
      }
      label {
        font-size: 0.9rem;
      }
      input, select {
        font-size: 1rem;
      }
      .btn {
        font-size: 1rem;
        padding: 10px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª -->
    <div class="card">
      <div class="page-header">
        <div class="page-header-main">
          <img id="player-logo" class="logo-small hidden" alt="××™×œ×× ×™×” ×œ×•×’×•" />
          <div>
            <div class="chip">××™×œ×× ×™×” Â· ××¡×š ×©×—×§×Ÿ ğŸ®</div>
            <h1 style="margin:4px 0 0; font-size:1.7rem;">×©×—×§×Ÿ</h1>
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" onclick="location.href='home.html'">â¬… ××¡×š ×”×‘×™×ª</button>
        </div>
      </div>
      <p class="status-text" style="margin-top:8px;">
        ××¦×˜×¨×¤×™× ×œ×—×“×¨ ×¢× ×§×•×“ ×”××©×—×§, ×‘×•×—×¨×™× ×©× ××¦×—×™×§, ×•× ×›× ×¡×™× ×œ×§×‘×•×¦×” ×©×”×•×’×“×¨×” ×œ×›× ×¢×œ ×™×“×™ ×× ×”×œ ×”××©×—×§ ğŸ˜„
      </p>
    </div>

    <!-- ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
    <div class="card" id="joinSection">
      <h3 style="margin:0 0 8px;">×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h3>

      <div id="inviteInfo" class="status-text" style="margin-bottom:8px; display:none;"></div>

      <div class="row">
        <div>
          <label for="gameCodeInput">×§×•×“ ××©×—×§</label>
          <input id="gameCodeInput" type="text" placeholder="×œ×“×•×’××”: AB12" />
        </div>
        <div>
          <label for="playerNameInput">×”×©× ×©×œ×™ ×‘××©×—×§</label>
          <input id="playerNameInput" type="text" placeholder="×‘×—×¨ ×©× ××¦×—×™×§ ğŸ˜œ" />
        </div>
      </div>

      <div class="row" id="teamChoiceRow">
        <div>
          <label for="teamSelect">×§×‘×•×¦×”</label>
          <select id="teamSelect">
            <option value="">×”×§×¦××” ××•×˜×•××˜×™×ª</option>
          </select>
        </div>
      </div>

      <button id="joinBtn" class="btn btn-primary" style="margin-top:6px;">
        ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§
      </button>

      <div id="joinStatus" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ××—×¨×™ ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
    <div class="card hidden" id="playerGameCard">
      <h3 style="margin:0 0 6px;">××¦×‘ ×”××©×—×§ ×©×œ×™</h3>
      <div id="myGameInfo" class="status-text" style="margin-bottom:8px;"></div>

      <div style="margin-bottom:8px;">
        <div class="team-block-title">×”×§×‘×•×¦×” ×©×œ×™</div>
        <div id="myTeamName" class="status-text"></div>
      </div>

      <div style="margin-bottom:8px;">
        <div class="team-block-title">×”×©×—×§× ×™× ×‘×§×‘×•×¦×” ×©×œ×™</div>
        <div id="myTeamPlayers" class="team-players-list status-text"></div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

      <h3 style="margin:0 0 6px;">× ×™×§×•×“ ×›×œ×œ×™</h3>
      <div id="scoreboard" class="status-text"></div>

      <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

      <h3 style="margin:0 0 6px;">××¦×‘ ×”×¡×™×‘×•×‘</h3>
      <div id="roundStatusPlayer" class="status-text"></div>

      <div id="player-banner-slot" style="margin-top:8px;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // ××¤×ª×— ×œ×©××™×¨×ª ×”×¦×˜×¨×¤×•×ª ×‘×“×¤×“×¤×Ÿ (×œ×× ×™×¢×ª ×›××” ×©××•×ª ×©×•× ×™× ×××•×ª×• ××›×©×™×¨ ×œ××•×ª×• ××©×—×§)
    const LOCAL_PLAYER_KEY = "millmania-player-join";

    // ××œ×× ×˜×™×
    const gameCodeInput = document.getElementById("gameCodeInput");
    const playerNameInput = document.getElementById("playerNameInput");
    const joinBtn = document.getElementById("joinBtn");
    const joinStatus = document.getElementById("joinStatus");
    const joinSection = document.getElementById("joinSection");
    const playerGameCard = document.getElementById("playerGameCard");

    const inviteInfo = document.getElementById("inviteInfo");
    const teamChoiceRow = document.getElementById("teamChoiceRow");
    const teamSelect = document.getElementById("teamSelect");

    const myGameInfo = document.getElementById("myGameInfo");
    const myTeamNameEl = document.getElementById("myTeamName");
    const myTeamPlayersEl = document.getElementById("myTeamPlayers");
    const scoreboardEl = document.getElementById("scoreboard");
    const roundStatusPlayerEl = document.getElementById("roundStatusPlayer");
    const playerLogoEl = document.getElementById("player-logo");
    const playerBannerSlot = document.getElementById("player-banner-slot");

    // ×¡×˜×™×™×˜
    let currentGameCode = null;
    let lastGameState = null;
    let myClientId = null;
    let myTeamId = null;

    // ×§×¨×™××ª ×¤×¨××˜×¨×™× ××”-URL (×”×–×× ×” ××•×•×¦××¤)
    const urlParams = new URLSearchParams(window.location.search);
    const invitedCode = (urlParams.get("code") || "").toUpperCase();
    const invitedTeamId = urlParams.get("teamId") || "";
    const invitedTeamName = urlParams.get("teamName") || "";

    if (invitedCode) {
      gameCodeInput.value = invitedCode;
    }

    if (invitedCode && invitedTeamId) {
      // ×™×© ×§×•×“ ×•×§×‘×•×¦×” - × ×¡×ª×™×¨ ×‘×—×™×¨×ª ×§×‘×•×¦×” ×™×“× ×™×ª
      teamChoiceRow.style.display = "none";
      inviteInfo.style.display = "block";
      const displayName = invitedTeamName || ("×§×‘×•×¦×” " + invitedTeamId);
      inviteInfo.textContent =
        `×”×•×–×× ×ª ×œ×”×¦×˜×¨×£ ×œ××©×—×§ ×‘×§×•×“ ${invitedCode}, ×œ×§×‘×•×¦×”: "${displayName}".`;
    }

    // ××™×œ×•×™ ×¨×©×™××ª ×§×‘×•×¦×•×ª ×¨×§ ×× × ×›× ×¡×™× ×‘×œ×™ ×§×‘×•×¦×” ××•×’×“×¨×ª ××”×œ×™× ×§
    function populateTeamSelectFromGame(game) {
      if (!teamSelect || !game || !game.teams) return;
      teamSelect.innerHTML = '<option value="">×”×§×¦××” ××•×˜×•××˜×™×ª</option>';
      Object.entries(game.teams).forEach(([teamId, team]) => {
        const opt = document.createElement("option");
        opt.value = teamId;
        opt.textContent = team.name || `×§×‘×•×¦×” ${teamId}`;
        teamSelect.appendChild(opt);
      });
    }

    // ×”×¨×¦×” ×—×“-×¤×¢××™×ª ×œ×˜×¢×™× ×ª ××¦×‘ ××©×—×§ ×œ×¤×™ ×§×•×“ ×× ×§×™×™× URL code
    if (invitedCode) {
      socket.emit("getGameState", { gameCode: invitedCode }, (resp) => {
        if (!resp || !resp.ok || !resp.game) return;
        lastGameState = resp.game;
        currentGameCode = invitedCode;
        if (!invitedTeamId) {
          // ×× ××™×Ÿ ×§×‘×•×¦×” ××”×œ×™× ×§ â€“ × ××œ× ××ª ×”×‘×—×™×¨×” ×”×™×“× ×™×ª
          populateTeamSelectFromGame(resp.game);
        }
      });
    }

    // ×˜×¢×™× ×ª ×‘×× ×¨×™×/×œ×•×’×• ×œ××¡×š ×©×—×§×Ÿ
    function loadPlayerBranding() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (data && data.logoUrl) {
            playerLogoEl.src = data.logoUrl;
            playerLogoEl.classList.remove("hidden");
          }
          if (data && data.playerBannerHtml) {
            playerBannerSlot.innerHTML = data.playerBannerHtml;
          }
        })
        .catch((err) => {
          console.error("Failed to load banners:", err);
        });
    }
    loadPlayerBranding();

    // ×¨×™× ×“×•×¨ ××¦×‘ ××©×—×§ ×œ×©×—×§×Ÿ
    function renderGameStateForPlayer(game) {
      lastGameState = game;

      if (!myClientId || !game) {
        myGameInfo.textContent = "×¢×“×™×™×Ÿ ×œ× ××—×•×‘×¨ ×œ××©×—×§.";
        myTeamNameEl.textContent = "";
        myTeamPlayersEl.textContent = "";
        scoreboardEl.textContent = "";
        roundStatusPlayerEl.textContent = "";
        return;
      }

      const playersMap = game.players || game.playersByClientId || {};
      const me = playersMap[myClientId];

      if (!me) {
        myGameInfo.textContent = "××ª×” ×œ× ××—×•×‘×¨ ×›×¨×’×¢ ×œ××©×—×§. ××•×œ×™ ×”×× ×”×œ ×¡×™×œ×§ ××•×ª×š ××• ×©×”×—×™×‘×•×¨ ××‘×“.";
        myTeamNameEl.textContent = "";
        myTeamPlayersEl.textContent = "";
        scoreboardEl.textContent = "";
        roundStatusPlayerEl.textContent = "";
        return;
      }

      currentGameCode = game.code || currentGameCode;
      myTeamId = me.teamId || myTeamId;

      const team = game.teams && myTeamId ? game.teams[myTeamId] : null;
      const teamName = team ? (team.name || `×§×‘×•×¦×” ${myTeamId}`) : "×œ×œ× ×§×‘×•×¦×”";

      myGameInfo.innerHTML =
        `××ª×” ××—×•×‘×¨ ×œ×—×“×¨ ×‘×§×•×“ <strong>${currentGameCode || "-"}</strong> ×‘×©× <strong>${me.name || ""}</strong>.`;

      myTeamNameEl.textContent = teamName;

      if (team && team.players && team.players.length) {
        const names = team.players
          .map((cid) => (playersMap[cid] && playersMap[cid].name) ? playersMap[cid].name : null)
          .filter(Boolean);
        myTeamPlayersEl.textContent = names.length
          ? names.join(", ")
          : "××™×Ÿ ×¢×“×™×™×Ÿ ×©×—×§× ×™× × ×•×¡×¤×™× ×‘×§×‘×•×¦×” ×©×œ×š.";
      } else {
        myTeamPlayersEl.textContent = "×¢×“×™×™×Ÿ ×œ× ×”×•×§×¦×• ×©×—×§× ×™× ×œ×§×‘×•×¦×” ×©×œ×š.";
      }

      // × ×™×§×•×“ ×›×œ×œ×™
      if (game.teams) {
        const lines = Object.entries(game.teams).map(([teamId, t]) => {
          const name = t.name || `×§×‘×•×¦×” ${teamId}`;
          const score = t.score || 0;
          return `${name}: ${score} × ×§×•×“×•×ª`;
        });
        scoreboardEl.innerHTML = lines.join("<br/>");
      } else {
        scoreboardEl.textContent = "";
      }

      // ××¦×‘ ×¡×™×‘×•×‘
      if (game.round && game.round.isActive) {
        const roundSecondsLeft = typeof game.round.secondsLeft === "number"
          ? game.round.secondsLeft
          : null;
        const explainerName = game.round.explainerName || "";
        const explainerTeamName = game.round.teamName || "";
        const explainerTeamId = game.round.teamId || "";

        const explainerTeamText = explainerTeamName
          || (explainerTeamId ? `×§×‘×•×¦×” ${explainerTeamId}` : "");

        let msg = "×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
        if (explainerName && explainerTeamText) {
          msg = `×¢×›×©×™×• ××¡×‘×™×¨/×”: <strong>${explainerName}</strong> (${explainerTeamText}).`;
        } else if (explainerName) {
          msg = `×¢×›×©×™×• ××¡×‘×™×¨/×”: <strong>${explainerName}</strong>.`;
        }

        if (roundSecondsLeft !== null) {
          msg += ` Â· × ×©××¨×• ×›Ö¾${roundSecondsLeft} ×©× ×™×•×ª.`;
        }

        if (myTeamId && explainerTeamId && myTeamId === explainerTeamId) {
          msg += " ×–×” ×”×¡×™×‘×•×‘ ×©×œ ×”×§×‘×•×¦×” ×©×œ×š â€“ ×ª× ×• ×œ×•/×œ×” ×¤×•×§×•×¡! ğŸ¯";
        }

        roundStatusPlayerEl.innerHTML = msg;
      } else {
        roundStatusPlayerEl.textContent =
          "×›×¨×’×¢ ××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ. ×—×›×• ×©×× ×”×œ ×”××©×—×§ ×™×ª×—×™×œ ×¡×™×‘×•×‘ ×—×“×©.";
      }
    }

    // ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ (×¢× ×—×¡×™××” ×œ×©××•×ª ×©×•× ×™× ×××•×ª×• ××›×©×™×¨ ×œ××•×ª×• ×§×•×“)
    joinBtn.addEventListener("click", () => {
      const rawCode = gameCodeInput.value.trim().toUpperCase();
      const playerName = playerNameInput.value.trim();

      if (!rawCode || rawCode.length < 3) {
        joinStatus.textContent = "× × ×œ×”×§×œ×™×“ ×§×•×“ ××©×—×§ ×ª×§×™×Ÿ.";
        return;
      }
      if (!playerName || playerName.length < 2) {
        joinStatus.textContent = "× × ×œ×‘×—×•×¨ ×©× ×œ×©×—×§×Ÿ (×œ×¤×—×•×ª 2 ×ª×•×•×™×).";
        return;
      }

      const gameCode = rawCode;

      // ×‘×“×™×§×” ×‘-localStorage â€“ ×”×× ×›×‘×¨ ×”×¦×˜×¨×¤× ×• ×œ××©×—×§ ×”×–×” ××“×¤×“×¤×Ÿ ×–×”?
      let existingJoin = null;
      try {
        const raw = localStorage.getItem(LOCAL_PLAYER_KEY);
        existingJoin = raw ? JSON.parse(raw) : null;
      } catch (e) {
        existingJoin = null;
      }

      if (
        existingJoin &&
        existingJoin.gameCode === gameCode &&
        existingJoin.name &&
        existingJoin.name !== playerName
      ) {
        joinStatus.textContent =
          `×‘×“×¤×“×¤×Ÿ ×”×–×” ×›×‘×¨ ×”×¦×˜×¨×¤×ª ×œ××©×—×§ ${gameCode} ×‘×©× "${existingJoin.name}". ` +
          "××™ ××¤×©×¨ ×œ×”×¦×˜×¨×£ ×©×•×‘ ×œ××•×ª×• ××©×—×§ ×¢× ×©× ××—×¨ ×××•×ª×• ××›×©×™×¨.";
        return;
      }

      const payload = {
        gameCode,
        name: playerName,
        teamId: invitedTeamId || teamSelect.value || null,
      };

      joinStatus.textContent = "××¦×˜×¨×£ ×œ××©×—×§...";
      joinBtn.disabled = true;

      socket.emit("joinGame", payload, (resp) => {
        joinBtn.disabled = false;

        if (!resp || !resp.ok) {
          joinStatus.textContent =
            (resp && resp.error) ||
            "×œ× ×”×¦×œ×—× ×• ×œ×¦×¨×£ ××•×ª×š ×œ××©×—×§. ×‘×“×•×§ ××ª ×”×§×•×“ ×•× ×¡×” ×©×•×‘.";
          return;
        }

        // ×©××™×¨×ª ×”×”×¦×˜×¨×¤×•×ª ×‘-localStorage (×œ×× ×™×¢×ª ×©××•×ª ××¨×•×‘×™× ×œ××•×ª×• ××©×—×§)
        try {
          localStorage.setItem(
            LOCAL_PLAYER_KEY,
            JSON.stringify({
              gameCode,
              name: playerName,
              joinedAt: Date.now(),
            })
          );
        } catch (e) {
          // ×× localStorage ×œ× ×–××™×Ÿ â€“ ××ª×¢×œ××™× ×‘×©×§×˜
        }

        joinStatus.textContent = "×”×¦×˜×¨×¤×ª ×‘×”×¦×œ×—×” ×œ××©×—×§!";
        myClientId = resp.clientId;
        currentGameCode = gameCode;
        myTeamId = resp.teamId || null;

        joinSection.classList.add("hidden");
        playerGameCard.classList.remove("hidden");

        if (resp.game) {
          renderGameStateForPlayer(resp.game);
        } else {
          socket.emit("getGameState", { gameCode }, (resp2) => {
            if (resp2 && resp2.ok && resp2.game) {
              renderGameStateForPlayer(resp2.game);
            }
          });
        }
      });
    });

    // ×”××–× ×” ×œ×¢×“×›×•× ×™ ××©×—×§ ××”×©×¨×ª
    socket.on("gameUpdated", (game) => {
      if (!game || (currentGameCode && game.code && game.code !== currentGameCode)) {
        return;
      }
      renderGameStateForPlayer(game);
    });

    socket.on("gameEnded", (data) => {
      if (data && data.code && currentGameCode && data.code !== currentGameCode) return;

      roundStatusPlayerEl.textContent = "×”××©×—×§ ×”×¡×ª×™×™×. ×ª×•×“×” ×©×©×™×—×§×ª×! ğŸ‰";
    });
  </script>
</body>
</html>
